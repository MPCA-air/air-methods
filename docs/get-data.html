<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title> Get data | air-methods.utf8</title>
  <meta name="description" content="" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content=" Get data | air-methods.utf8" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://github.com/MPCA-air/air-methods" />
  <meta property="og:image" content="https://github.com/MPCA-air/air-methodsimages/cover.jpeg" />
  
  <meta name="github-repo" content="MPCA-air/air-methods" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content=" Get data | air-methods.utf8" />
  
  
  <meta name="twitter:image" content="https://github.com/MPCA-air/air-methodsimages/cover.jpeg" />




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="best-practices.html"/>
<link rel="next" href="quality-assurance-methods.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://mpca-air.github.io/air-methods">Methods for air data analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="best-practices.html"><a href="best-practices.html"><i class="fa fa-check"></i><b>1</b> Best practices</a>
<ul>
<li class="chapter" data-level="1.1" data-path="best-practices.html"><a href="best-practices.html#welcome-to-the-tidyverse"><i class="fa fa-check"></i><b>1.1</b> Welcome to the Tidyverse</a></li>
<li class="chapter" data-level="1.2" data-path="best-practices.html"><a href="best-practices.html#keep-r-updated"><i class="fa fa-check"></i><b>1.2</b> Keep R updated</a></li>
<li class="chapter" data-level="1.3" data-path="best-practices.html"><a href="best-practices.html#script-organization"><i class="fa fa-check"></i><b>1.3</b> Script organization</a></li>
<li class="chapter" data-level="1.4" data-path="best-practices.html"><a href="best-practices.html#divide-and-conquer"><i class="fa fa-check"></i><b>1.4</b> Divide and conquer</a></li>
<li class="chapter" data-level="1.5" data-path="best-practices.html"><a href="best-practices.html#codebooks-metadata-and-data-dictionaries"><i class="fa fa-check"></i><b>1.5</b> Codebooks, metadata, and data dictionaries</a></li>
<li class="chapter" data-level="1.6" data-path="best-practices.html"><a href="best-practices.html#data-formatting"><i class="fa fa-check"></i><b>1.6</b> Data formatting</a></li>
<li class="chapter" data-level="1.7" data-path="best-practices.html"><a href="best-practices.html#pollutant-names"><i class="fa fa-check"></i><b>1.7</b> Pollutant names</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="get-data.html"><a href="get-data.html"><i class="fa fa-check"></i><b>2</b> Get data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="get-data.html"><a href="get-data.html#air-monitoring"><i class="fa fa-check"></i><b>2.1</b> Air monitoring</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="get-data.html"><a href="get-data.html#AQS"><i class="fa fa-check"></i><b>2.1.1</b> Retrieving data from AQS</a></li>
<li class="chapter" data-level="2.1.2" data-path="get-data.html"><a href="get-data.html#aqsAPI"><i class="fa fa-check"></i><b>2.1.2</b> Retrieving data from AQS API</a></li>
<li class="chapter" data-level="2.1.3" data-path="get-data.html"><a href="get-data.html#wair"><i class="fa fa-check"></i><b>2.1.3</b> Retrieving data from MPCA WAIR database</a></li>
<li class="chapter" data-level="2.1.4" data-path="get-data.html"><a href="get-data.html#aqi-now"><i class="fa fa-check"></i><b>2.1.4</b> Current AQI observations</a></li>
<li class="chapter" data-level="2.1.5" data-path="get-data.html"><a href="get-data.html#lims"><i class="fa fa-check"></i><b>2.1.5</b> Retrieving data from LIMS via Tableau</a></li>
<li class="chapter" data-level="2.1.6" data-path="get-data.html"><a href="get-data.html#AirVision"><i class="fa fa-check"></i><b>2.1.6</b> Retrieving continuous data from AirVision</a></li>
<li class="chapter" data-level="2.1.7" data-path="get-data.html"><a href="get-data.html#monitors"><i class="fa fa-check"></i><b>2.1.7</b> AirNow:Active AQI monitors</a></li>
<li class="chapter" data-level="2.1.8" data-path="get-data.html"><a href="get-data.html#EPAsites"><i class="fa fa-check"></i><b>2.1.8</b> EPA Google Earth Site Maps</a></li>
<li class="chapter" data-level="2.1.9" data-path="get-data.html"><a href="get-data.html#wairsites"><i class="fa fa-check"></i><b>2.1.9</b> WAIR Site information table</a></li>
<li class="chapter" data-level="2.1.10" data-path="get-data.html"><a href="get-data.html#toxics"><i class="fa fa-check"></i><b>2.1.10</b> Air toxics Data Explorer</a></li>
<li class="chapter" data-level="2.1.11" data-path="get-data.html"><a href="get-data.html#criteria"><i class="fa fa-check"></i><b>2.1.11</b> Criteria Pollutant Data Explorer</a></li>
<li class="chapter" data-level="2.1.12" data-path="get-data.html"><a href="get-data.html#AQI"><i class="fa fa-check"></i><b>2.1.12</b> Air Quality Index Summary Reports</a></li>
<li class="chapter" data-level="2.1.13" data-path="get-data.html"><a href="get-data.html#PAHs"><i class="fa fa-check"></i><b>2.1.13</b> Air Monitoring for PAHs</a></li>
<li class="chapter" data-level="2.1.14" data-path="get-data.html"><a href="get-data.html#tableau"><i class="fa fa-check"></i><b>2.1.14</b> Internal Data Explorers</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="get-data.html"><a href="get-data.html#health-and-standards"><i class="fa fa-check"></i><b>2.2</b> Health and standards</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="get-data.html"><a href="get-data.html#IHBs"><i class="fa fa-check"></i><b>2.2.1</b> Inhalation health benchmarks (IHBs)</a></li>
<li class="chapter" data-level="2.2.2" data-path="get-data.html"><a href="get-data.html#NAAQS"><i class="fa fa-check"></i><b>2.2.2</b> Air Quality Standards (NAAQS and MAAQS)</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="get-data.html"><a href="get-data.html#air-modeling"><i class="fa fa-check"></i><b>2.3</b> Air modeling</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="get-data.html"><a href="get-data.html#nata"><i class="fa fa-check"></i><b>2.3.1</b> NATA modeling</a></li>
<li class="chapter" data-level="2.3.2" data-path="get-data.html"><a href="get-data.html#mnrisks"><i class="fa fa-check"></i><b>2.3.2</b> MNRISKS statewide risk modeling</a></li>
<li class="chapter" data-level="2.3.3" data-path="get-data.html"><a href="get-data.html#downscale"><i class="fa fa-check"></i><b>2.3.3</b> Downscaler modeling results for Ozone and PM2.5</a></li>
<li class="chapter" data-level="2.3.4" data-path="get-data.html"><a href="get-data.html#cmaq"><i class="fa fa-check"></i><b>2.3.4</b> CMAQ Ozone modeling</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="get-data.html"><a href="get-data.html#context"><i class="fa fa-check"></i><b>2.4</b> Context</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="get-data.html"><a href="get-data.html#mn-ei"><i class="fa fa-check"></i><b>2.4.1</b> MN Emissions Inventory</a></li>
<li class="chapter" data-level="2.4.2" data-path="get-data.html"><a href="get-data.html#nei"><i class="fa fa-check"></i><b>2.4.2</b> EPA’s NEI</a></li>
<li class="chapter" data-level="2.4.3" data-path="get-data.html"><a href="get-data.html#fac-coords"><i class="fa fa-check"></i><b>2.4.3</b> Facility locations</a></li>
<li class="chapter" data-level="2.4.4" data-path="get-data.html"><a href="get-data.html#wx-obs"><i class="fa fa-check"></i><b>2.4.4</b> Weather observations</a></li>
<li class="chapter" data-level="2.4.5" data-path="get-data.html"><a href="get-data.html#hysplit"><i class="fa fa-check"></i><b>2.4.5</b> HYSPLIT wind trajectories</a></li>
<li class="chapter" data-level="2.4.6" data-path="get-data.html"><a href="get-data.html#landuse"><i class="fa fa-check"></i><b>2.4.6</b> Land use maps</a></li>
<li class="chapter" data-level="2.4.7" data-path="get-data.html"><a href="get-data.html#census"><i class="fa fa-check"></i><b>2.4.7</b> United States Census boundaries</a></li>
<li class="chapter" data-level="2.4.8" data-path="get-data.html"><a href="get-data.html#acs"><i class="fa fa-check"></i><b>2.4.8</b> American Community Survey (ACS)</a></li>
</ul></li>
</ul></li>
<li><a href="quality-assurance-methods.html#quality-assurance-methods"><strong>Quality assurance methods</strong></a></li>
<li class="chapter" data-level="3" data-path="data-cleaning.html"><a href="data-cleaning.html"><i class="fa fa-check"></i><b>3</b> Data cleaning</a>
<ul>
<li class="chapter" data-level="3.1" data-path="data-cleaning.html"><a href="data-cleaning.html#missing"><i class="fa fa-check"></i><b>3.1</b> Blank, NULL, and missing values</a></li>
<li class="chapter" data-level="3.2" data-path="data-cleaning.html"><a href="data-cleaning.html#quals"><i class="fa fa-check"></i><b>3.2</b> Qualified data</a></li>
<li class="chapter" data-level="3.3" data-path="data-cleaning.html"><a href="data-cleaning.html#dups"><i class="fa fa-check"></i><b>3.3</b> Duplicate observations</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-validation.html"><a href="data-validation.html"><i class="fa fa-check"></i><b>4</b> Data validation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="data-validation.html"><a href="data-validation.html#leaks"><i class="fa fa-check"></i><b>4.1</b> Instrument drift or leaks in a system.</a></li>
<li class="chapter" data-level="4.2" data-path="data-validation.html"><a href="data-validation.html#outs"><i class="fa fa-check"></i><b>4.2</b> Extreme values and outliers</a></li>
<li class="chapter" data-level="4.3" data-path="data-validation.html"><a href="data-validation.html#sticky2"><i class="fa fa-check"></i><b>4.3</b> Sequential repeats and “sticky” numbers</a></li>
<li class="chapter" data-level="4.4" data-path="data-validation.html"><a href="data-validation.html#unique"><i class="fa fa-check"></i><b>4.4</b> Unique detected values</a></li>
<li class="chapter" data-level="4.5" data-path="data-validation.html"><a href="data-validation.html#valid_ref"><i class="fa fa-check"></i><b>4.5</b> References</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="collocated-monitors.html"><a href="collocated-monitors.html"><i class="fa fa-check"></i><b>5</b> Collocated monitors</a>
<ul>
<li class="chapter" data-level="5.1" data-path="collocated-monitors.html"><a href="collocated-monitors.html#evalpocs"><i class="fa fa-check"></i><b>5.1</b> Evaluate collocated air monitors</a></li>
<li class="chapter" data-level="5.2" data-path="collocated-monitors.html"><a href="collocated-monitors.html#pripocs"><i class="fa fa-check"></i><b>5.2</b> Prioritize multiple air monitors (POCs)</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="detection-limits.html"><a href="detection-limits.html"><i class="fa fa-check"></i><b>6</b> Detection limits</a>
<ul>
<li class="chapter" data-level="6.1" data-path="detection-limits.html"><a href="detection-limits.html#method-detection-limit"><i class="fa fa-check"></i><b>6.1</b> Method Detection Limit</a></li>
<li class="chapter" data-level="6.2" data-path="detection-limits.html"><a href="detection-limits.html#calculating-mdls"><i class="fa fa-check"></i><b>6.2</b> Calculating MDLs</a></li>
<li class="chapter" data-level="6.3" data-path="detection-limits.html"><a href="detection-limits.html#finding-mpca-detection-limits"><i class="fa fa-check"></i><b>6.3</b> Finding MPCA detection limits</a></li>
<li class="chapter" data-level="6.4" data-path="detection-limits.html"><a href="detection-limits.html#qualifier-codes-for-detection-limits"><i class="fa fa-check"></i><b>6.4</b> Qualifier Codes for Detection Limits</a></li>
<li class="chapter" data-level="6.5" data-path="detection-limits.html"><a href="detection-limits.html#estimating-below-detection-values"><i class="fa fa-check"></i><b>6.5</b> Estimating below detection values</a></li>
<li class="chapter" data-level="6.6" data-path="detection-limits.html"><a href="detection-limits.html#recommended-steps"><i class="fa fa-check"></i><b>6.6</b> Recommended Steps</a></li>
<li class="chapter" data-level="6.7" data-path="detection-limits.html"><a href="detection-limits.html#multiple-detection-limits"><i class="fa fa-check"></i><b>6.7</b> Multiple detection limits</a></li>
<li class="chapter" data-level="6.8" data-path="detection-limits.html"><a href="detection-limits.html#reporting-limits"><i class="fa fa-check"></i><b>6.8</b> Reporting limits</a></li>
<li class="chapter" data-level="6.9" data-path="detection-limits.html"><a href="detection-limits.html#references"><i class="fa fa-check"></i><b>6.9</b> References</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="completeness-checks.html"><a href="completeness-checks.html"><i class="fa fa-check"></i><b>7</b> Completeness checks</a>
<ul>
<li class="chapter" data-level="7.1" data-path="completeness-checks.html"><a href="completeness-checks.html#complete"><i class="fa fa-check"></i><b>7.1</b> Completeness checks</a></li>
</ul></li>
<li><a href="summary-methods.html#summary-methods"><strong>Summary methods</strong></a></li>
<li class="chapter" data-level="8" data-path="summary-statistics.html"><a href="summary-statistics.html"><i class="fa fa-check"></i><b>8</b> Summary statistics</a>
<ul>
<li class="chapter" data-level="8.1" data-path="summary-statistics.html"><a href="summary-statistics.html#normal"><i class="fa fa-check"></i><b>8.1</b> Test for normality</a></li>
<li class="chapter" data-level="8.2" data-path="summary-statistics.html"><a href="summary-statistics.html#boots"><i class="fa fa-check"></i><b>8.2</b> Bootstrapping</a></li>
<li class="chapter" data-level="8.3" data-path="summary-statistics.html"><a href="summary-statistics.html#below"><i class="fa fa-check"></i><b>8.3</b> Below the detection limit</a></li>
<li class="chapter" data-level="8.4" data-path="summary-statistics.html"><a href="summary-statistics.html#confidence"><i class="fa fa-check"></i><b>8.4</b> Upper confidence limits (UCLs)</a></li>
<li class="chapter" data-level="8.5" data-path="summary-statistics.html"><a href="summary-statistics.html#incomplete"><i class="fa fa-check"></i><b>8.5</b> Annual summaries for incomplete data</a></li>
<li class="chapter" data-level="8.6" data-path="summary-statistics.html"><a href="summary-statistics.html#health"><i class="fa fa-check"></i><b>8.6</b> Comparison of data to inhalation health benchmarks</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="site-comparisons.html"><a href="site-comparisons.html"><i class="fa fa-check"></i><b>9</b> Site comparisons</a>
<ul>
<li class="chapter" data-level="9.1" data-path="site-comparisons.html"><a href="site-comparisons.html#confidence-intervals"><i class="fa fa-check"></i><b>9.1</b> Confidence intervals</a></li>
<li class="chapter" data-level="9.2" data-path="site-comparisons.html"><a href="site-comparisons.html#tools-to-visualize-differences"><i class="fa fa-check"></i><b>9.2</b> Tools to visualize differences</a>
<ul>
<li class="chapter" data-level="" data-path="site-comparisons.html"><a href="site-comparisons.html#beeswarm-plots"><i class="fa fa-check"></i>Beeswarm Plots</a></li>
<li class="chapter" data-level="" data-path="site-comparisons.html"><a href="site-comparisons.html#correlation-matrices"><i class="fa fa-check"></i>Correlation matrices</a></li>
</ul></li>
<li><a href="site-comparisons.html#references-1"><em>References</em></a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="start-finish.html"><a href="start-finish.html"><i class="fa fa-check"></i><b>10</b> From start to finish</a>
<ul>
<li class="chapter" data-level="10.1" data-path="start-finish.html"><a href="start-finish.html#using-functions"><i class="fa fa-check"></i><b>10.1</b> Using functions</a></li>
<li class="chapter" data-level="10.2" data-path="start-finish.html"><a href="start-finish.html#a-simpler-analysis"><i class="fa fa-check"></i><b>10.2</b> A simpler analysis</a></li>
</ul></li>
<li><a href="visuals.html#visuals"><strong>Visuals</strong></a></li>
<li class="chapter" data-level="11" data-path="charts.html"><a href="charts.html"><i class="fa fa-check"></i><b>11</b> Charts</a>
<ul>
<li class="chapter" data-level="11.1" data-path="charts.html"><a href="charts.html#calendar-plots"><i class="fa fa-check"></i><b>11.1</b> Calendar plots</a></li>
<li class="chapter" data-level="11.2" data-path="charts.html"><a href="charts.html#colors-and-themes"><i class="fa fa-check"></i><b>11.2</b> Colors and themes</a></li>
<li class="chapter" data-level="11.3" data-path="charts.html"><a href="charts.html#pollution-roses"><i class="fa fa-check"></i><b>11.3</b> Pollution roses</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="time-series.html"><a href="time-series.html"><i class="fa fa-check"></i><b>12</b> Time series</a>
<ul>
<li class="chapter" data-level="" data-path="time-series.html"><a href="time-series.html#hour-of-the-day"><i class="fa fa-check"></i>Hour of the day</a></li>
<li class="chapter" data-level="" data-path="time-series.html"><a href="time-series.html#day-of-the-week"><i class="fa fa-check"></i>Day of the week</a></li>
<li class="chapter" data-level="" data-path="time-series.html"><a href="time-series.html#seasonality"><i class="fa fa-check"></i>Seasonality</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="maps.html"><a href="maps.html"><i class="fa fa-check"></i><b>13</b> Maps</a>
<ul>
<li class="chapter" data-level="" data-path="maps.html"><a href="maps.html#interactive-map-of-air-monitors"><i class="fa fa-check"></i>Interactive map of air monitors</a></li>
<li class="chapter" data-level="" data-path="maps.html"><a href="maps.html#creating-shapefiles-in-r"><i class="fa fa-check"></i>Creating shapefiles in R</a></li>
</ul></li>
<li><a href="mpca-data-tools.html#mpca-data-tools"><strong>MPCA data tools</strong></a></li>
<li class="chapter" data-level="14" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html"><i class="fa fa-check"></i><b>14</b> Air toxics explorer</a>
<ul>
<li class="chapter" data-level="14.1" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#data-cleaning-1"><i class="fa fa-check"></i><b>14.1</b> Data Cleaning</a>
<ul>
<li class="chapter" data-level="" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#null-results"><i class="fa fa-check"></i>Null Results</a></li>
<li class="chapter" data-level="" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#duplicate-observations"><i class="fa fa-check"></i>Duplicate Observations</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#data-validation-1"><i class="fa fa-check"></i><b>14.2</b> Data Validation</a>
<ul>
<li class="chapter" data-level="" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#parameter-occurrence-codes-pocs"><i class="fa fa-check"></i>Parameter Occurrence Codes (POCs)</a></li>
<li class="chapter" data-level="" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#data-completeness"><i class="fa fa-check"></i>Data Completeness</a></li>
<li class="chapter" data-level="" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#below-the-detection-limit"><i class="fa fa-check"></i>Below the detection limit</a></li>
</ul></li>
<li class="chapter" data-level="14.3" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#producing-annual-summaries"><i class="fa fa-check"></i><b>14.3</b> Producing Annual Summaries</a>
<ul>
<li class="chapter" data-level="" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#calculating-annual-means"><i class="fa fa-check"></i>Calculating annual means</a></li>
<li class="chapter" data-level="" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#calculating-upper-confidence-limits"><i class="fa fa-check"></i>Calculating upper confidence limits</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#comparing-sites"><i class="fa fa-check"></i><b>14.4</b> Comparing sites</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="criteria-pollutant-explorer.html"><a href="criteria-pollutant-explorer.html"><i class="fa fa-check"></i><b>15</b> Criteria pollutant explorer</a></li>
<li class="chapter" data-level="16" data-path="aqi-explorer.html"><a href="aqi-explorer.html"><i class="fa fa-check"></i><b>16</b> AQI explorer</a></li>
<li class="chapter" data-level="" data-path="edit-this-book.html"><a href="edit-this-book.html"><i class="fa fa-check"></i>Edit this book</a>
<ul>
<li><a href="edit-this-book.html#references-2"><em>References</em></a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/MPCA-air" target="blank">Created by MPCA-air</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="get-data" class="section level1" number="2">
<h1><span class="header-section-number"></span> Get data</h1>
<p><br></p>
<p><img src="images/cover1.jpg" align="right" style="margin-top: -4px; margin-left: 20px; width: 36%;" /></p>
<p>This section describes how to download air monitoring and modeling data.</p>
<p><strong>Air monitoring data</strong></p>
<ul>
<li>Final data <br>
<ul>
<li><a href="get-data.html#AQS">2.1.1</a> EPA AQS Database</li>
<li><a href="get-data.html#aqsAPI">2.1.2</a> EPA AQS API</li>
<li><a href="get-data.html#wair">2.1.3</a> MPCA WAIR Database</li>
</ul></li>
<li>Preliminary data
<ul>
<li><a href="get-data.html#aqi-now">2.1.4</a> AirNow: Current AQI observations</li>
<li><a href="get-data.html#lims">2.1.5</a> MPCA LIMS data via Tableau</li>
<li><a href="get-data.html#AirVision">2.1.6</a> AirVision: Continuous data</li>
</ul></li>
<li>Air Monitoring Site Information
<ul>
<li><a href="get-data.html#monitors">2.1.7</a> AirNow: Active AQI monitors</li>
<li><a href="get-data.html#EPAsites">2.1.8</a> EPA Google Earth Site Explorer</li>
<li><a href="get-data.html#wairsites">2.1.9</a> WAIR Site Table</li>
</ul></li>
</ul>
<p><strong>Summarized air monitoring results</strong></p>
<ul>
<li>External Data Explorers
<ul>
<li><a href="get-data.html#toxics">2.1.10</a> Air Toxics Data Explorer</li>
<li><a href="get-data.html#criteria">2.1.11</a> Criteria Pollutant Data Explorer</li>
<li><a href="get-data.html#AQI">2.1.12</a> Air Quality Index Summary Reports</li>
<li><a href="get-data.html#PAHs">2.1.13</a> Air Monitoring for PAHs</li>
</ul></li>
<li>Internal Data Explorers
<ul>
<li><a href="get-data.html#tableau">2.1.14</a> MPCA Tableau Server</li>
</ul></li>
</ul>
<p><strong>Health benchmarks and air quality standards</strong></p>
<ul>
<li>Air toxics
<ul>
<li><a href="get-data.html#IHBs">2.2.1</a> Inhalation health benchmarks</li>
</ul></li>
<li>Criteria pollutants
<ul>
<li><a href="get-data.html#NAAQS">2.2.2</a> Air Quality Standards (NAAQs and MAAQS)</li>
</ul></li>
</ul>
<p><strong>Air modeling</strong></p>
<ul>
<li>Modeling results
<ul>
<li><a href="get-data.html#nata">2.3.1</a> NATA</li>
<li><a href="get-data.html#mnrisks">2.3.2</a> MNRISKS</li>
<li><a href="get-data.html#downscale">2.3.3</a> Downscaler for Ozone and PM2.5</li>
<li><a href="get-data.html#cmaq">2.3.4</a> CMAQ</li>
</ul></li>
</ul>
<p><strong>Context</strong></p>
<ul>
<li>Emissions
<ul>
<li><a href="get-data.html#mn-ei">2.4.1</a> MN Emissions Inventory</li>
<li><a href="get-data.html#nei">2.4.2</a> EPA’s NEI</li>
<li><a href="get-data.html#fac-coords">2.4.3</a> Facility locations</li>
</ul></li>
<li>Meteorology and Climate
<ul>
<li><a href="get-data.html#wx-obs">2.4.4</a> Weather observations</li>
<li><a href="get-data.html#hysplit">2.4.5</a> HYSPLIT wind trajectories</li>
</ul></li>
<li>Geography and Census data
<ul>
<li><a href="get-data.html#landuse">2.4.6</a> Land use maps</li>
<li><a href="get-data.html#census">2.4.7</a> U.S. Census boundaries</li>
<li><a href="get-data.html#acs">2.4.8</a> Demographics from American Community Survey (ACS)</li>
</ul></li>
</ul>
<p><br></p>
<div id="air-monitoring" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Air monitoring</h2>
<div id="AQS" class="section level3" number="2.1.1">
<h3><span class="header-section-number">2.1.1</span> Retrieving data from AQS</h3>
<p>The Air Quality System (AQS) contains ambient air pollution data collected by EPA, state, local, and tribal air pollution control agencies from over thousands of monitors. AQS also contains meteorological data, descriptive information about each monitoring station (including its geographic location and its operator), and data quality assurance/quality control information.</p>
<p>Registered users can access the AQS database via a web application at <a href="https://www.epa.gov/aqs" class="uri">https://www.epa.gov/aqs</a>. Raw data extracts can be run using the AMP501 report. The AMP501 provides data in the pipe delimited RD transaction format.</p>
</div>
<div id="aqsAPI" class="section level3" number="2.1.2">
<h3><span class="header-section-number">2.1.2</span> Retrieving data from AQS API</h3>
<p>The AQS API provides access to air quality data stored in the EPA’s AQS database and is open to the public. <a href="https://aqs.epa.gov/aqsweb/documents/data_api.html">AQS API</a></p>
<p>Note: The AQS API requires a user name and password. The username and password is not the same as your AQS User Account. To request an API account, follow the instructions on the documentation page.</p>
<p><br> <strong>Sample <code>R</code> script</strong></p>
<p>Click the button below for code for a shiny app to access the AQS API.</p>
<div class="toggle">
<button class="btn_code">
Show <strong>R</strong> code
</button>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="get-data.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb1-2"><a href="get-data.html#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb1-3"><a href="get-data.html#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-4"><a href="get-data.html#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-5"><a href="get-data.html#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-6"><a href="get-data.html#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-7"><a href="get-data.html#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-8"><a href="get-data.html#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb1-9"><a href="get-data.html#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb1-10"><a href="get-data.html#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shinyWidgets)</span>
<span id="cb1-11"><a href="get-data.html#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shinyjs)</span>
<span id="cb1-12"><a href="get-data.html#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shinycssloaders)</span>
<span id="cb1-13"><a href="get-data.html#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shinyBS)</span>
<span id="cb1-14"><a href="get-data.html#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly)</span>
<span id="cb1-15"><a href="get-data.html#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DT)</span>
<span id="cb1-16"><a href="get-data.html#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-17"><a href="get-data.html#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sp)</span>
<span id="cb1-18"><a href="get-data.html#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sampSurf)</span>
<span id="cb1-19"><a href="get-data.html#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(swfscMisc)</span>
<span id="cb1-20"><a href="get-data.html#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb1-21"><a href="get-data.html#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet.extras)</span>
<span id="cb1-22"><a href="get-data.html#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tigris)</span>
<span id="cb1-23"><a href="get-data.html#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(htmltools)</span>
<span id="cb1-24"><a href="get-data.html#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="get-data.html#cb1-25" aria-hidden="true" tabindex="-1"></a>service_opts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;sampleData&quot;</span>, <span class="st">&quot;dailyData&quot;</span>, <span class="st">&quot;annualData&quot;</span>, <span class="st">&quot;qaBlanks&quot;</span>,</span>
<span id="cb1-26"><a href="get-data.html#cb1-26" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;qaCollocatedAssessments&quot;</span>, <span class="st">&quot;qaFlowRateVerifications&quot;</span>, <span class="st">&quot;qaFlowRateAudits&quot;</span>, <span class="st">&quot;qaOnePointQcRawData&quot;</span>, <span class="st">&quot;qaPepAudits&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-27"><a href="get-data.html#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;Sample data&quot;</span>, <span class="st">&quot;Daily data&quot;</span>, <span class="st">&quot;Annual data&quot;</span>, <span class="st">&quot;QA Blanks&quot;</span>, <span class="st">&quot;QA Collocated Assessments&quot;</span>, <span class="st">&quot;QA Flow Rate Verifactions&quot;</span>, <span class="st">&quot;QA Flow Rate Audits&quot;</span>,</span>
<span id="cb1-28"><a href="get-data.html#cb1-28" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;QA One Point QC Raw Data&quot;</span>, <span class="st">&quot;QA PEP Audits&quot;</span>))</span>
<span id="cb1-29"><a href="get-data.html#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="get-data.html#cb1-30" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-31"><a href="get-data.html#cb1-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">scope =</span> <span class="st">&#39;usa&#39;</span>,</span>
<span id="cb1-32"><a href="get-data.html#cb1-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">projection =</span> <span class="fu">list</span>(<span class="at">type =</span> <span class="st">&#39;albers usa&#39;</span>),</span>
<span id="cb1-33"><a href="get-data.html#cb1-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">showland =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1-34"><a href="get-data.html#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">landcolor =</span> <span class="fu">toRGB</span>(<span class="st">&quot;gray95&quot;</span>),</span>
<span id="cb1-35"><a href="get-data.html#cb1-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">subunitcolor =</span> <span class="fu">toRGB</span>(<span class="st">&quot;gray85&quot;</span>),</span>
<span id="cb1-36"><a href="get-data.html#cb1-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">countrycolor =</span> <span class="fu">toRGB</span>(<span class="st">&quot;gray85&quot;</span>),</span>
<span id="cb1-37"><a href="get-data.html#cb1-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">countrywidth =</span> <span class="fl">0.5</span>,</span>
<span id="cb1-38"><a href="get-data.html#cb1-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">subunitwidth =</span> <span class="fl">0.5</span></span>
<span id="cb1-39"><a href="get-data.html#cb1-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-40"><a href="get-data.html#cb1-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-41"><a href="get-data.html#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="get-data.html#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="get-data.html#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="get-data.html#cb1-44" aria-hidden="true" tabindex="-1"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb1-45"><a href="get-data.html#cb1-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">useShinyjs</span>(),</span>
<span id="cb1-46"><a href="get-data.html#cb1-46" aria-hidden="true" tabindex="-1"></a>  tags<span class="sc">$</span><span class="fu">style</span>(<span class="at">type=</span><span class="st">&#39;text/css&#39;</span>, <span class="st">&quot;nav.navbar.navbar-default.navbar-static-top{border-color: #f5f5f5;background-color: #f5f5f5;}&quot;</span>),</span>
<span id="cb1-47"><a href="get-data.html#cb1-47" aria-hidden="true" tabindex="-1"></a>  tags<span class="sc">$</span><span class="fu">style</span>(<span class="at">type=</span><span class="st">&#39;text/css&#39;</span>, <span class="st">&quot;.navbar{min-height: 0px; margin-bottom: 0px;}&quot;</span>),</span>
<span id="cb1-48"><a href="get-data.html#cb1-48" aria-hidden="true" tabindex="-1"></a>  tags<span class="sc">$</span><span class="fu">style</span>(<span class="at">type=</span><span class="st">&#39;text/css&#39;</span>, <span class="st">&quot;.navbar-brand{height: 0px; padding: 0px 0px;}&quot;</span>),</span>
<span id="cb1-49"><a href="get-data.html#cb1-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-50"><a href="get-data.html#cb1-50" aria-hidden="true" tabindex="-1"></a>  navbarPage</span>
<span id="cb1-51"><a href="get-data.html#cb1-51" aria-hidden="true" tabindex="-1"></a>  (</span>
<span id="cb1-52"><a href="get-data.html#cb1-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="cn">NULL</span>, <span class="at">id =</span> <span class="st">&quot;navBar&quot;</span>,</span>
<span id="cb1-53"><a href="get-data.html#cb1-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-54"><a href="get-data.html#cb1-54" aria-hidden="true" tabindex="-1"></a>    tabPanel</span>
<span id="cb1-55"><a href="get-data.html#cb1-55" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb1-56"><a href="get-data.html#cb1-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;01&quot;</span>, <span class="at">value =</span> <span class="st">&quot;panel1&quot;</span>,</span>
<span id="cb1-57"><a href="get-data.html#cb1-57" aria-hidden="true" tabindex="-1"></a>      <span class="fu">h1</span>(<span class="st">&quot;Log in or sign up for AQS API key&quot;</span>, <span class="at">align =</span> <span class="st">&quot;center&quot;</span>),</span>
<span id="cb1-58"><a href="get-data.html#cb1-58" aria-hidden="true" tabindex="-1"></a>      <span class="fu">textInput</span>(<span class="st">&quot;email&quot;</span>, <span class="st">&quot;Email&quot;</span>, <span class="st">&quot;&quot;</span>),</span>
<span id="cb1-59"><a href="get-data.html#cb1-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fluidRow</span>(<span class="fu">column</span>(<span class="dv">2</span>, <span class="fu">passwordInput</span>(<span class="st">&quot;key&quot;</span>, <span class="st">&quot;Key&quot;</span>, <span class="st">&quot;&quot;</span>)),</span>
<span id="cb1-60"><a href="get-data.html#cb1-60" aria-hidden="true" tabindex="-1"></a>               <span class="fu">column</span>(<span class="dv">8</span>, <span class="fu">br</span>(),</span>
<span id="cb1-61"><a href="get-data.html#cb1-61" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">dropMenu</span>(</span>
<span id="cb1-62"><a href="get-data.html#cb1-62" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">actionButton</span>(<span class="st">&quot;key_info&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="at">icon =</span> <span class="fu">icon</span>(<span class="st">&#39;info&#39;</span>)),</span>
<span id="cb1-63"><a href="get-data.html#cb1-63" aria-hidden="true" tabindex="-1"></a>                        tags<span class="sc">$</span><span class="fu">div</span>(</span>
<span id="cb1-64"><a href="get-data.html#cb1-64" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">span</span>(<span class="st">&quot;This is your AQS API key. If you do not have one or need to reset it, enter your email and click Sign up for API key (check your email in a few minutes).&quot;</span>),</span>
<span id="cb1-65"><a href="get-data.html#cb1-65" aria-hidden="true" tabindex="-1"></a>                        ),</span>
<span id="cb1-66"><a href="get-data.html#cb1-66" aria-hidden="true" tabindex="-1"></a>                 <span class="at">placement =</span> <span class="st">&quot;right&quot;</span>,</span>
<span id="cb1-67"><a href="get-data.html#cb1-67" aria-hidden="true" tabindex="-1"></a>                 <span class="at">arrow =</span> <span class="cn">TRUE</span>))),</span>
<span id="cb1-68"><a href="get-data.html#cb1-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fluidRow</span>(<span class="fu">column</span>(<span class="dv">2</span>, <span class="fu">actionButton</span>(<span class="st">&quot;auth&quot;</span>, <span class="st">&quot;Connect&quot;</span>)),</span>
<span id="cb1-69"><a href="get-data.html#cb1-69" aria-hidden="true" tabindex="-1"></a>               <span class="fu">column</span>(<span class="dv">2</span>, <span class="fu">actionButton</span>(<span class="st">&quot;signup&quot;</span>, <span class="st">&quot;Sign up for API key&quot;</span>)),</span>
<span id="cb1-70"><a href="get-data.html#cb1-70" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb1-71"><a href="get-data.html#cb1-71" aria-hidden="true" tabindex="-1"></a>               <span class="co">#column(4, br(), textOutput(&quot;authText&quot;))</span></span>
<span id="cb1-72"><a href="get-data.html#cb1-72" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb1-73"><a href="get-data.html#cb1-73" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb1-74"><a href="get-data.html#cb1-74" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-75"><a href="get-data.html#cb1-75" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb1-76"><a href="get-data.html#cb1-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-77"><a href="get-data.html#cb1-77" aria-hidden="true" tabindex="-1"></a>    tabPanel</span>
<span id="cb1-78"><a href="get-data.html#cb1-78" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb1-79"><a href="get-data.html#cb1-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;02&quot;</span>, <span class="at">value =</span> <span class="st">&quot;panel2&quot;</span>,</span>
<span id="cb1-80"><a href="get-data.html#cb1-80" aria-hidden="true" tabindex="-1"></a>      <span class="fu">actionButton</span>(<span class="st">&quot;go_back1&quot;</span>, <span class="st">&quot;Back&quot;</span>),</span>
<span id="cb1-81"><a href="get-data.html#cb1-81" aria-hidden="true" tabindex="-1"></a>      <span class="fu">h1</span>(<span class="st">&quot;Select service and selection method&quot;</span>, <span class="at">align =</span> <span class="st">&quot;center&quot;</span>),</span>
<span id="cb1-82"><a href="get-data.html#cb1-82" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-83"><a href="get-data.html#cb1-83" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fluidRow</span>(<span class="fu">column</span>(<span class="dv">2</span>, <span class="fu">pickerInput</span>(<span class="st">&quot;service&quot;</span>, <span class="at">label =</span> <span class="st">&quot;Select service&quot;</span>, <span class="at">choices =</span> service_opts)),</span>
<span id="cb1-84"><a href="get-data.html#cb1-84" aria-hidden="true" tabindex="-1"></a>               <span class="fu">column</span>(<span class="dv">2</span>, <span class="fu">actionButton</span>(<span class="st">&quot;by_state&quot;</span>, <span class="st">&quot;Select by state&quot;</span>)),</span>
<span id="cb1-85"><a href="get-data.html#cb1-85" aria-hidden="true" tabindex="-1"></a>               <span class="fu">column</span>(<span class="dv">2</span>, <span class="fu">actionButton</span>(<span class="st">&quot;by_county&quot;</span>, <span class="st">&quot;Select by county&quot;</span>)),</span>
<span id="cb1-86"><a href="get-data.html#cb1-86" aria-hidden="true" tabindex="-1"></a>               <span class="fu">column</span>(<span class="dv">2</span>, <span class="fu">actionButton</span>(<span class="st">&quot;by_site&quot;</span>, <span class="st">&quot;Select by site&quot;</span>))</span>
<span id="cb1-87"><a href="get-data.html#cb1-87" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb1-88"><a href="get-data.html#cb1-88" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb1-89"><a href="get-data.html#cb1-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-90"><a href="get-data.html#cb1-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tabPanel</span> (</span>
<span id="cb1-91"><a href="get-data.html#cb1-91" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;03&quot;</span>, <span class="at">value =</span> <span class="st">&quot;panel3&quot;</span>,</span>
<span id="cb1-92"><a href="get-data.html#cb1-92" aria-hidden="true" tabindex="-1"></a>      <span class="fu">actionButton</span>(<span class="st">&quot;go_back2&quot;</span>, <span class="st">&quot;Back&quot;</span>),</span>
<span id="cb1-93"><a href="get-data.html#cb1-93" aria-hidden="true" tabindex="-1"></a>      <span class="fu">h1</span>(<span class="st">&#39;Select one or more states by clicking, drawing shapes, or using the list at the bottom&#39;</span>, <span class="at">align =</span> <span class="st">&quot;center&quot;</span>),</span>
<span id="cb1-94"><a href="get-data.html#cb1-94" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-95"><a href="get-data.html#cb1-95" aria-hidden="true" tabindex="-1"></a>      <span class="fu">leafletOutput</span>(<span class="st">&quot;state_map&quot;</span>),</span>
<span id="cb1-96"><a href="get-data.html#cb1-96" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fluidRow</span>(</span>
<span id="cb1-97"><a href="get-data.html#cb1-97" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-98"><a href="get-data.html#cb1-98" aria-hidden="true" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">3</span>, <span class="fu">pickerInput</span>(<span class="st">&quot;states&quot;</span>, <span class="at">label =</span> <span class="st">&quot;Select states&quot;</span>, <span class="at">choices =</span> <span class="st">&quot;&quot;</span>, <span class="at">multiple =</span> T,</span>
<span id="cb1-99"><a href="get-data.html#cb1-99" aria-hidden="true" tabindex="-1"></a>                              <span class="at">options =</span> <span class="fu">list</span>(<span class="st">`</span><span class="at">actions-box</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">TRUE</span>, <span class="st">`</span><span class="at">live-search</span><span class="st">`</span><span class="ot">=</span><span class="cn">TRUE</span>))),</span>
<span id="cb1-100"><a href="get-data.html#cb1-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-101"><a href="get-data.html#cb1-101" aria-hidden="true" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">3</span>, <span class="fu">pickerInput</span>(<span class="st">&quot;parm_class&quot;</span>, <span class="at">label =</span> <span class="st">&quot;Select parameter class&quot;</span>, <span class="at">choices =</span> <span class="st">&quot;CRITERIA&quot;</span>,</span>
<span id="cb1-102"><a href="get-data.html#cb1-102" aria-hidden="true" tabindex="-1"></a>                              <span class="at">selected =</span> <span class="st">&quot;CRITERIA&quot;</span>,</span>
<span id="cb1-103"><a href="get-data.html#cb1-103" aria-hidden="true" tabindex="-1"></a>                              <span class="at">options =</span> <span class="fu">list</span>(<span class="st">`</span><span class="at">live-search</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">TRUE</span>))),</span>
<span id="cb1-104"><a href="get-data.html#cb1-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-105"><a href="get-data.html#cb1-105" aria-hidden="true" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">3</span>, <span class="fu">pickerInput</span>(<span class="st">&quot;parms&quot;</span>, <span class="at">label =</span> <span class="st">&quot;Select parameters&quot;</span>, <span class="at">choices =</span> <span class="st">&quot;&quot;</span>, <span class="at">multiple =</span> T,</span>
<span id="cb1-106"><a href="get-data.html#cb1-106" aria-hidden="true" tabindex="-1"></a>                              <span class="at">options =</span> <span class="fu">list</span>(<span class="st">`</span><span class="at">actions-box</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">TRUE</span>, <span class="st">`</span><span class="at">live-search</span><span class="st">`</span><span class="ot">=</span><span class="cn">TRUE</span>))),</span>
<span id="cb1-107"><a href="get-data.html#cb1-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-108"><a href="get-data.html#cb1-108" aria-hidden="true" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">3</span>, <span class="fu">dateRangeInput</span>(<span class="st">&quot;date_range&quot;</span>, <span class="st">&quot;Select date range&quot;</span>, <span class="fu">today</span>(), <span class="fu">today</span>()))</span>
<span id="cb1-109"><a href="get-data.html#cb1-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-110"><a href="get-data.html#cb1-110" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb1-111"><a href="get-data.html#cb1-111" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-112"><a href="get-data.html#cb1-112" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fluidRow</span>(</span>
<span id="cb1-113"><a href="get-data.html#cb1-113" aria-hidden="true" tabindex="-1"></a>        <span class="fu">actionButton</span>(<span class="st">&quot;get_data&quot;</span>, <span class="st">&quot;Get Data&quot;</span>),</span>
<span id="cb1-114"><a href="get-data.html#cb1-114" aria-hidden="true" tabindex="-1"></a>        <span class="fu">actionButton</span>(<span class="st">&quot;select_cnty&quot;</span>, <span class="st">&quot;Select Counties&quot;</span>),</span>
<span id="cb1-115"><a href="get-data.html#cb1-115" aria-hidden="true" tabindex="-1"></a>        <span class="fu">actionButton</span>(<span class="st">&quot;next_map&quot;</span>, <span class="st">&quot;Select sites&quot;</span>)</span>
<span id="cb1-116"><a href="get-data.html#cb1-116" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb1-117"><a href="get-data.html#cb1-117" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb1-118"><a href="get-data.html#cb1-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-119"><a href="get-data.html#cb1-119" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tabPanel</span> (</span>
<span id="cb1-120"><a href="get-data.html#cb1-120" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;04&quot;</span>, <span class="at">value =</span> <span class="st">&quot;panel4&quot;</span>,</span>
<span id="cb1-121"><a href="get-data.html#cb1-121" aria-hidden="true" tabindex="-1"></a>      <span class="fu">actionButton</span>(<span class="st">&quot;go_back3&quot;</span>, <span class="st">&quot;Back&quot;</span>),</span>
<span id="cb1-122"><a href="get-data.html#cb1-122" aria-hidden="true" tabindex="-1"></a>      <span class="fu">h1</span>(<span class="st">&quot;Select one or more counties&quot;</span>, <span class="at">align =</span> <span class="st">&quot;center&quot;</span>),</span>
<span id="cb1-123"><a href="get-data.html#cb1-123" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-124"><a href="get-data.html#cb1-124" aria-hidden="true" tabindex="-1"></a>      <span class="fu">leafletOutput</span>(<span class="st">&quot;cnty_map&quot;</span>),</span>
<span id="cb1-125"><a href="get-data.html#cb1-125" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fluidRow</span>(</span>
<span id="cb1-126"><a href="get-data.html#cb1-126" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-127"><a href="get-data.html#cb1-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">3</span>, <span class="fu">pickerInput</span>(<span class="st">&quot;cntys&quot;</span>, <span class="at">label =</span> <span class="st">&quot;Select counties&quot;</span>, <span class="at">choices =</span> <span class="st">&quot;&quot;</span>, <span class="at">multiple =</span> T,</span>
<span id="cb1-128"><a href="get-data.html#cb1-128" aria-hidden="true" tabindex="-1"></a>                              <span class="at">options =</span> <span class="fu">list</span>(<span class="st">`</span><span class="at">actions-box</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">TRUE</span>, <span class="st">`</span><span class="at">live-search</span><span class="st">`</span><span class="ot">=</span><span class="cn">TRUE</span>))),</span>
<span id="cb1-129"><a href="get-data.html#cb1-129" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-130"><a href="get-data.html#cb1-130" aria-hidden="true" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">3</span>, <span class="fu">actionButton</span>(<span class="st">&quot;get_data2&quot;</span>, <span class="st">&quot;Get Data&quot;</span>))</span>
<span id="cb1-131"><a href="get-data.html#cb1-131" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-132"><a href="get-data.html#cb1-132" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb1-133"><a href="get-data.html#cb1-133" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb1-134"><a href="get-data.html#cb1-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-135"><a href="get-data.html#cb1-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tabPanel</span> (</span>
<span id="cb1-136"><a href="get-data.html#cb1-136" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;05&quot;</span>, <span class="at">value =</span> <span class="st">&quot;panel5&quot;</span>,</span>
<span id="cb1-137"><a href="get-data.html#cb1-137" aria-hidden="true" tabindex="-1"></a>      <span class="fu">actionButton</span>(<span class="st">&quot;go_back4&quot;</span>, <span class="st">&quot;Back&quot;</span>),</span>
<span id="cb1-138"><a href="get-data.html#cb1-138" aria-hidden="true" tabindex="-1"></a>      <span class="fu">h1</span>(<span class="st">&quot;Select one or more monitors&quot;</span>, <span class="at">align =</span> <span class="st">&quot;center&quot;</span>),</span>
<span id="cb1-139"><a href="get-data.html#cb1-139" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-140"><a href="get-data.html#cb1-140" aria-hidden="true" tabindex="-1"></a>      <span class="fu">leafletOutput</span>(<span class="st">&quot;site_map&quot;</span>),</span>
<span id="cb1-141"><a href="get-data.html#cb1-141" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fluidRow</span>(</span>
<span id="cb1-142"><a href="get-data.html#cb1-142" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-143"><a href="get-data.html#cb1-143" aria-hidden="true" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">3</span>, <span class="fu">pickerInput</span>(<span class="st">&quot;site_select&quot;</span>, <span class="at">label =</span> <span class="st">&quot;Select sites&quot;</span>, <span class="at">choices =</span> <span class="st">&quot;&quot;</span>, <span class="at">multiple =</span> T,</span>
<span id="cb1-144"><a href="get-data.html#cb1-144" aria-hidden="true" tabindex="-1"></a>                              <span class="at">options =</span> <span class="fu">list</span>(<span class="st">`</span><span class="at">actions-box</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">TRUE</span>, <span class="st">`</span><span class="at">live-search</span><span class="st">`</span><span class="ot">=</span><span class="cn">TRUE</span>))),</span>
<span id="cb1-145"><a href="get-data.html#cb1-145" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-146"><a href="get-data.html#cb1-146" aria-hidden="true" tabindex="-1"></a>        <span class="fu">column</span>(<span class="dv">3</span>, <span class="fu">actionButton</span>(<span class="st">&quot;get_data3&quot;</span>, <span class="st">&quot;Get Data&quot;</span>))</span>
<span id="cb1-147"><a href="get-data.html#cb1-147" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-148"><a href="get-data.html#cb1-148" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb1-149"><a href="get-data.html#cb1-149" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb1-150"><a href="get-data.html#cb1-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-151"><a href="get-data.html#cb1-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tabPanel</span> (</span>
<span id="cb1-152"><a href="get-data.html#cb1-152" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">&quot;06&quot;</span>, <span class="at">value =</span> <span class="st">&quot;panel6&quot;</span>,</span>
<span id="cb1-153"><a href="get-data.html#cb1-153" aria-hidden="true" tabindex="-1"></a>      <span class="fu">actionButton</span>(<span class="st">&quot;go_back5&quot;</span>, <span class="st">&quot;Back&quot;</span>),</span>
<span id="cb1-154"><a href="get-data.html#cb1-154" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-155"><a href="get-data.html#cb1-155" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tabsetPanel</span>(</span>
<span id="cb1-156"><a href="get-data.html#cb1-156" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tabPanel</span>(<span class="st">&quot;View data&quot;</span>,</span>
<span id="cb1-157"><a href="get-data.html#cb1-157" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">fluidRow</span>(<span class="fu">column</span>(<span class="dv">1</span>, <span class="fu">downloadButton</span>(<span class="st">&quot;downloadData&quot;</span>, <span class="st">&quot;Download&quot;</span>)),</span>
<span id="cb1-158"><a href="get-data.html#cb1-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-159"><a href="get-data.html#cb1-159" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">column</span>(<span class="dv">11</span>, <span class="fu">withSpinner</span>(<span class="fu">dataTableOutput</span>(<span class="st">&quot;table&quot;</span>), <span class="at">type =</span> <span class="dv">1</span>))</span>
<span id="cb1-160"><a href="get-data.html#cb1-160" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb1-161"><a href="get-data.html#cb1-161" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1-162"><a href="get-data.html#cb1-162" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb1-163"><a href="get-data.html#cb1-163" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-164"><a href="get-data.html#cb1-164" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-165"><a href="get-data.html#cb1-165" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-166"><a href="get-data.html#cb1-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-167"><a href="get-data.html#cb1-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-168"><a href="get-data.html#cb1-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-169"><a href="get-data.html#cb1-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-170"><a href="get-data.html#cb1-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-171"><a href="get-data.html#cb1-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-172"><a href="get-data.html#cb1-172" aria-hidden="true" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output, session) {</span>
<span id="cb1-173"><a href="get-data.html#cb1-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-174"><a href="get-data.html#cb1-174" aria-hidden="true" tabindex="-1"></a>  v <span class="ot">&lt;-</span> <span class="fu">reactiveValues</span>(<span class="at">geo_select =</span> <span class="fu">c</span>(),</span>
<span id="cb1-175"><a href="get-data.html#cb1-175" aria-hidden="true" tabindex="-1"></a>                      <span class="at">selected_states =</span> <span class="fu">c</span>(),</span>
<span id="cb1-176"><a href="get-data.html#cb1-176" aria-hidden="true" tabindex="-1"></a>                      <span class="at">selected_cntys =</span> <span class="fu">c</span>(),</span>
<span id="cb1-177"><a href="get-data.html#cb1-177" aria-hidden="true" tabindex="-1"></a>                      <span class="at">selected_sites =</span> <span class="fu">c</span>(),</span>
<span id="cb1-178"><a href="get-data.html#cb1-178" aria-hidden="true" tabindex="-1"></a>                      <span class="at">state_polys =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-179"><a href="get-data.html#cb1-179" aria-hidden="true" tabindex="-1"></a>                      <span class="at">cnty_polys =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-180"><a href="get-data.html#cb1-180" aria-hidden="true" tabindex="-1"></a>                      <span class="at">site_polys =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-181"><a href="get-data.html#cb1-181" aria-hidden="true" tabindex="-1"></a>                      <span class="at">selected_classes =</span> <span class="st">&quot;CRITERIA&quot;</span>,</span>
<span id="cb1-182"><a href="get-data.html#cb1-182" aria-hidden="true" tabindex="-1"></a>                      <span class="at">selected_parms =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-183"><a href="get-data.html#cb1-183" aria-hidden="true" tabindex="-1"></a>                      <span class="at">selected_dates =</span> <span class="fu">list</span>(<span class="fu">ymd</span>(<span class="dv">20190101</span>), <span class="fu">ymd</span>(<span class="dv">20190101</span>)),</span>
<span id="cb1-184"><a href="get-data.html#cb1-184" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> <span class="fu">data.table</span>()</span>
<span id="cb1-185"><a href="get-data.html#cb1-185" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-186"><a href="get-data.html#cb1-186" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-187"><a href="get-data.html#cb1-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>signup,{</span>
<span id="cb1-188"><a href="get-data.html#cb1-188" aria-hidden="true" tabindex="-1"></a>    <span class="fu">req</span>(input<span class="sc">$</span>email)</span>
<span id="cb1-189"><a href="get-data.html#cb1-189" aria-hidden="true" tabindex="-1"></a>    check_auth <span class="ot">&lt;&lt;-</span> <span class="fu">GET</span>(<span class="fu">glue</span>(<span class="st">&quot;https://aqs.epa.gov/data/api/signup?email={input$email}&quot;</span>))<span class="sc">$</span>content <span class="sc">%&gt;%</span></span>
<span id="cb1-190"><a href="get-data.html#cb1-190" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rawToChar</span>() <span class="sc">%&gt;%</span> <span class="fu">fromJSON</span>() <span class="sc">%&gt;%</span> <span class="fu">pluck</span>(<span class="st">&quot;Data&quot;</span>)</span>
<span id="cb1-191"><a href="get-data.html#cb1-191" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">ignoreInit =</span> T)</span>
<span id="cb1-192"><a href="get-data.html#cb1-192" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-193"><a href="get-data.html#cb1-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(<span class="fu">state_list</span>(), {</span>
<span id="cb1-194"><a href="get-data.html#cb1-194" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hide</span>(<span class="at">selector =</span> <span class="st">&quot;#navBar li a[data-value=panel1]&quot;</span>)</span>
<span id="cb1-195"><a href="get-data.html#cb1-195" aria-hidden="true" tabindex="-1"></a>    shinyjs<span class="sc">::</span><span class="fu">show</span>(<span class="at">selector =</span> <span class="st">&quot;#navBar li a[data-value=panel2]&quot;</span>)</span>
<span id="cb1-196"><a href="get-data.html#cb1-196" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateNavbarPage</span>(session, <span class="st">&quot;navBar&quot;</span>, <span class="at">selected=</span><span class="st">&quot;panel2&quot;</span>)</span>
<span id="cb1-197"><a href="get-data.html#cb1-197" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-198"><a href="get-data.html#cb1-198" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-199"><a href="get-data.html#cb1-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>by_state, v<span class="sc">$</span>geo_select <span class="ot">&lt;-</span> <span class="st">&quot;State&quot;</span>)</span>
<span id="cb1-200"><a href="get-data.html#cb1-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>by_county, v<span class="sc">$</span>geo_select <span class="ot">&lt;-</span> <span class="st">&quot;County&quot;</span>)</span>
<span id="cb1-201"><a href="get-data.html#cb1-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>by_site, v<span class="sc">$</span>geo_select <span class="ot">&lt;-</span> <span class="st">&quot;Site&quot;</span>)</span>
<span id="cb1-202"><a href="get-data.html#cb1-202" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-203"><a href="get-data.html#cb1-203" aria-hidden="true" tabindex="-1"></a>  state_list <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb1-204"><a href="get-data.html#cb1-204" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(input<span class="sc">$</span>auth <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>()</span>
<span id="cb1-205"><a href="get-data.html#cb1-205" aria-hidden="true" tabindex="-1"></a>    <span class="fu">isolate</span>({</span>
<span id="cb1-206"><a href="get-data.html#cb1-206" aria-hidden="true" tabindex="-1"></a>      json_states <span class="ot">&lt;&lt;-</span> <span class="fu">rawToChar</span>(<span class="fu">GET</span>(</span>
<span id="cb1-207"><a href="get-data.html#cb1-207" aria-hidden="true" tabindex="-1"></a>        <span class="fu">glue</span>(</span>
<span id="cb1-208"><a href="get-data.html#cb1-208" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;https://aqs.epa.gov/data/api/list/states?email={input$email}&amp;key={input$key}&quot;</span></span>
<span id="cb1-209"><a href="get-data.html#cb1-209" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb1-210"><a href="get-data.html#cb1-210" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-211"><a href="get-data.html#cb1-211" aria-hidden="true" tabindex="-1"></a>        <span class="at">encode =</span> <span class="st">&quot;json&quot;</span></span>
<span id="cb1-212"><a href="get-data.html#cb1-212" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-213"><a href="get-data.html#cb1-213" aria-hidden="true" tabindex="-1"></a>      )<span class="sc">$</span>content)</span>
<span id="cb1-214"><a href="get-data.html#cb1-214" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-215"><a href="get-data.html#cb1-215" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-216"><a href="get-data.html#cb1-216" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-217"><a href="get-data.html#cb1-217" aria-hidden="true" tabindex="-1"></a>      states <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">str_detect</span>(json_states, <span class="st">&#39;</span><span class="sc">\\</span><span class="st">&quot;status</span><span class="sc">\\</span><span class="st">&quot;: </span><span class="sc">\\</span><span class="st">&quot;Success</span><span class="sc">\\</span><span class="st">&quot;&#39;</span>))</span>
<span id="cb1-218"><a href="get-data.html#cb1-218" aria-hidden="true" tabindex="-1"></a>        <span class="cn">NULL</span> <span class="cf">else</span></span>
<span id="cb1-219"><a href="get-data.html#cb1-219" aria-hidden="true" tabindex="-1"></a>          <span class="fu">fromJSON</span>(json_states, <span class="at">simplifyDataFrame =</span> T)<span class="sc">$</span>Data <span class="sc">%&gt;%</span></span>
<span id="cb1-220"><a href="get-data.html#cb1-220" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setDT</span>()</span>
<span id="cb1-221"><a href="get-data.html#cb1-221" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-222"><a href="get-data.html#cb1-222" aria-hidden="true" tabindex="-1"></a>      check3 <span class="ot">&lt;&lt;-</span> states</span>
<span id="cb1-223"><a href="get-data.html#cb1-223" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb1-224"><a href="get-data.html#cb1-224" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-225"><a href="get-data.html#cb1-225" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-226"><a href="get-data.html#cb1-226" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-227"><a href="get-data.html#cb1-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(<span class="fu">list</span>(input<span class="sc">$</span>by_state, input<span class="sc">$</span>by_county, input<span class="sc">$</span>by_site), {</span>
<span id="cb1-228"><a href="get-data.html#cb1-228" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-229"><a href="get-data.html#cb1-229" aria-hidden="true" tabindex="-1"></a>    shiny<span class="sc">::</span><span class="fu">validate</span>(<span class="fu">need</span>(<span class="fu">state_list</span>(), <span class="at">label =</span> <span class="st">&quot;state_list&quot;</span>))</span>
<span id="cb1-230"><a href="get-data.html#cb1-230" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-231"><a href="get-data.html#cb1-231" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updatePickerInput</span>(<span class="at">session =</span> session, <span class="at">inputId =</span> <span class="st">&quot;states&quot;</span>,</span>
<span id="cb1-232"><a href="get-data.html#cb1-232" aria-hidden="true" tabindex="-1"></a>                      <span class="at">choices =</span> <span class="fu">state_list</span>()[, code <span class="sc">%&gt;%</span> <span class="fu">setNames</span>(<span class="fu">paste0</span>(code, <span class="st">&quot;: &quot;</span>, value_represented))],</span>
<span id="cb1-233"><a href="get-data.html#cb1-233" aria-hidden="true" tabindex="-1"></a>                      <span class="at">selected =</span> v<span class="sc">$</span>selected_states</span>
<span id="cb1-234"><a href="get-data.html#cb1-234" aria-hidden="true" tabindex="-1"></a>                      )</span>
<span id="cb1-235"><a href="get-data.html#cb1-235" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">priority =</span> <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb1-236"><a href="get-data.html#cb1-236" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-237"><a href="get-data.html#cb1-237" aria-hidden="true" tabindex="-1"></a>  state_data <span class="ot">&lt;-</span> <span class="fu">reactive</span>(<span class="fu">states</span>(<span class="at">cb =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-238"><a href="get-data.html#cb1-238" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-239"><a href="get-data.html#cb1-239" aria-hidden="true" tabindex="-1"></a>  cnty_data <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb1-240"><a href="get-data.html#cb1-240" aria-hidden="true" tabindex="-1"></a>    input<span class="sc">$</span>select_cnty</span>
<span id="cb1-241"><a href="get-data.html#cb1-241" aria-hidden="true" tabindex="-1"></a>    <span class="fu">isolate</span>({</span>
<span id="cb1-242"><a href="get-data.html#cb1-242" aria-hidden="true" tabindex="-1"></a>      shiny<span class="sc">::</span><span class="fu">validate</span>(<span class="fu">need</span>(v<span class="sc">$</span>selected_states, <span class="at">label =</span> <span class="st">&quot;states&quot;</span>))</span>
<span id="cb1-243"><a href="get-data.html#cb1-243" aria-hidden="true" tabindex="-1"></a>      <span class="fu">counties</span>(<span class="at">state =</span> v<span class="sc">$</span>selected_states)})</span>
<span id="cb1-244"><a href="get-data.html#cb1-244" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-245"><a href="get-data.html#cb1-245" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-246"><a href="get-data.html#cb1-246" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-247"><a href="get-data.html#cb1-247" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-248"><a href="get-data.html#cb1-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>states, v<span class="sc">$</span>selected_states <span class="ot">&lt;-</span> input<span class="sc">$</span>states, <span class="at">ignoreNULL =</span> F)</span>
<span id="cb1-249"><a href="get-data.html#cb1-249" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-250"><a href="get-data.html#cb1-250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>state_map_shape_click,{</span>
<span id="cb1-251"><a href="get-data.html#cb1-251" aria-hidden="true" tabindex="-1"></a>    clicked <span class="ot">&lt;-</span> input<span class="sc">$</span>state_map_shape_click<span class="sc">$</span>id <span class="sc">%&gt;%</span> <span class="fu">str_extract</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">d+&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">str_pad</span>(<span class="dv">2</span>, <span class="st">&quot;left&quot;</span>, <span class="dv">0</span>)</span>
<span id="cb1-252"><a href="get-data.html#cb1-252" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(clicked <span class="sc">%in%</span> v<span class="sc">$</span>selected_states) {</span>
<span id="cb1-253"><a href="get-data.html#cb1-253" aria-hidden="true" tabindex="-1"></a>      v<span class="sc">$</span>selected_states <span class="ot">&lt;-</span> v<span class="sc">$</span>selected_states[<span class="sc">!</span>(v<span class="sc">$</span>selected_states <span class="sc">%in%</span> clicked)]</span>
<span id="cb1-254"><a href="get-data.html#cb1-254" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1-255"><a href="get-data.html#cb1-255" aria-hidden="true" tabindex="-1"></a>      v<span class="sc">$</span>selected_states <span class="ot">&lt;-</span> <span class="fu">c</span>(v<span class="sc">$</span>selected_states, clicked)  </span>
<span id="cb1-256"><a href="get-data.html#cb1-256" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-257"><a href="get-data.html#cb1-257" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-258"><a href="get-data.html#cb1-258" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-259"><a href="get-data.html#cb1-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>state_map_draw_new_feature,{</span>
<span id="cb1-260"><a href="get-data.html#cb1-260" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-261"><a href="get-data.html#cb1-261" aria-hidden="true" tabindex="-1"></a>    v<span class="sc">$</span>state_polys <span class="ot">&lt;-</span> <span class="fu">c</span>(v<span class="sc">$</span>state_polys, <span class="fu">list</span>(input<span class="sc">$</span>state_map_draw_new_feature)) <span class="sc">%&gt;%</span></span>
<span id="cb1-262"><a href="get-data.html#cb1-262" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_names</span>(purrr<span class="sc">::</span><span class="fu">map</span>(., <span class="sc">~</span>.x<span class="sc">$</span>properties<span class="sc">$</span><span class="st">`</span><span class="at">_leaflet_id</span><span class="st">`</span>))</span>
<span id="cb1-263"><a href="get-data.html#cb1-263" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-264"><a href="get-data.html#cb1-264" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-265"><a href="get-data.html#cb1-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>state_map_draw_deleted_features,{</span>
<span id="cb1-266"><a href="get-data.html#cb1-266" aria-hidden="true" tabindex="-1"></a>    remove_polys <span class="ot">&lt;-</span> <span class="fu">map_int</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(input<span class="sc">$</span>state_map_draw_deleted_features<span class="sc">$</span>features),</span>
<span id="cb1-267"><a href="get-data.html#cb1-267" aria-hidden="true" tabindex="-1"></a>                             <span class="sc">~</span><span class="fu">pluck</span>(input<span class="sc">$</span>state_map_draw_deleted_features, <span class="st">&quot;features&quot;</span>, .x, <span class="st">&quot;properties&quot;</span>, <span class="st">&quot;_leaflet_id&quot;</span>))</span>
<span id="cb1-268"><a href="get-data.html#cb1-268" aria-hidden="true" tabindex="-1"></a>    v<span class="sc">$</span>state_polys <span class="ot">&lt;-</span> v<span class="sc">$</span>state_polys[<span class="sc">!</span>(<span class="fu">names</span>(v<span class="sc">$</span>state_polys) <span class="sc">%in%</span> <span class="fu">as.character</span>(remove_polys))]</span>
<span id="cb1-269"><a href="get-data.html#cb1-269" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-270"><a href="get-data.html#cb1-270" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-271"><a href="get-data.html#cb1-271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(v<span class="sc">$</span>state_polys, {</span>
<span id="cb1-272"><a href="get-data.html#cb1-272" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-273"><a href="get-data.html#cb1-273" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">length</span>(v<span class="sc">$</span>state_polys)) {</span>
<span id="cb1-274"><a href="get-data.html#cb1-274" aria-hidden="true" tabindex="-1"></a>      v<span class="sc">$</span>selected_states <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-275"><a href="get-data.html#cb1-275" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>()</span>
<span id="cb1-276"><a href="get-data.html#cb1-276" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-277"><a href="get-data.html#cb1-277" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-278"><a href="get-data.html#cb1-278" aria-hidden="true" tabindex="-1"></a>    polys <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(v<span class="sc">$</span>state_polys, <span class="sc">~</span><span class="cf">if</span>(.x<span class="sc">$</span>properties<span class="sc">$</span>feature_type <span class="sc">==</span> <span class="st">&quot;circle&quot;</span>) {</span>
<span id="cb1-279"><a href="get-data.html#cb1-279" aria-hidden="true" tabindex="-1"></a>      .x<span class="sc">$</span>geometry<span class="sc">$</span>coordinates <span class="sc">%&gt;%</span> <span class="fu">unlist</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-280"><a href="get-data.html#cb1-280" aria-hidden="true" tabindex="-1"></a>        {<span class="fu">circle.polygon</span>(.[<span class="dv">1</span>], .[<span class="dv">2</span>], .x<span class="sc">$</span>properties<span class="sc">$</span>radius <span class="sc">/</span> <span class="dv">1000</span>, <span class="at">sides =</span> <span class="dv">1000</span>, <span class="at">by.length =</span> F,</span>
<span id="cb1-281"><a href="get-data.html#cb1-281" aria-hidden="true" tabindex="-1"></a>                        <span class="at">units =</span> <span class="st">&quot;km&quot;</span>, <span class="at">poly.type =</span> <span class="st">&quot;gc.earth&quot;</span>)} <span class="sc">%&gt;%</span></span>
<span id="cb1-282"><a href="get-data.html#cb1-282" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Polygon</span>()</span>
<span id="cb1-283"><a href="get-data.html#cb1-283" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1-284"><a href="get-data.html#cb1-284" aria-hidden="true" tabindex="-1"></a>      .x<span class="sc">$</span>geometry<span class="sc">$</span>coordinates[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> <span class="fu">Polygon</span>()</span>
<span id="cb1-285"><a href="get-data.html#cb1-285" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb1-286"><a href="get-data.html#cb1-286" aria-hidden="true" tabindex="-1"></a>    polys <span class="ot">&lt;-</span> polys <span class="sc">%&gt;%</span> <span class="fu">imap</span>(<span class="sc">~</span><span class="fu">Polygons</span>(<span class="fu">list</span>(.x), .y)) <span class="sc">%&gt;%</span> <span class="fu">SpatialPolygons</span>() <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>()</span>
<span id="cb1-287"><a href="get-data.html#cb1-287" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_crs</span>(polys) <span class="ot">&lt;-</span> <span class="st">&quot;WGS84&quot;</span></span>
<span id="cb1-288"><a href="get-data.html#cb1-288" aria-hidden="true" tabindex="-1"></a>    polys <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(polys, <span class="st">&quot;NAD83&quot;</span>)</span>
<span id="cb1-289"><a href="get-data.html#cb1-289" aria-hidden="true" tabindex="-1"></a>    state_data1 <span class="ot">&lt;&lt;-</span> <span class="fu">state_data</span>()</span>
<span id="cb1-290"><a href="get-data.html#cb1-290" aria-hidden="true" tabindex="-1"></a>    v<span class="sc">$</span>selected_states <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(<span class="fu">state_data</span>(), polys) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(GEOID)</span>
<span id="cb1-291"><a href="get-data.html#cb1-291" aria-hidden="true" tabindex="-1"></a>    check5 <span class="ot">&lt;-</span> v<span class="sc">$</span>selected_states</span>
<span id="cb1-292"><a href="get-data.html#cb1-292" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-293"><a href="get-data.html#cb1-293" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-294"><a href="get-data.html#cb1-294" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(v<span class="sc">$</span>selected_states, {</span>
<span id="cb1-295"><a href="get-data.html#cb1-295" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(<span class="fu">state_list</span>())) <span class="fu">return</span>()</span>
<span id="cb1-296"><a href="get-data.html#cb1-296" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-297"><a href="get-data.html#cb1-297" aria-hidden="true" tabindex="-1"></a>    check1 <span class="ot">&lt;&lt;-</span> <span class="fu">state_data</span>()</span>
<span id="cb1-298"><a href="get-data.html#cb1-298" aria-hidden="true" tabindex="-1"></a>    check2 <span class="ot">&lt;&lt;-</span> v<span class="sc">$</span>selected_states</span>
<span id="cb1-299"><a href="get-data.html#cb1-299" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-300"><a href="get-data.html#cb1-300" aria-hidden="true" tabindex="-1"></a>    selected <span class="ot">&lt;&lt;-</span> <span class="fu">subset</span>(<span class="fu">state_data</span>(), STATEFP <span class="sc">%in%</span> v<span class="sc">$</span>selected_states)</span>
<span id="cb1-301"><a href="get-data.html#cb1-301" aria-hidden="true" tabindex="-1"></a>    not_selected <span class="ot">&lt;&lt;-</span> <span class="fu">subset</span>(<span class="fu">state_data</span>(), <span class="sc">!</span>(STATEFP <span class="sc">%in%</span> v<span class="sc">$</span>selected_states))</span>
<span id="cb1-302"><a href="get-data.html#cb1-302" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-303"><a href="get-data.html#cb1-303" aria-hidden="true" tabindex="-1"></a>    proxy <span class="ot">&lt;-</span> <span class="fu">leafletProxy</span>(<span class="st">&quot;state_map&quot;</span>, session)</span>
<span id="cb1-304"><a href="get-data.html#cb1-304" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(selected) <span class="sc">&gt;</span> <span class="dv">0</span>) {proxy <span class="sc">%&gt;%</span></span>
<span id="cb1-305"><a href="get-data.html#cb1-305" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addPolygons</span>(</span>
<span id="cb1-306"><a href="get-data.html#cb1-306" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> selected,</span>
<span id="cb1-307"><a href="get-data.html#cb1-307" aria-hidden="true" tabindex="-1"></a>          <span class="at">fillColor =</span> <span class="st">&quot;blue&quot;</span>,</span>
<span id="cb1-308"><a href="get-data.html#cb1-308" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb1-309"><a href="get-data.html#cb1-309" aria-hidden="true" tabindex="-1"></a>          <span class="at">label =</span> <span class="sc">~</span>selected<span class="sc">$</span>NAME,</span>
<span id="cb1-310"><a href="get-data.html#cb1-310" aria-hidden="true" tabindex="-1"></a>          <span class="at">layerId =</span> <span class="sc">~</span><span class="fu">paste</span>(selected<span class="sc">$</span>STATEFP, <span class="st">&quot;selected&quot;</span>),</span>
<span id="cb1-311"><a href="get-data.html#cb1-311" aria-hidden="true" tabindex="-1"></a>          <span class="at">options =</span> <span class="fu">pathOptions</span>(<span class="at">pane =</span> <span class="st">&quot;selected_states&quot;</span>)</span>
<span id="cb1-312"><a href="get-data.html#cb1-312" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1-313"><a href="get-data.html#cb1-313" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-314"><a href="get-data.html#cb1-314" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-315"><a href="get-data.html#cb1-315" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-316"><a href="get-data.html#cb1-316" aria-hidden="true" tabindex="-1"></a>    proxy <span class="sc">%&gt;%</span> <span class="fu">removeShape</span>(<span class="at">layerId =</span> <span class="fu">paste</span>(not_selected<span class="sc">$</span>STATEFP, <span class="st">&quot;selected&quot;</span>))</span>
<span id="cb1-317"><a href="get-data.html#cb1-317" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-318"><a href="get-data.html#cb1-318" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updatePickerInput</span>(<span class="at">session =</span> session, <span class="at">inputId =</span> <span class="st">&quot;states&quot;</span>,</span>
<span id="cb1-319"><a href="get-data.html#cb1-319" aria-hidden="true" tabindex="-1"></a>                      <span class="at">choices =</span> <span class="fu">state_list</span>()[, code <span class="sc">%&gt;%</span> <span class="fu">setNames</span>(<span class="fu">paste0</span>(code, <span class="st">&quot;: &quot;</span>, value_represented))],</span>
<span id="cb1-320"><a href="get-data.html#cb1-320" aria-hidden="true" tabindex="-1"></a>                      <span class="at">selected =</span> v<span class="sc">$</span>selected_states)</span>
<span id="cb1-321"><a href="get-data.html#cb1-321" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-322"><a href="get-data.html#cb1-322" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">ignoreNULL =</span> F)</span>
<span id="cb1-323"><a href="get-data.html#cb1-323" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-324"><a href="get-data.html#cb1-324" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-325"><a href="get-data.html#cb1-325" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>cntys, v<span class="sc">$</span>selected_cntys <span class="ot">&lt;-</span> input<span class="sc">$</span>cntys, <span class="at">ignoreNULL =</span> F)</span>
<span id="cb1-326"><a href="get-data.html#cb1-326" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-327"><a href="get-data.html#cb1-327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>cnty_map_shape_click,{</span>
<span id="cb1-328"><a href="get-data.html#cb1-328" aria-hidden="true" tabindex="-1"></a>    clicked <span class="ot">&lt;&lt;-</span> input<span class="sc">$</span>cnty_map_shape_click<span class="sc">$</span>id <span class="sc">%&gt;%</span> <span class="fu">str_extract</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">d+&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">str_pad</span>(<span class="dv">3</span>, <span class="st">&quot;left&quot;</span>, <span class="dv">0</span>)</span>
<span id="cb1-329"><a href="get-data.html#cb1-329" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(clicked <span class="sc">%in%</span> v<span class="sc">$</span>selected_cntys) {</span>
<span id="cb1-330"><a href="get-data.html#cb1-330" aria-hidden="true" tabindex="-1"></a>      v<span class="sc">$</span>selected_cntys <span class="ot">&lt;-</span> v<span class="sc">$</span>selected_cntys[<span class="sc">!</span>(v<span class="sc">$</span>selected_cntys <span class="sc">%in%</span> clicked)]</span>
<span id="cb1-331"><a href="get-data.html#cb1-331" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1-332"><a href="get-data.html#cb1-332" aria-hidden="true" tabindex="-1"></a>      v<span class="sc">$</span>selected_cntys <span class="ot">&lt;-</span> <span class="fu">c</span>(v<span class="sc">$</span>selected_cntys, clicked)</span>
<span id="cb1-333"><a href="get-data.html#cb1-333" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-334"><a href="get-data.html#cb1-334" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-335"><a href="get-data.html#cb1-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-336"><a href="get-data.html#cb1-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>cnty_map_draw_new_feature,{</span>
<span id="cb1-337"><a href="get-data.html#cb1-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-338"><a href="get-data.html#cb1-338" aria-hidden="true" tabindex="-1"></a>    v<span class="sc">$</span>cnty_polys <span class="ot">&lt;-</span> <span class="fu">c</span>(v<span class="sc">$</span>cnty_polys, <span class="fu">list</span>(input<span class="sc">$</span>cnty_map_draw_new_feature)) <span class="sc">%&gt;%</span></span>
<span id="cb1-339"><a href="get-data.html#cb1-339" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_names</span>(purrr<span class="sc">::</span><span class="fu">map</span>(., <span class="sc">~</span>.x<span class="sc">$</span>properties<span class="sc">$</span><span class="st">`</span><span class="at">_leaflet_id</span><span class="st">`</span>))</span>
<span id="cb1-340"><a href="get-data.html#cb1-340" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-341"><a href="get-data.html#cb1-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-342"><a href="get-data.html#cb1-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>cnty_map_draw_deleted_features,{</span>
<span id="cb1-343"><a href="get-data.html#cb1-343" aria-hidden="true" tabindex="-1"></a>    remove_polys <span class="ot">&lt;-</span> <span class="fu">map_int</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(input<span class="sc">$</span>cnty_map_draw_deleted_features<span class="sc">$</span>features),</span>
<span id="cb1-344"><a href="get-data.html#cb1-344" aria-hidden="true" tabindex="-1"></a>                            <span class="sc">~</span><span class="fu">pluck</span>(input<span class="sc">$</span>cnty_map_draw_deleted_features, <span class="st">&quot;features&quot;</span>, .x, <span class="st">&quot;properties&quot;</span>, <span class="st">&quot;_leaflet_id&quot;</span>))</span>
<span id="cb1-345"><a href="get-data.html#cb1-345" aria-hidden="true" tabindex="-1"></a>    v<span class="sc">$</span>cnty_polys <span class="ot">&lt;-</span> v<span class="sc">$</span>cnty_polys[<span class="sc">!</span>(<span class="fu">names</span>(v<span class="sc">$</span>cnty_polys) <span class="sc">%in%</span> <span class="fu">as.character</span>(remove_polys))]</span>
<span id="cb1-346"><a href="get-data.html#cb1-346" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-347"><a href="get-data.html#cb1-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-348"><a href="get-data.html#cb1-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(v<span class="sc">$</span>cnty_polys, {</span>
<span id="cb1-349"><a href="get-data.html#cb1-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-350"><a href="get-data.html#cb1-350" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">length</span>(v<span class="sc">$</span>cnty_polys)) {</span>
<span id="cb1-351"><a href="get-data.html#cb1-351" aria-hidden="true" tabindex="-1"></a>      v<span class="sc">$</span>selected_cntys <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-352"><a href="get-data.html#cb1-352" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>()</span>
<span id="cb1-353"><a href="get-data.html#cb1-353" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-354"><a href="get-data.html#cb1-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-355"><a href="get-data.html#cb1-355" aria-hidden="true" tabindex="-1"></a>    polys <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(v<span class="sc">$</span>cnty_polys, <span class="sc">~</span><span class="cf">if</span>(.x<span class="sc">$</span>properties<span class="sc">$</span>feature_type <span class="sc">==</span> <span class="st">&quot;circle&quot;</span>) {</span>
<span id="cb1-356"><a href="get-data.html#cb1-356" aria-hidden="true" tabindex="-1"></a>      .x<span class="sc">$</span>geometry<span class="sc">$</span>coordinates <span class="sc">%&gt;%</span> <span class="fu">unlist</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-357"><a href="get-data.html#cb1-357" aria-hidden="true" tabindex="-1"></a>        {<span class="fu">circle.polygon</span>(.[<span class="dv">1</span>], .[<span class="dv">2</span>], .x<span class="sc">$</span>properties<span class="sc">$</span>radius <span class="sc">/</span> <span class="dv">1000</span>, <span class="at">sides =</span> <span class="dv">1000</span>, <span class="at">by.length =</span> F,</span>
<span id="cb1-358"><a href="get-data.html#cb1-358" aria-hidden="true" tabindex="-1"></a>                        <span class="at">units =</span> <span class="st">&quot;km&quot;</span>, <span class="at">poly.type =</span> <span class="st">&quot;gc.earth&quot;</span>)} <span class="sc">%&gt;%</span></span>
<span id="cb1-359"><a href="get-data.html#cb1-359" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Polygon</span>()</span>
<span id="cb1-360"><a href="get-data.html#cb1-360" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1-361"><a href="get-data.html#cb1-361" aria-hidden="true" tabindex="-1"></a>      .x<span class="sc">$</span>geometry<span class="sc">$</span>coordinates[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> <span class="fu">Polygon</span>()</span>
<span id="cb1-362"><a href="get-data.html#cb1-362" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb1-363"><a href="get-data.html#cb1-363" aria-hidden="true" tabindex="-1"></a>    polys <span class="ot">&lt;-</span> polys <span class="sc">%&gt;%</span> <span class="fu">imap</span>(<span class="sc">~</span><span class="fu">Polygons</span>(<span class="fu">list</span>(.x), .y)) <span class="sc">%&gt;%</span> <span class="fu">SpatialPolygons</span>() <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>()</span>
<span id="cb1-364"><a href="get-data.html#cb1-364" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_crs</span>(polys) <span class="ot">&lt;-</span> <span class="st">&quot;WGS84&quot;</span></span>
<span id="cb1-365"><a href="get-data.html#cb1-365" aria-hidden="true" tabindex="-1"></a>    polys <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(polys, <span class="st">&quot;NAD83&quot;</span>)</span>
<span id="cb1-366"><a href="get-data.html#cb1-366" aria-hidden="true" tabindex="-1"></a>    cnty_data1 <span class="ot">&lt;&lt;-</span> <span class="fu">cnty_data</span>()</span>
<span id="cb1-367"><a href="get-data.html#cb1-367" aria-hidden="true" tabindex="-1"></a>    v<span class="sc">$</span>selected_cntys <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(<span class="fu">cnty_data</span>(), polys) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(GEOID)</span>
<span id="cb1-368"><a href="get-data.html#cb1-368" aria-hidden="true" tabindex="-1"></a>    check5 <span class="ot">&lt;-</span> v<span class="sc">$</span>selected_cntys</span>
<span id="cb1-369"><a href="get-data.html#cb1-369" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-370"><a href="get-data.html#cb1-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-371"><a href="get-data.html#cb1-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(v<span class="sc">$</span>selected_cntys, {</span>
<span id="cb1-372"><a href="get-data.html#cb1-372" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(<span class="fu">cnty_data</span>())) <span class="fu">return</span>()</span>
<span id="cb1-373"><a href="get-data.html#cb1-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-374"><a href="get-data.html#cb1-374" aria-hidden="true" tabindex="-1"></a>    check1 <span class="ot">&lt;&lt;-</span> <span class="fu">cnty_data</span>()</span>
<span id="cb1-375"><a href="get-data.html#cb1-375" aria-hidden="true" tabindex="-1"></a>    check2 <span class="ot">&lt;&lt;-</span> v<span class="sc">$</span>selected_cntys</span>
<span id="cb1-376"><a href="get-data.html#cb1-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-377"><a href="get-data.html#cb1-377" aria-hidden="true" tabindex="-1"></a>    selected <span class="ot">&lt;&lt;-</span> <span class="fu">subset</span>(<span class="fu">cnty_data</span>(), GEOID <span class="sc">%in%</span> v<span class="sc">$</span>selected_cntys)</span>
<span id="cb1-378"><a href="get-data.html#cb1-378" aria-hidden="true" tabindex="-1"></a>    not_selected <span class="ot">&lt;&lt;-</span> <span class="fu">subset</span>(<span class="fu">cnty_data</span>(), <span class="sc">!</span>(GEOID <span class="sc">%in%</span> v<span class="sc">$</span>selected_cntys))</span>
<span id="cb1-379"><a href="get-data.html#cb1-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-380"><a href="get-data.html#cb1-380" aria-hidden="true" tabindex="-1"></a>    proxy <span class="ot">&lt;-</span> <span class="fu">leafletProxy</span>(<span class="st">&quot;cnty_map&quot;</span>, session)</span>
<span id="cb1-381"><a href="get-data.html#cb1-381" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(selected) <span class="sc">&gt;</span> <span class="dv">0</span>) {proxy <span class="sc">%&gt;%</span></span>
<span id="cb1-382"><a href="get-data.html#cb1-382" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addPolygons</span>(</span>
<span id="cb1-383"><a href="get-data.html#cb1-383" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> selected,</span>
<span id="cb1-384"><a href="get-data.html#cb1-384" aria-hidden="true" tabindex="-1"></a>          <span class="at">fillColor =</span> <span class="st">&quot;blue&quot;</span>,</span>
<span id="cb1-385"><a href="get-data.html#cb1-385" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb1-386"><a href="get-data.html#cb1-386" aria-hidden="true" tabindex="-1"></a>          <span class="at">label =</span> <span class="sc">~</span>selected<span class="sc">$</span>NAME,</span>
<span id="cb1-387"><a href="get-data.html#cb1-387" aria-hidden="true" tabindex="-1"></a>          <span class="at">layerId =</span> <span class="sc">~</span><span class="fu">paste</span>(selected<span class="sc">$</span>GEOID, <span class="st">&quot;selected&quot;</span>),</span>
<span id="cb1-388"><a href="get-data.html#cb1-388" aria-hidden="true" tabindex="-1"></a>          <span class="at">options =</span> <span class="fu">pathOptions</span>(<span class="at">pane =</span> <span class="st">&quot;base_cntys&quot;</span>)</span>
<span id="cb1-389"><a href="get-data.html#cb1-389" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1-390"><a href="get-data.html#cb1-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-391"><a href="get-data.html#cb1-391" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-392"><a href="get-data.html#cb1-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-393"><a href="get-data.html#cb1-393" aria-hidden="true" tabindex="-1"></a>    proxy <span class="sc">%&gt;%</span> <span class="fu">removeShape</span>(<span class="at">layerId =</span> <span class="fu">paste</span>(not_selected<span class="sc">$</span>GEOID, <span class="st">&quot;selected&quot;</span>))</span>
<span id="cb1-394"><a href="get-data.html#cb1-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-395"><a href="get-data.html#cb1-395" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updatePickerInput</span>(<span class="at">session =</span> session, <span class="at">inputId =</span> <span class="st">&quot;cntys&quot;</span>,</span>
<span id="cb1-396"><a href="get-data.html#cb1-396" aria-hidden="true" tabindex="-1"></a>                      <span class="at">choices =</span> <span class="fu">cnty_data</span>()<span class="sc">$</span>GEOID <span class="sc">%&gt;%</span> <span class="fu">setNames</span>(<span class="fu">paste0</span>(<span class="fu">cnty_data</span>()<span class="sc">$</span>GEOID, <span class="st">&quot;: &quot;</span>, <span class="fu">cnty_data</span>()<span class="sc">$</span>NAME)),</span>
<span id="cb1-397"><a href="get-data.html#cb1-397" aria-hidden="true" tabindex="-1"></a>                      <span class="at">selected =</span> v<span class="sc">$</span>selected_cntys)</span>
<span id="cb1-398"><a href="get-data.html#cb1-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-399"><a href="get-data.html#cb1-399" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">ignoreNULL =</span> F)</span>
<span id="cb1-400"><a href="get-data.html#cb1-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-401"><a href="get-data.html#cb1-401" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-402"><a href="get-data.html#cb1-402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>site_select, v<span class="sc">$</span>selected_sites <span class="ot">&lt;-</span> input<span class="sc">$</span>site_select, <span class="at">ignoreNULL =</span> F)</span>
<span id="cb1-403"><a href="get-data.html#cb1-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-404"><a href="get-data.html#cb1-404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(<span class="fu">list</span>(input<span class="sc">$</span>by_state, input<span class="sc">$</span>by_county, input<span class="sc">$</span>by_site), {</span>
<span id="cb1-405"><a href="get-data.html#cb1-405" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-406"><a href="get-data.html#cb1-406" aria-hidden="true" tabindex="-1"></a>    v<span class="sc">$</span>state_polys <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-407"><a href="get-data.html#cb1-407" aria-hidden="true" tabindex="-1"></a>    v<span class="sc">$</span>selected_cntys <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-408"><a href="get-data.html#cb1-408" aria-hidden="true" tabindex="-1"></a>    v<span class="sc">$</span>selected_sites <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-409"><a href="get-data.html#cb1-409" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(input<span class="sc">$</span>by_state <span class="sc">|</span> input<span class="sc">$</span>by_county <span class="sc">|</span> input<span class="sc">$</span>by_site) {</span>
<span id="cb1-410"><a href="get-data.html#cb1-410" aria-hidden="true" tabindex="-1"></a>      <span class="fu">hide</span>(<span class="at">selector =</span> <span class="st">&quot;#navBar li a[data-value=panel2]&quot;</span>)</span>
<span id="cb1-411"><a href="get-data.html#cb1-411" aria-hidden="true" tabindex="-1"></a>      shinyjs<span class="sc">::</span><span class="fu">show</span>(<span class="at">selector =</span> <span class="st">&quot;#navBar li a[data-value=panel3]&quot;</span>)</span>
<span id="cb1-412"><a href="get-data.html#cb1-412" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateNavbarPage</span>(session, <span class="st">&quot;navBar&quot;</span>, <span class="at">selected=</span><span class="st">&quot;panel3&quot;</span>)</span>
<span id="cb1-413"><a href="get-data.html#cb1-413" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-414"><a href="get-data.html#cb1-414" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-415"><a href="get-data.html#cb1-415" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">priority =</span> <span class="sc">-</span><span class="dv">2</span>)</span>
<span id="cb1-416"><a href="get-data.html#cb1-416" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-417"><a href="get-data.html#cb1-417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(<span class="fu">req</span>(input<span class="sc">$</span>select_cnty), {</span>
<span id="cb1-418"><a href="get-data.html#cb1-418" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updatePickerInput</span>(<span class="at">session =</span> session, <span class="at">inputId =</span> <span class="st">&quot;cntys&quot;</span>,</span>
<span id="cb1-419"><a href="get-data.html#cb1-419" aria-hidden="true" tabindex="-1"></a>                      <span class="at">choices =</span> <span class="fu">cnty_data</span>()<span class="sc">$</span>GEOID <span class="sc">%&gt;%</span> <span class="fu">setNames</span>(<span class="fu">paste0</span>(<span class="fu">cnty_data</span>()<span class="sc">$</span>GEOID, <span class="st">&quot;: &quot;</span>, <span class="fu">cnty_data</span>()<span class="sc">$</span>NAME)),</span>
<span id="cb1-420"><a href="get-data.html#cb1-420" aria-hidden="true" tabindex="-1"></a>                      <span class="at">selected =</span> <span class="cn">NULL</span>)</span>
<span id="cb1-421"><a href="get-data.html#cb1-421" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hide</span>(<span class="at">selector =</span> <span class="st">&quot;#navBar li a[data-value=panel3]&quot;</span>)</span>
<span id="cb1-422"><a href="get-data.html#cb1-422" aria-hidden="true" tabindex="-1"></a>    shinyjs<span class="sc">::</span><span class="fu">show</span>(<span class="at">selector =</span> <span class="st">&quot;#navBar li a[data-value=panel4]&quot;</span>)</span>
<span id="cb1-423"><a href="get-data.html#cb1-423" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateNavbarPage</span>(session, <span class="st">&quot;navBar&quot;</span>, <span class="at">selected=</span><span class="st">&quot;panel4&quot;</span>)</span>
<span id="cb1-424"><a href="get-data.html#cb1-424" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-425"><a href="get-data.html#cb1-425" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-426"><a href="get-data.html#cb1-426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(<span class="fu">req</span>(input<span class="sc">$</span>next_map), {</span>
<span id="cb1-427"><a href="get-data.html#cb1-427" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updatePickerInput</span>(<span class="at">session =</span> session, <span class="at">inputId =</span> <span class="st">&quot;site_select&quot;</span>,</span>
<span id="cb1-428"><a href="get-data.html#cb1-428" aria-hidden="true" tabindex="-1"></a>                      <span class="at">choices =</span> <span class="fu">site_list</span>()<span class="sc">$</span>siteid <span class="sc">%&gt;%</span> <span class="fu">setNames</span>(<span class="fu">paste0</span>(<span class="fu">site_list</span>()<span class="sc">$</span>siteid, <span class="st">&quot;: &quot;</span>, <span class="fu">site_list</span>()<span class="sc">$</span>local_site_name)),</span>
<span id="cb1-429"><a href="get-data.html#cb1-429" aria-hidden="true" tabindex="-1"></a>                      <span class="at">selected =</span> <span class="cn">NULL</span>)</span>
<span id="cb1-430"><a href="get-data.html#cb1-430" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hide</span>(<span class="at">selector =</span> <span class="st">&quot;#navBar li a[data-value=panel3]&quot;</span>)</span>
<span id="cb1-431"><a href="get-data.html#cb1-431" aria-hidden="true" tabindex="-1"></a>    shinyjs<span class="sc">::</span><span class="fu">show</span>(<span class="at">selector =</span> <span class="st">&quot;#navBar li a[data-value=panel5]&quot;</span>)</span>
<span id="cb1-432"><a href="get-data.html#cb1-432" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateNavbarPage</span>(session, <span class="st">&quot;navBar&quot;</span>, <span class="at">selected=</span><span class="st">&quot;panel5&quot;</span>)</span>
<span id="cb1-433"><a href="get-data.html#cb1-433" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-434"><a href="get-data.html#cb1-434" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-435"><a href="get-data.html#cb1-435" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-436"><a href="get-data.html#cb1-436" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb1-437"><a href="get-data.html#cb1-437" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-438"><a href="get-data.html#cb1-438" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>parm_class, v<span class="sc">$</span>selected_classes <span class="ot">&lt;-</span> input<span class="sc">$</span>parm_class, <span class="at">ignoreNULL =</span> T)</span>
<span id="cb1-439"><a href="get-data.html#cb1-439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>parms, v<span class="sc">$</span>selected_parms <span class="ot">&lt;-</span> input<span class="sc">$</span>parms, <span class="at">ignoreNULL =</span> F)</span>
<span id="cb1-440"><a href="get-data.html#cb1-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>date_range, v<span class="sc">$</span>selected_dates <span class="ot">&lt;-</span> input<span class="sc">$</span>date_range, <span class="at">ignoreNULL =</span> T)</span>
<span id="cb1-441"><a href="get-data.html#cb1-441" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-442"><a href="get-data.html#cb1-442" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-443"><a href="get-data.html#cb1-443" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-444"><a href="get-data.html#cb1-444" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-445"><a href="get-data.html#cb1-445" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-446"><a href="get-data.html#cb1-446" aria-hidden="true" tabindex="-1"></a>  class_list <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb1-447"><a href="get-data.html#cb1-447" aria-hidden="true" tabindex="-1"></a>    shiny<span class="sc">::</span><span class="fu">validate</span>(<span class="fu">need</span>(input<span class="sc">$</span>auth, <span class="st">&quot;connect&quot;</span>))</span>
<span id="cb1-448"><a href="get-data.html#cb1-448" aria-hidden="true" tabindex="-1"></a>    <span class="fu">isolate</span>({</span>
<span id="cb1-449"><a href="get-data.html#cb1-449" aria-hidden="true" tabindex="-1"></a>      json_parameter_classes <span class="ot">=</span> <span class="fu">rawToChar</span>(<span class="fu">GET</span>(</span>
<span id="cb1-450"><a href="get-data.html#cb1-450" aria-hidden="true" tabindex="-1"></a>        <span class="fu">glue</span>(</span>
<span id="cb1-451"><a href="get-data.html#cb1-451" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;https://aqs.epa.gov/data/api/list/classes?email={input$email}&amp;key={input$key}&quot;</span></span>
<span id="cb1-452"><a href="get-data.html#cb1-452" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb1-453"><a href="get-data.html#cb1-453" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-454"><a href="get-data.html#cb1-454" aria-hidden="true" tabindex="-1"></a>        <span class="at">encode =</span> <span class="st">&quot;json&quot;</span></span>
<span id="cb1-455"><a href="get-data.html#cb1-455" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-456"><a href="get-data.html#cb1-456" aria-hidden="true" tabindex="-1"></a>      )<span class="sc">$</span>content)</span>
<span id="cb1-457"><a href="get-data.html#cb1-457" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-458"><a href="get-data.html#cb1-458" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-459"><a href="get-data.html#cb1-459" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-460"><a href="get-data.html#cb1-460" aria-hidden="true" tabindex="-1"></a>      classes <span class="ot">=</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">str_detect</span>(json_parameter_classes, <span class="st">&#39;</span><span class="sc">\\</span><span class="st">&quot;status</span><span class="sc">\\</span><span class="st">&quot;: </span><span class="sc">\\</span><span class="st">&quot;Success</span><span class="sc">\\</span><span class="st">&quot;&#39;</span>))</span>
<span id="cb1-461"><a href="get-data.html#cb1-461" aria-hidden="true" tabindex="-1"></a>        <span class="cn">NULL</span> <span class="cf">else</span></span>
<span id="cb1-462"><a href="get-data.html#cb1-462" aria-hidden="true" tabindex="-1"></a>          <span class="fu">fromJSON</span>(json_parameter_classes, <span class="at">simplifyDataFrame =</span> T)<span class="sc">$</span>Data <span class="sc">%&gt;%</span></span>
<span id="cb1-463"><a href="get-data.html#cb1-463" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setDT</span>()</span>
<span id="cb1-464"><a href="get-data.html#cb1-464" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb1-465"><a href="get-data.html#cb1-465" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-466"><a href="get-data.html#cb1-466" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-467"><a href="get-data.html#cb1-467" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-468"><a href="get-data.html#cb1-468" aria-hidden="true" tabindex="-1"></a>  parameter_list <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb1-469"><a href="get-data.html#cb1-469" aria-hidden="true" tabindex="-1"></a>    shiny<span class="sc">::</span><span class="fu">validate</span>(<span class="fu">need</span>(<span class="fu">class_list</span>(), <span class="at">label =</span> <span class="st">&quot;class_list&quot;</span>),</span>
<span id="cb1-470"><a href="get-data.html#cb1-470" aria-hidden="true" tabindex="-1"></a>             <span class="fu">need</span>(v<span class="sc">$</span>selected_classes, <span class="at">label =</span> <span class="st">&quot;parameter_class&quot;</span>))</span>
<span id="cb1-471"><a href="get-data.html#cb1-471" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(v<span class="sc">$</span>selected_classes)) <span class="fu">return</span>()</span>
<span id="cb1-472"><a href="get-data.html#cb1-472" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-473"><a href="get-data.html#cb1-473" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-474"><a href="get-data.html#cb1-474" aria-hidden="true" tabindex="-1"></a>    check <span class="ot">&lt;&lt;-</span> v<span class="sc">$</span>selected_classes</span>
<span id="cb1-475"><a href="get-data.html#cb1-475" aria-hidden="true" tabindex="-1"></a>    <span class="fu">isolate</span>({</span>
<span id="cb1-476"><a href="get-data.html#cb1-476" aria-hidden="true" tabindex="-1"></a>      json_parameters <span class="ot">=</span> <span class="fu">rawToChar</span>(<span class="fu">GET</span>(</span>
<span id="cb1-477"><a href="get-data.html#cb1-477" aria-hidden="true" tabindex="-1"></a>        <span class="fu">glue</span>(</span>
<span id="cb1-478"><a href="get-data.html#cb1-478" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;https://aqs.epa.gov/data/api/list/parametersByClass?email={input$email}&amp;key={input$key}&amp;pc={v$selected_classes}&quot;</span></span>
<span id="cb1-479"><a href="get-data.html#cb1-479" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb1-480"><a href="get-data.html#cb1-480" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-481"><a href="get-data.html#cb1-481" aria-hidden="true" tabindex="-1"></a>        <span class="at">encode =</span> <span class="st">&quot;json&quot;</span></span>
<span id="cb1-482"><a href="get-data.html#cb1-482" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-483"><a href="get-data.html#cb1-483" aria-hidden="true" tabindex="-1"></a>      )<span class="sc">$</span>content)</span>
<span id="cb1-484"><a href="get-data.html#cb1-484" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-485"><a href="get-data.html#cb1-485" aria-hidden="true" tabindex="-1"></a>      params <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">str_detect</span>(json_parameters, <span class="st">&#39;</span><span class="sc">\\</span><span class="st">&quot;status</span><span class="sc">\\</span><span class="st">&quot;: </span><span class="sc">\\</span><span class="st">&quot;Success</span><span class="sc">\\</span><span class="st">&quot;&#39;</span>))</span>
<span id="cb1-486"><a href="get-data.html#cb1-486" aria-hidden="true" tabindex="-1"></a>        <span class="cn">NULL</span> <span class="cf">else</span></span>
<span id="cb1-487"><a href="get-data.html#cb1-487" aria-hidden="true" tabindex="-1"></a>          <span class="fu">fromJSON</span>(json_parameters, <span class="at">simplifyDataFrame =</span> T)<span class="sc">$</span>Data <span class="sc">%&gt;%</span></span>
<span id="cb1-488"><a href="get-data.html#cb1-488" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setDT</span>()</span>
<span id="cb1-489"><a href="get-data.html#cb1-489" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb1-490"><a href="get-data.html#cb1-490" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-491"><a href="get-data.html#cb1-491" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-492"><a href="get-data.html#cb1-492" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-493"><a href="get-data.html#cb1-493" aria-hidden="true" tabindex="-1"></a>  state_calls <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb1-494"><a href="get-data.html#cb1-494" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-495"><a href="get-data.html#cb1-495" aria-hidden="true" tabindex="-1"></a>    shiny<span class="sc">::</span><span class="fu">validate</span>(</span>
<span id="cb1-496"><a href="get-data.html#cb1-496" aria-hidden="true" tabindex="-1"></a>      <span class="fu">need</span>(v<span class="sc">$</span>selected_states, <span class="at">label =</span> <span class="st">&quot;State(s)&quot;</span>),</span>
<span id="cb1-497"><a href="get-data.html#cb1-497" aria-hidden="true" tabindex="-1"></a>      <span class="fu">need</span>(v<span class="sc">$</span>selected_parms, <span class="at">label =</span> <span class="st">&quot;Parameter(s)&quot;</span>),</span>
<span id="cb1-498"><a href="get-data.html#cb1-498" aria-hidden="true" tabindex="-1"></a>      <span class="fu">need</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">1</span>]], <span class="at">label =</span> <span class="st">&quot;Start date&quot;</span>),</span>
<span id="cb1-499"><a href="get-data.html#cb1-499" aria-hidden="true" tabindex="-1"></a>      <span class="fu">need</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">2</span>]], <span class="at">label =</span> <span class="st">&quot;End date&quot;</span>)</span>
<span id="cb1-500"><a href="get-data.html#cb1-500" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-501"><a href="get-data.html#cb1-501" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-502"><a href="get-data.html#cb1-502" aria-hidden="true" tabindex="-1"></a>    years <span class="ot">&lt;-</span> <span class="fu">year</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">1</span>]]) <span class="sc">:</span> <span class="fu">year</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">2</span>]])</span>
<span id="cb1-503"><a href="get-data.html#cb1-503" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-504"><a href="get-data.html#cb1-504" aria-hidden="true" tabindex="-1"></a>    state_call_table <span class="ot">&lt;&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb1-505"><a href="get-data.html#cb1-505" aria-hidden="true" tabindex="-1"></a>      <span class="at">parm =</span> v<span class="sc">$</span>selected_parms,</span>
<span id="cb1-506"><a href="get-data.html#cb1-506" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb1-507"><a href="get-data.html#cb1-507" aria-hidden="true" tabindex="-1"></a>        <span class="at">bdate =</span> <span class="fu">pmax</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">1</span>]], <span class="fu">ymd</span>(<span class="fu">paste</span>(years, <span class="st">&quot;0101&quot;</span>))),</span>
<span id="cb1-508"><a href="get-data.html#cb1-508" aria-hidden="true" tabindex="-1"></a>        <span class="at">edate =</span> <span class="fu">pmin</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">2</span>]], <span class="fu">ymd</span>(<span class="fu">paste</span>(years, <span class="st">&quot;1231&quot;</span>)))</span>
<span id="cb1-509"><a href="get-data.html#cb1-509" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> <span class="fu">mutate_all</span>(<span class="sc">~</span><span class="fu">str_replace_all</span>(., <span class="st">&quot;-&quot;</span>, <span class="st">&quot;&quot;</span>)),</span>
<span id="cb1-510"><a href="get-data.html#cb1-510" aria-hidden="true" tabindex="-1"></a>      <span class="at">state =</span> v<span class="sc">$</span>selected_states</span>
<span id="cb1-511"><a href="get-data.html#cb1-511" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> <span class="fu">setDT</span>()</span>
<span id="cb1-512"><a href="get-data.html#cb1-512" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-513"><a href="get-data.html#cb1-513" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-514"><a href="get-data.html#cb1-514" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-515"><a href="get-data.html#cb1-515" aria-hidden="true" tabindex="-1"></a>  monitor_list <span class="ot">&lt;-</span> <span class="fu">reactive</span>({</span>
<span id="cb1-516"><a href="get-data.html#cb1-516" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-517"><a href="get-data.html#cb1-517" aria-hidden="true" tabindex="-1"></a>    next_map <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">is.null</span>(input<span class="sc">$</span>next_map)) <span class="dv">0</span> <span class="cf">else</span> input<span class="sc">$</span>next_map</span>
<span id="cb1-518"><a href="get-data.html#cb1-518" aria-hidden="true" tabindex="-1"></a>    get_data <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">is.null</span>(input<span class="sc">$</span>get_data)) <span class="dv">0</span> <span class="cf">else</span> input<span class="sc">$</span>get_data</span>
<span id="cb1-519"><a href="get-data.html#cb1-519" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-520"><a href="get-data.html#cb1-520" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span>(next_map <span class="sc">|</span> get_data)) <span class="fu">return</span>()</span>
<span id="cb1-521"><a href="get-data.html#cb1-521" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-522"><a href="get-data.html#cb1-522" aria-hidden="true" tabindex="-1"></a>    <span class="fu">isolate</span>({</span>
<span id="cb1-523"><a href="get-data.html#cb1-523" aria-hidden="true" tabindex="-1"></a>      shiny<span class="sc">::</span><span class="fu">validate</span>(<span class="fu">need</span>(<span class="fu">state_calls</span>(), <span class="at">label =</span> <span class="st">&quot;state_calls&quot;</span>))</span>
<span id="cb1-524"><a href="get-data.html#cb1-524" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-525"><a href="get-data.html#cb1-525" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-526"><a href="get-data.html#cb1-526" aria-hidden="true" tabindex="-1"></a>      outcomes <span class="ot">&lt;-</span> <span class="fu">state_calls</span>()[, .(<span class="at">success =</span> {</span>
<span id="cb1-527"><a href="get-data.html#cb1-527" aria-hidden="true" tabindex="-1"></a>        json_text <span class="ot">&lt;&lt;-</span> <span class="fu">rawToChar</span>(<span class="fu">GET</span>(</span>
<span id="cb1-528"><a href="get-data.html#cb1-528" aria-hidden="true" tabindex="-1"></a>          <span class="fu">glue</span>(</span>
<span id="cb1-529"><a href="get-data.html#cb1-529" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;https://aqs.epa.gov/data/api/monitors/byState?email={input$email}&amp;key={input$key}&amp;param={.BY[[1]]}&amp;bdate={.BY[[2]]}&amp;edate={.BY[[3]]}&amp;state={.BY[[4]]}&quot;</span></span>
<span id="cb1-530"><a href="get-data.html#cb1-530" aria-hidden="true" tabindex="-1"></a>          ),</span>
<span id="cb1-531"><a href="get-data.html#cb1-531" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-532"><a href="get-data.html#cb1-532" aria-hidden="true" tabindex="-1"></a>          <span class="at">encode =</span> <span class="st">&quot;json&quot;</span></span>
<span id="cb1-533"><a href="get-data.html#cb1-533" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-534"><a href="get-data.html#cb1-534" aria-hidden="true" tabindex="-1"></a>        )<span class="sc">$</span>content)</span>
<span id="cb1-535"><a href="get-data.html#cb1-535" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-536"><a href="get-data.html#cb1-536" aria-hidden="true" tabindex="-1"></a>      }), by <span class="ot">=</span> .(parm, bdate, edate, state)]</span>
<span id="cb1-537"><a href="get-data.html#cb1-537" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-538"><a href="get-data.html#cb1-538" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-539"><a href="get-data.html#cb1-539" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-540"><a href="get-data.html#cb1-540" aria-hidden="true" tabindex="-1"></a>      monitors <span class="ot">&lt;&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(outcomes<span class="sc">$</span>success, <span class="sc">~</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(.x, <span class="st">&#39;</span><span class="sc">\\</span><span class="st">&quot;status</span><span class="sc">\\</span><span class="st">&quot;: </span><span class="sc">\\</span><span class="st">&quot;Success</span><span class="sc">\\</span><span class="st">&quot;&#39;</span>))</span>
<span id="cb1-541"><a href="get-data.html#cb1-541" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fromJSON</span>(.x)<span class="sc">$</span>Data <span class="cf">else</span></span>
<span id="cb1-542"><a href="get-data.html#cb1-542" aria-hidden="true" tabindex="-1"></a>          <span class="cn">NULL</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-543"><a href="get-data.html#cb1-543" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rbindlist</span>(<span class="at">fill =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb1-544"><a href="get-data.html#cb1-544" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unique</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-545"><a href="get-data.html#cb1-545" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setkey</span>()</span>
<span id="cb1-546"><a href="get-data.html#cb1-546" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-547"><a href="get-data.html#cb1-547" aria-hidden="true" tabindex="-1"></a>      monitors[, siteid <span class="sc">:</span><span class="er">=</span> <span class="fu">paste</span>(state_code, county_code, site_number, <span class="at">sep =</span> <span class="st">&quot;-&quot;</span>)]</span>
<span id="cb1-548"><a href="get-data.html#cb1-548" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb1-549"><a href="get-data.html#cb1-549" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-550"><a href="get-data.html#cb1-550" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-551"><a href="get-data.html#cb1-551" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-552"><a href="get-data.html#cb1-552" aria-hidden="true" tabindex="-1"></a>  site_list <span class="ot">&lt;-</span><span class="fu">reactive</span>({</span>
<span id="cb1-553"><a href="get-data.html#cb1-553" aria-hidden="true" tabindex="-1"></a>    shiny<span class="sc">::</span><span class="fu">validate</span>(<span class="fu">need</span>(<span class="fu">monitor_list</span>(), <span class="st">&quot;monitor_list&quot;</span>))</span>
<span id="cb1-554"><a href="get-data.html#cb1-554" aria-hidden="true" tabindex="-1"></a>    <span class="fu">monitor_list</span>()[, .SD[<span class="dv">1</span>], by <span class="ot">=</span> siteid]</span>
<span id="cb1-555"><a href="get-data.html#cb1-555" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-556"><a href="get-data.html#cb1-556" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-557"><a href="get-data.html#cb1-557" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(<span class="fu">list</span>(input<span class="sc">$</span>get_data, input<span class="sc">$</span>get_data2, input<span class="sc">$</span>get_data3), {</span>
<span id="cb1-558"><a href="get-data.html#cb1-558" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-559"><a href="get-data.html#cb1-559" aria-hidden="true" tabindex="-1"></a>    shiny<span class="sc">::</span><span class="fu">validate</span>(<span class="fu">need</span>(input<span class="sc">$</span>service, <span class="at">label =</span> <span class="st">&quot;service&quot;</span>),</span>
<span id="cb1-560"><a href="get-data.html#cb1-560" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">need</span>(<span class="fu">state_calls</span>(), <span class="at">label =</span> <span class="st">&quot;state_calls&quot;</span>),</span>
<span id="cb1-561"><a href="get-data.html#cb1-561" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">need</span>(v<span class="sc">$</span>selected_parms, <span class="at">label =</span> <span class="st">&quot;Parameter(s)&quot;</span>),</span>
<span id="cb1-562"><a href="get-data.html#cb1-562" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">need</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">1</span>]], <span class="at">label =</span> <span class="st">&quot;Start date&quot;</span>),</span>
<span id="cb1-563"><a href="get-data.html#cb1-563" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">need</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">2</span>]], <span class="at">label =</span> <span class="st">&quot;End date&quot;</span>),</span>
<span id="cb1-564"><a href="get-data.html#cb1-564" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">need</span>(<span class="fu">site_list</span>(), <span class="at">label =</span> <span class="st">&quot;site_list&quot;</span>)</span>
<span id="cb1-565"><a href="get-data.html#cb1-565" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-566"><a href="get-data.html#cb1-566" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-567"><a href="get-data.html#cb1-567" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-568"><a href="get-data.html#cb1-568" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(v<span class="sc">$</span>geo_select <span class="sc">==</span> <span class="st">&quot;State&quot;</span>) {</span>
<span id="cb1-569"><a href="get-data.html#cb1-569" aria-hidden="true" tabindex="-1"></a>      outcomes <span class="ot">&lt;-</span> <span class="fu">state_calls</span>()[, .(<span class="at">success =</span> {</span>
<span id="cb1-570"><a href="get-data.html#cb1-570" aria-hidden="true" tabindex="-1"></a>        json_text <span class="ot">&lt;&lt;-</span> <span class="fu">rawToChar</span>(<span class="fu">GET</span>(</span>
<span id="cb1-571"><a href="get-data.html#cb1-571" aria-hidden="true" tabindex="-1"></a>          <span class="fu">glue</span>(</span>
<span id="cb1-572"><a href="get-data.html#cb1-572" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;https://aqs.epa.gov/data/api/{input$service}/by{v$geo_select}?email={input$email}&amp;key={input$key}&amp;param={.BY[[1]]}&amp;bdate={.BY[[2]]}&amp;edate={.BY[[3]]}&amp;state={.BY[[4]]}&quot;</span></span>
<span id="cb1-573"><a href="get-data.html#cb1-573" aria-hidden="true" tabindex="-1"></a>          ),</span>
<span id="cb1-574"><a href="get-data.html#cb1-574" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-575"><a href="get-data.html#cb1-575" aria-hidden="true" tabindex="-1"></a>          <span class="at">encode =</span> <span class="st">&quot;json&quot;</span></span>
<span id="cb1-576"><a href="get-data.html#cb1-576" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-577"><a href="get-data.html#cb1-577" aria-hidden="true" tabindex="-1"></a>        )<span class="sc">$</span>content)</span>
<span id="cb1-578"><a href="get-data.html#cb1-578" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-579"><a href="get-data.html#cb1-579" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-580"><a href="get-data.html#cb1-580" aria-hidden="true" tabindex="-1"></a>      ), by <span class="ot">=</span> .(parm, bdate, edate, state)]</span>
<span id="cb1-581"><a href="get-data.html#cb1-581" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-582"><a href="get-data.html#cb1-582" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-583"><a href="get-data.html#cb1-583" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-584"><a href="get-data.html#cb1-584" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(v<span class="sc">$</span>geo_select <span class="sc">==</span> <span class="st">&quot;County&quot;</span>) {</span>
<span id="cb1-585"><a href="get-data.html#cb1-585" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-586"><a href="get-data.html#cb1-586" aria-hidden="true" tabindex="-1"></a>      shiny<span class="sc">::</span><span class="fu">validate</span>(<span class="fu">need</span>(v<span class="sc">$</span>selected_cntys, <span class="at">label =</span> <span class="st">&quot;Counties&quot;</span>))</span>
<span id="cb1-587"><a href="get-data.html#cb1-587" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-588"><a href="get-data.html#cb1-588" aria-hidden="true" tabindex="-1"></a>      years <span class="ot">&lt;-</span> <span class="fu">year</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">1</span>]]) <span class="sc">:</span> <span class="fu">year</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">2</span>]])</span>
<span id="cb1-589"><a href="get-data.html#cb1-589" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-590"><a href="get-data.html#cb1-590" aria-hidden="true" tabindex="-1"></a>      cnty_call_table <span class="ot">&lt;&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb1-591"><a href="get-data.html#cb1-591" aria-hidden="true" tabindex="-1"></a>        <span class="at">parm =</span> v<span class="sc">$</span>selected_parms,</span>
<span id="cb1-592"><a href="get-data.html#cb1-592" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(</span>
<span id="cb1-593"><a href="get-data.html#cb1-593" aria-hidden="true" tabindex="-1"></a>          <span class="at">state =</span> <span class="fu">str_sub</span>(v<span class="sc">$</span>selected_cntys, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb1-594"><a href="get-data.html#cb1-594" aria-hidden="true" tabindex="-1"></a>          <span class="at">county =</span> <span class="fu">str_sub</span>(v<span class="sc">$</span>selected_cntys, <span class="dv">3</span>, <span class="dv">5</span>)</span>
<span id="cb1-595"><a href="get-data.html#cb1-595" aria-hidden="true" tabindex="-1"></a>          ),</span>
<span id="cb1-596"><a href="get-data.html#cb1-596" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(</span>
<span id="cb1-597"><a href="get-data.html#cb1-597" aria-hidden="true" tabindex="-1"></a>          <span class="at">bdate =</span> <span class="fu">pmax</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">1</span>]], <span class="fu">ymd</span>(<span class="fu">paste</span>(years, <span class="st">&quot;0101&quot;</span>))),</span>
<span id="cb1-598"><a href="get-data.html#cb1-598" aria-hidden="true" tabindex="-1"></a>          <span class="at">edate =</span> <span class="fu">pmin</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">2</span>]], <span class="fu">ymd</span>(<span class="fu">paste</span>(years, <span class="st">&quot;1231&quot;</span>)))</span>
<span id="cb1-599"><a href="get-data.html#cb1-599" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb1-600"><a href="get-data.html#cb1-600" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate_all</span>(<span class="sc">~</span><span class="fu">str_remove_all</span>(., <span class="st">&quot;-&quot;</span>))</span>
<span id="cb1-601"><a href="get-data.html#cb1-601" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb1-602"><a href="get-data.html#cb1-602" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setDT</span>()</span>
<span id="cb1-603"><a href="get-data.html#cb1-603" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-604"><a href="get-data.html#cb1-604" aria-hidden="true" tabindex="-1"></a>      outcomes <span class="ot">&lt;-</span> cnty_call_table[, .(<span class="at">success =</span> {</span>
<span id="cb1-605"><a href="get-data.html#cb1-605" aria-hidden="true" tabindex="-1"></a>        json_text <span class="ot">&lt;&lt;-</span> <span class="fu">rawToChar</span>(<span class="fu">GET</span>(</span>
<span id="cb1-606"><a href="get-data.html#cb1-606" aria-hidden="true" tabindex="-1"></a>          <span class="fu">glue</span>(</span>
<span id="cb1-607"><a href="get-data.html#cb1-607" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;https://aqs.epa.gov/data/api/{input$service}/by{v$geo_select}?email={input$email}&amp;key={input$key}&amp;param={.BY[[1]]}&amp;bdate={.BY[[2]]}&amp;edate={.BY[[3]]}&amp;state={.BY[[4]]}&amp;county={.BY[[5]]}&amp;site={.BY[[6]]}&quot;</span></span>
<span id="cb1-608"><a href="get-data.html#cb1-608" aria-hidden="true" tabindex="-1"></a>          ),</span>
<span id="cb1-609"><a href="get-data.html#cb1-609" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-610"><a href="get-data.html#cb1-610" aria-hidden="true" tabindex="-1"></a>          <span class="at">encode =</span> <span class="st">&quot;json&quot;</span></span>
<span id="cb1-611"><a href="get-data.html#cb1-611" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-612"><a href="get-data.html#cb1-612" aria-hidden="true" tabindex="-1"></a>        )<span class="sc">$</span>content)</span>
<span id="cb1-613"><a href="get-data.html#cb1-613" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-614"><a href="get-data.html#cb1-614" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-615"><a href="get-data.html#cb1-615" aria-hidden="true" tabindex="-1"></a>      ), by <span class="ot">=</span> .(parm, bdate, edate, state, county)]</span>
<span id="cb1-616"><a href="get-data.html#cb1-616" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-617"><a href="get-data.html#cb1-617" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-618"><a href="get-data.html#cb1-618" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-619"><a href="get-data.html#cb1-619" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-620"><a href="get-data.html#cb1-620" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(v<span class="sc">$</span>geo_select <span class="sc">==</span> <span class="st">&quot;Site&quot;</span>) {</span>
<span id="cb1-621"><a href="get-data.html#cb1-621" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-622"><a href="get-data.html#cb1-622" aria-hidden="true" tabindex="-1"></a>      shiny<span class="sc">::</span><span class="fu">validate</span>(<span class="fu">need</span>(<span class="fu">monitor_list</span>(), <span class="at">label =</span> <span class="st">&quot;monitor_list&quot;</span>),</span>
<span id="cb1-623"><a href="get-data.html#cb1-623" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">need</span>(v<span class="sc">$</span>selected_sites, <span class="at">label =</span> <span class="st">&quot;Site(s)&quot;</span>)</span>
<span id="cb1-624"><a href="get-data.html#cb1-624" aria-hidden="true" tabindex="-1"></a>                      )</span>
<span id="cb1-625"><a href="get-data.html#cb1-625" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-626"><a href="get-data.html#cb1-626" aria-hidden="true" tabindex="-1"></a>      years <span class="ot">&lt;-</span> <span class="fu">year</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">1</span>]]) <span class="sc">:</span> <span class="fu">year</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">2</span>]])</span>
<span id="cb1-627"><a href="get-data.html#cb1-627" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-628"><a href="get-data.html#cb1-628" aria-hidden="true" tabindex="-1"></a>      site_call_table <span class="ot">&lt;&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb1-629"><a href="get-data.html#cb1-629" aria-hidden="true" tabindex="-1"></a>        <span class="fu">distinct</span>(<span class="fu">monitor_list</span>()[siteid <span class="sc">%in%</span> v<span class="sc">$</span>selected_sites, .(</span>
<span id="cb1-630"><a href="get-data.html#cb1-630" aria-hidden="true" tabindex="-1"></a>          <span class="at">parm =</span> parameter_code,</span>
<span id="cb1-631"><a href="get-data.html#cb1-631" aria-hidden="true" tabindex="-1"></a>          <span class="at">state =</span> state_code,</span>
<span id="cb1-632"><a href="get-data.html#cb1-632" aria-hidden="true" tabindex="-1"></a>          <span class="at">county =</span> county_code,</span>
<span id="cb1-633"><a href="get-data.html#cb1-633" aria-hidden="true" tabindex="-1"></a>          <span class="at">site =</span> site_number)]),</span>
<span id="cb1-634"><a href="get-data.html#cb1-634" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(</span>
<span id="cb1-635"><a href="get-data.html#cb1-635" aria-hidden="true" tabindex="-1"></a>          <span class="at">bdate =</span> <span class="fu">pmax</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">1</span>]], <span class="fu">ymd</span>(<span class="fu">paste</span>(years, <span class="st">&quot;0101&quot;</span>))),</span>
<span id="cb1-636"><a href="get-data.html#cb1-636" aria-hidden="true" tabindex="-1"></a>          <span class="at">edate =</span> <span class="fu">pmin</span>(v<span class="sc">$</span>selected_dates[[<span class="dv">2</span>]], <span class="fu">ymd</span>(<span class="fu">paste</span>(years, <span class="st">&quot;1231&quot;</span>)))</span>
<span id="cb1-637"><a href="get-data.html#cb1-637" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb1-638"><a href="get-data.html#cb1-638" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate_all</span>(<span class="sc">~</span><span class="fu">str_replace_all</span>(., <span class="st">&quot;-&quot;</span>, <span class="st">&quot;&quot;</span>))</span>
<span id="cb1-639"><a href="get-data.html#cb1-639" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb1-640"><a href="get-data.html#cb1-640" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setDT</span>()</span>
<span id="cb1-641"><a href="get-data.html#cb1-641" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-642"><a href="get-data.html#cb1-642" aria-hidden="true" tabindex="-1"></a>      outcomes <span class="ot">&lt;-</span> site_call_table[, .(<span class="at">success =</span> {</span>
<span id="cb1-643"><a href="get-data.html#cb1-643" aria-hidden="true" tabindex="-1"></a>        json_text <span class="ot">&lt;&lt;-</span> <span class="fu">rawToChar</span>(<span class="fu">GET</span>(</span>
<span id="cb1-644"><a href="get-data.html#cb1-644" aria-hidden="true" tabindex="-1"></a>          <span class="fu">glue</span>(</span>
<span id="cb1-645"><a href="get-data.html#cb1-645" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;https://aqs.epa.gov/data/api/{input$service}/by{v$geo_select}?email={input$email}&amp;key={input$key}&amp;param={.BY[[1]]}&amp;bdate={.BY[[2]]}&amp;edate={.BY[[3]]}&amp;state={.BY[[4]]}&amp;county={.BY[[5]]}&amp;site={.BY[[6]]}&quot;</span></span>
<span id="cb1-646"><a href="get-data.html#cb1-646" aria-hidden="true" tabindex="-1"></a>          ),</span>
<span id="cb1-647"><a href="get-data.html#cb1-647" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-648"><a href="get-data.html#cb1-648" aria-hidden="true" tabindex="-1"></a>          <span class="at">encode =</span> <span class="st">&quot;json&quot;</span></span>
<span id="cb1-649"><a href="get-data.html#cb1-649" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-650"><a href="get-data.html#cb1-650" aria-hidden="true" tabindex="-1"></a>        )<span class="sc">$</span>content)</span>
<span id="cb1-651"><a href="get-data.html#cb1-651" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-652"><a href="get-data.html#cb1-652" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-653"><a href="get-data.html#cb1-653" aria-hidden="true" tabindex="-1"></a>      ), by <span class="ot">=</span> .(parm, bdate, edate, state, county, site)]</span>
<span id="cb1-654"><a href="get-data.html#cb1-654" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-655"><a href="get-data.html#cb1-655" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-656"><a href="get-data.html#cb1-656" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-657"><a href="get-data.html#cb1-657" aria-hidden="true" tabindex="-1"></a>    raw_data <span class="ot">&lt;&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(outcomes<span class="sc">$</span>success, <span class="sc">~</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(.x, <span class="st">&#39;</span><span class="sc">\\</span><span class="st">&quot;status</span><span class="sc">\\</span><span class="st">&quot;: </span><span class="sc">\\</span><span class="st">&quot;Success</span><span class="sc">\\</span><span class="st">&quot;&#39;</span>))</span>
<span id="cb1-658"><a href="get-data.html#cb1-658" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fromJSON</span>(.x)<span class="sc">$</span>Data <span class="cf">else</span></span>
<span id="cb1-659"><a href="get-data.html#cb1-659" aria-hidden="true" tabindex="-1"></a>        <span class="cn">NULL</span></span>
<span id="cb1-660"><a href="get-data.html#cb1-660" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb1-661"><a href="get-data.html#cb1-661" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rbindlist</span>(<span class="at">fill =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb1-662"><a href="get-data.html#cb1-662" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setkey</span>()</span>
<span id="cb1-663"><a href="get-data.html#cb1-663" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-664"><a href="get-data.html#cb1-664" aria-hidden="true" tabindex="-1"></a>    <span class="fu">req</span>(<span class="sc">!</span><span class="fu">is_empty</span>(raw_data))</span>
<span id="cb1-665"><a href="get-data.html#cb1-665" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-666"><a href="get-data.html#cb1-666" aria-hidden="true" tabindex="-1"></a>    v<span class="sc">$</span>data <span class="ot">&lt;-</span> <span class="fu">left_join</span>(raw_data, dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">monitor_list</span>(), <span class="sc">-</span><span class="fu">c</span>(latitude, longitude, datum, cbsa_code, siteid)),</span>
<span id="cb1-667"><a href="get-data.html#cb1-667" aria-hidden="true" tabindex="-1"></a>                        <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;state_code&quot;</span>, <span class="st">&quot;county_code&quot;</span>, <span class="st">&quot;site_number&quot;</span>, <span class="st">&quot;parameter_code&quot;</span>, <span class="st">&quot;poc&quot;</span>))</span>
<span id="cb1-668"><a href="get-data.html#cb1-668" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-669"><a href="get-data.html#cb1-669" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>, <span class="sc">~</span><span class="fu">hide</span>(<span class="at">selector =</span> <span class="fu">glue</span>(<span class="st">&quot;#navBar li a[data-value=panel{.x}]&quot;</span>)))</span>
<span id="cb1-670"><a href="get-data.html#cb1-670" aria-hidden="true" tabindex="-1"></a>    shinyjs<span class="sc">::</span><span class="fu">show</span>(<span class="at">selector =</span> <span class="st">&quot;#navBar li a[data-value=panel6]&quot;</span>)</span>
<span id="cb1-671"><a href="get-data.html#cb1-671" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateNavbarPage</span>(session, <span class="st">&quot;navBar&quot;</span>, <span class="at">selected=</span><span class="st">&quot;panel6&quot;</span>)</span>
<span id="cb1-672"><a href="get-data.html#cb1-672" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-673"><a href="get-data.html#cb1-673" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-674"><a href="get-data.html#cb1-674" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-675"><a href="get-data.html#cb1-675" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-676"><a href="get-data.html#cb1-676" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observe</span>({</span>
<span id="cb1-677"><a href="get-data.html#cb1-677" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-678"><a href="get-data.html#cb1-678" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>, <span class="sc">~</span><span class="fu">hide</span>(<span class="at">selector =</span> <span class="fu">glue</span>(<span class="st">&quot;#navBar li a[data-value=panel{.x}]&quot;</span>)))</span>
<span id="cb1-679"><a href="get-data.html#cb1-679" aria-hidden="true" tabindex="-1"></a>    <span class="co">#hide(selector = &quot;#navBar li a[data-value=panel2]&quot;)</span></span>
<span id="cb1-680"><a href="get-data.html#cb1-680" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hide</span>(<span class="at">selector =</span> <span class="st">&quot;#navBar&quot;</span>)</span>
<span id="cb1-681"><a href="get-data.html#cb1-681" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toggle</span>(<span class="st">&quot;by_state&quot;</span>, <span class="at">condition =</span> <span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">state_list</span>()))</span>
<span id="cb1-682"><a href="get-data.html#cb1-682" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toggle</span>(<span class="st">&quot;by_county&quot;</span>, <span class="at">condition =</span> <span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">state_list</span>()))</span>
<span id="cb1-683"><a href="get-data.html#cb1-683" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toggle</span>(<span class="st">&quot;by_site&quot;</span>, <span class="at">condition =</span> <span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">state_list</span>()))</span>
<span id="cb1-684"><a href="get-data.html#cb1-684" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toggle</span>(<span class="st">&quot;states&quot;</span>, <span class="at">condition =</span> <span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">state_list</span>()))</span>
<span id="cb1-685"><a href="get-data.html#cb1-685" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toggle</span>(<span class="st">&quot;parm_class&quot;</span>, <span class="at">condition =</span> <span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">class_list</span>()))</span>
<span id="cb1-686"><a href="get-data.html#cb1-686" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toggle</span>(<span class="st">&quot;parms&quot;</span>, <span class="at">condition =</span> <span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">parameter_list</span>()))</span>
<span id="cb1-687"><a href="get-data.html#cb1-687" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toggle</span>(<span class="st">&quot;service&quot;</span>, <span class="at">condition =</span> <span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">state_list</span>()))</span>
<span id="cb1-688"><a href="get-data.html#cb1-688" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-689"><a href="get-data.html#cb1-689" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-690"><a href="get-data.html#cb1-690" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-691"><a href="get-data.html#cb1-691" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(v<span class="sc">$</span>geo_select, {</span>
<span id="cb1-692"><a href="get-data.html#cb1-692" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-693"><a href="get-data.html#cb1-693" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toggle</span>(<span class="st">&quot;get_data&quot;</span>, <span class="at">condition =</span> v<span class="sc">$</span>geo_select <span class="sc">==</span> <span class="st">&quot;State&quot;</span>)</span>
<span id="cb1-694"><a href="get-data.html#cb1-694" aria-hidden="true" tabindex="-1"></a>    <span class="co">#if(v$geo_select %in% c(&quot;County&quot;, &quot;Site&quot;)) removeUI(&quot;div:has(&gt; #get_data)&quot;)</span></span>
<span id="cb1-695"><a href="get-data.html#cb1-695" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toggle</span>(<span class="st">&quot;select_cnty&quot;</span>, <span class="at">condition =</span> v<span class="sc">$</span>geo_select <span class="sc">==</span> <span class="st">&quot;County&quot;</span>)</span>
<span id="cb1-696"><a href="get-data.html#cb1-696" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toggle</span>(<span class="st">&quot;next_map&quot;</span>, <span class="at">condition =</span> v<span class="sc">$</span>geo_select <span class="sc">==</span> <span class="st">&quot;Site&quot;</span>)</span>
<span id="cb1-697"><a href="get-data.html#cb1-697" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-698"><a href="get-data.html#cb1-698" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-699"><a href="get-data.html#cb1-699" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-700"><a href="get-data.html#cb1-700" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-701"><a href="get-data.html#cb1-701" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-702"><a href="get-data.html#cb1-702" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-703"><a href="get-data.html#cb1-703" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-704"><a href="get-data.html#cb1-704" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(<span class="fu">list</span>(<span class="fu">class_list</span>(), input<span class="sc">$</span>by_state, input<span class="sc">$</span>by_county, input<span class="sc">$</span>by_site), {</span>
<span id="cb1-705"><a href="get-data.html#cb1-705" aria-hidden="true" tabindex="-1"></a>    shiny<span class="sc">::</span><span class="fu">validate</span>(<span class="fu">need</span>(<span class="fu">class_list</span>(), <span class="st">&quot;class_list&quot;</span>))</span>
<span id="cb1-706"><a href="get-data.html#cb1-706" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updatePickerInput</span>(<span class="at">session =</span> session, <span class="at">inputId =</span> <span class="st">&quot;parm_class&quot;</span>,</span>
<span id="cb1-707"><a href="get-data.html#cb1-707" aria-hidden="true" tabindex="-1"></a>                      <span class="at">choices =</span> <span class="fu">class_list</span>()[, code <span class="sc">%&gt;%</span> <span class="fu">setNames</span>(<span class="fu">paste0</span>(code, <span class="st">&quot;: &quot;</span>, value_represented))],</span>
<span id="cb1-708"><a href="get-data.html#cb1-708" aria-hidden="true" tabindex="-1"></a>                      <span class="at">selected =</span> v<span class="sc">$</span>selected_classes</span>
<span id="cb1-709"><a href="get-data.html#cb1-709" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-710"><a href="get-data.html#cb1-710" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-711"><a href="get-data.html#cb1-711" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-712"><a href="get-data.html#cb1-712" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-713"><a href="get-data.html#cb1-713" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-714"><a href="get-data.html#cb1-714" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-715"><a href="get-data.html#cb1-715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(<span class="fu">list</span>(<span class="fu">parameter_list</span>(), input<span class="sc">$</span>by_state, input<span class="sc">$</span>by_county, input<span class="sc">$</span>by_site), {</span>
<span id="cb1-716"><a href="get-data.html#cb1-716" aria-hidden="true" tabindex="-1"></a>    shiny<span class="sc">::</span><span class="fu">validate</span>(<span class="fu">need</span>(<span class="fu">parameter_list</span>(), <span class="st">&quot;parameter_list&quot;</span>))</span>
<span id="cb1-717"><a href="get-data.html#cb1-717" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-718"><a href="get-data.html#cb1-718" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updatePickerInput</span>(<span class="at">session =</span> session, <span class="at">inputId =</span> <span class="st">&quot;parms&quot;</span>,</span>
<span id="cb1-719"><a href="get-data.html#cb1-719" aria-hidden="true" tabindex="-1"></a>                      <span class="at">choices =</span> <span class="fu">parameter_list</span>()[, code <span class="sc">%&gt;%</span> <span class="fu">setNames</span>(<span class="fu">paste0</span>(code, <span class="st">&quot;: &quot;</span>, value_represented))],</span>
<span id="cb1-720"><a href="get-data.html#cb1-720" aria-hidden="true" tabindex="-1"></a>                      <span class="at">selected =</span> v<span class="sc">$</span>selected_parms</span>
<span id="cb1-721"><a href="get-data.html#cb1-721" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-722"><a href="get-data.html#cb1-722" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">priority =</span> <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb1-723"><a href="get-data.html#cb1-723" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-724"><a href="get-data.html#cb1-724" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-725"><a href="get-data.html#cb1-725" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-726"><a href="get-data.html#cb1-726" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-727"><a href="get-data.html#cb1-727" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-728"><a href="get-data.html#cb1-728" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-729"><a href="get-data.html#cb1-729" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>state_map <span class="ot">&lt;-</span> <span class="fu">renderLeaflet</span>({</span>
<span id="cb1-730"><a href="get-data.html#cb1-730" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-731"><a href="get-data.html#cb1-731" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(input<span class="sc">$</span>by_state, input<span class="sc">$</span>by_county, input<span class="sc">$</span>by_site)</span>
<span id="cb1-732"><a href="get-data.html#cb1-732" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-733"><a href="get-data.html#cb1-733" aria-hidden="true" tabindex="-1"></a>    <span class="fu">isolate</span>({</span>
<span id="cb1-734"><a href="get-data.html#cb1-734" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-735"><a href="get-data.html#cb1-735" aria-hidden="true" tabindex="-1"></a>    map_us <span class="ot">&lt;-</span> <span class="fu">leaflet</span>(<span class="fu">state_data</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb1-736"><a href="get-data.html#cb1-736" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-737"><a href="get-data.html#cb1-737" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addMapPane</span>(<span class="st">&quot;base_states&quot;</span>, <span class="at">zIndex =</span> <span class="dv">380</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-738"><a href="get-data.html#cb1-738" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addMapPane</span>(<span class="st">&quot;selected_states&quot;</span>, <span class="at">zIndex =</span> <span class="dv">390</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-739"><a href="get-data.html#cb1-739" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addPolygons</span>(</span>
<span id="cb1-740"><a href="get-data.html#cb1-740" aria-hidden="true" tabindex="-1"></a>        <span class="at">fillColor =</span> <span class="st">&quot;grey&quot;</span>,</span>
<span id="cb1-741"><a href="get-data.html#cb1-741" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb1-742"><a href="get-data.html#cb1-742" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="sc">~</span><span class="fu">state_data</span>()<span class="sc">$</span>NAME,</span>
<span id="cb1-743"><a href="get-data.html#cb1-743" aria-hidden="true" tabindex="-1"></a>        <span class="at">layerId =</span> <span class="sc">~</span><span class="fu">state_data</span>()<span class="sc">$</span>STATEFP,</span>
<span id="cb1-744"><a href="get-data.html#cb1-744" aria-hidden="true" tabindex="-1"></a>        <span class="at">options =</span> <span class="fu">pathOptions</span>(<span class="at">pane =</span> <span class="st">&quot;base_states&quot;</span>)</span>
<span id="cb1-745"><a href="get-data.html#cb1-745" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb1-746"><a href="get-data.html#cb1-746" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setView</span>(<span class="sc">-</span><span class="fl">98.5795</span>, <span class="fl">39.8282</span>, <span class="at">zoom=</span><span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-747"><a href="get-data.html#cb1-747" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addDrawToolbar</span>(</span>
<span id="cb1-748"><a href="get-data.html#cb1-748" aria-hidden="true" tabindex="-1"></a>        <span class="at">targetGroup=</span><span class="st">&#39;Selected&#39;</span>,</span>
<span id="cb1-749"><a href="get-data.html#cb1-749" aria-hidden="true" tabindex="-1"></a>        <span class="at">polylineOptions =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-750"><a href="get-data.html#cb1-750" aria-hidden="true" tabindex="-1"></a>        <span class="at">markerOptions =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-751"><a href="get-data.html#cb1-751" aria-hidden="true" tabindex="-1"></a>        <span class="at">circleMarkerOptions =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-752"><a href="get-data.html#cb1-752" aria-hidden="true" tabindex="-1"></a>        <span class="at">polygonOptions =</span> <span class="fu">drawPolygonOptions</span>(<span class="at">shapeOptions=</span><span class="fu">drawShapeOptions</span>(<span class="at">fillOpacity =</span> <span class="dv">0</span></span>
<span id="cb1-753"><a href="get-data.html#cb1-753" aria-hidden="true" tabindex="-1"></a>                                                                          ,<span class="at">color =</span> <span class="st">&#39;black&#39;</span></span>
<span id="cb1-754"><a href="get-data.html#cb1-754" aria-hidden="true" tabindex="-1"></a>                                                                          ,<span class="at">weight =</span> <span class="dv">3</span>)),</span>
<span id="cb1-755"><a href="get-data.html#cb1-755" aria-hidden="true" tabindex="-1"></a>        <span class="at">rectangleOptions =</span> <span class="fu">drawRectangleOptions</span>(<span class="at">shapeOptions=</span><span class="fu">drawShapeOptions</span>(<span class="at">fillOpacity =</span> <span class="dv">0</span></span>
<span id="cb1-756"><a href="get-data.html#cb1-756" aria-hidden="true" tabindex="-1"></a>                                                                              ,<span class="at">color =</span> <span class="st">&#39;black&#39;</span></span>
<span id="cb1-757"><a href="get-data.html#cb1-757" aria-hidden="true" tabindex="-1"></a>                                                                              ,<span class="at">weight =</span> <span class="dv">3</span>)),</span>
<span id="cb1-758"><a href="get-data.html#cb1-758" aria-hidden="true" tabindex="-1"></a>        <span class="at">circleOptions =</span> <span class="fu">drawCircleOptions</span>(<span class="at">shapeOptions =</span> <span class="fu">drawShapeOptions</span>(<span class="at">fillOpacity =</span> <span class="dv">0</span></span>
<span id="cb1-759"><a href="get-data.html#cb1-759" aria-hidden="true" tabindex="-1"></a>                                                                          ,<span class="at">color =</span> <span class="st">&#39;black&#39;</span></span>
<span id="cb1-760"><a href="get-data.html#cb1-760" aria-hidden="true" tabindex="-1"></a>                                                                          ,<span class="at">weight =</span> <span class="dv">3</span>)),</span>
<span id="cb1-761"><a href="get-data.html#cb1-761" aria-hidden="true" tabindex="-1"></a>        <span class="at">editOptions =</span> <span class="fu">editToolbarOptions</span>(<span class="at">edit =</span> <span class="cn">FALSE</span>, <span class="at">selectedPathOptions =</span> <span class="fu">selectedPathOptions</span>()))</span>
<span id="cb1-762"><a href="get-data.html#cb1-762" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-763"><a href="get-data.html#cb1-763" aria-hidden="true" tabindex="-1"></a>    <span class="co">#if(length(v$selected_states) &lt; 1) return()</span></span>
<span id="cb1-764"><a href="get-data.html#cb1-764" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-765"><a href="get-data.html#cb1-765" aria-hidden="true" tabindex="-1"></a>    selected <span class="ot">&lt;-</span> <span class="fu">subset</span>(<span class="fu">state_data</span>(), STATEFP <span class="sc">%in%</span> v<span class="sc">$</span>selected_states)</span>
<span id="cb1-766"><a href="get-data.html#cb1-766" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-767"><a href="get-data.html#cb1-767" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(selected) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb1-768"><a href="get-data.html#cb1-768" aria-hidden="true" tabindex="-1"></a>        map_us <span class="ot">&lt;-</span> <span class="fu">addPolygons</span>(</span>
<span id="cb1-769"><a href="get-data.html#cb1-769" aria-hidden="true" tabindex="-1"></a>          map_us,</span>
<span id="cb1-770"><a href="get-data.html#cb1-770" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> selected,</span>
<span id="cb1-771"><a href="get-data.html#cb1-771" aria-hidden="true" tabindex="-1"></a>          <span class="at">fillColor =</span> <span class="st">&quot;blue&quot;</span>,</span>
<span id="cb1-772"><a href="get-data.html#cb1-772" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb1-773"><a href="get-data.html#cb1-773" aria-hidden="true" tabindex="-1"></a>          <span class="at">label =</span> <span class="sc">~</span>selected<span class="sc">$</span>NAME,</span>
<span id="cb1-774"><a href="get-data.html#cb1-774" aria-hidden="true" tabindex="-1"></a>          <span class="at">layerId =</span> <span class="sc">~</span><span class="fu">paste</span>(selected<span class="sc">$</span>STATEFP, <span class="st">&quot;selected&quot;</span>),</span>
<span id="cb1-775"><a href="get-data.html#cb1-775" aria-hidden="true" tabindex="-1"></a>          <span class="at">options =</span> <span class="fu">pathOptions</span>(<span class="at">pane =</span> <span class="st">&quot;selected_states&quot;</span>)</span>
<span id="cb1-776"><a href="get-data.html#cb1-776" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1-777"><a href="get-data.html#cb1-777" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-778"><a href="get-data.html#cb1-778" aria-hidden="true" tabindex="-1"></a>    map_us</span>
<span id="cb1-779"><a href="get-data.html#cb1-779" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb1-780"><a href="get-data.html#cb1-780" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-781"><a href="get-data.html#cb1-781" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-782"><a href="get-data.html#cb1-782" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>cnty_map <span class="ot">&lt;-</span> <span class="fu">renderLeaflet</span>({</span>
<span id="cb1-783"><a href="get-data.html#cb1-783" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-784"><a href="get-data.html#cb1-784" aria-hidden="true" tabindex="-1"></a>    input<span class="sc">$</span>select_cnty</span>
<span id="cb1-785"><a href="get-data.html#cb1-785" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-786"><a href="get-data.html#cb1-786" aria-hidden="true" tabindex="-1"></a>    <span class="fu">leaflet</span>(<span class="fu">cnty_data</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb1-787"><a href="get-data.html#cb1-787" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-788"><a href="get-data.html#cb1-788" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addMapPane</span>(<span class="st">&quot;base_cntys&quot;</span>, <span class="at">zIndex =</span> <span class="dv">380</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-789"><a href="get-data.html#cb1-789" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addMapPane</span>(<span class="st">&quot;selected_cntys&quot;</span>, <span class="at">zIndex =</span> <span class="dv">390</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-790"><a href="get-data.html#cb1-790" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addPolygons</span>(</span>
<span id="cb1-791"><a href="get-data.html#cb1-791" aria-hidden="true" tabindex="-1"></a>        <span class="at">fillColor =</span> <span class="st">&quot;grey&quot;</span>,</span>
<span id="cb1-792"><a href="get-data.html#cb1-792" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb1-793"><a href="get-data.html#cb1-793" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="sc">~</span><span class="fu">cnty_data</span>()<span class="sc">$</span>NAME,</span>
<span id="cb1-794"><a href="get-data.html#cb1-794" aria-hidden="true" tabindex="-1"></a>        <span class="at">layerId =</span> <span class="sc">~</span><span class="fu">cnty_data</span>()<span class="sc">$</span>GEOID,</span>
<span id="cb1-795"><a href="get-data.html#cb1-795" aria-hidden="true" tabindex="-1"></a>        <span class="at">options =</span> <span class="fu">pathOptions</span>(<span class="at">pane =</span> <span class="st">&quot;base_cntys&quot;</span>)</span>
<span id="cb1-796"><a href="get-data.html#cb1-796" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb1-797"><a href="get-data.html#cb1-797" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addDrawToolbar</span>(</span>
<span id="cb1-798"><a href="get-data.html#cb1-798" aria-hidden="true" tabindex="-1"></a>        <span class="at">targetGroup=</span><span class="st">&#39;Selected&#39;</span>,</span>
<span id="cb1-799"><a href="get-data.html#cb1-799" aria-hidden="true" tabindex="-1"></a>        <span class="at">polylineOptions =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-800"><a href="get-data.html#cb1-800" aria-hidden="true" tabindex="-1"></a>        <span class="at">markerOptions =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-801"><a href="get-data.html#cb1-801" aria-hidden="true" tabindex="-1"></a>        <span class="at">circleMarkerOptions =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-802"><a href="get-data.html#cb1-802" aria-hidden="true" tabindex="-1"></a>        <span class="at">polygonOptions =</span> <span class="fu">drawPolygonOptions</span>(<span class="at">shapeOptions=</span><span class="fu">drawShapeOptions</span>(<span class="at">fillOpacity =</span> <span class="dv">0</span></span>
<span id="cb1-803"><a href="get-data.html#cb1-803" aria-hidden="true" tabindex="-1"></a>                                                                          ,<span class="at">color =</span> <span class="st">&#39;black&#39;</span></span>
<span id="cb1-804"><a href="get-data.html#cb1-804" aria-hidden="true" tabindex="-1"></a>                                                                          ,<span class="at">weight =</span> <span class="dv">3</span>)),</span>
<span id="cb1-805"><a href="get-data.html#cb1-805" aria-hidden="true" tabindex="-1"></a>        <span class="at">rectangleOptions =</span> <span class="fu">drawRectangleOptions</span>(<span class="at">shapeOptions=</span><span class="fu">drawShapeOptions</span>(<span class="at">fillOpacity =</span> <span class="dv">0</span></span>
<span id="cb1-806"><a href="get-data.html#cb1-806" aria-hidden="true" tabindex="-1"></a>                                                                              ,<span class="at">color =</span> <span class="st">&#39;black&#39;</span></span>
<span id="cb1-807"><a href="get-data.html#cb1-807" aria-hidden="true" tabindex="-1"></a>                                                                              ,<span class="at">weight =</span> <span class="dv">3</span>)),</span>
<span id="cb1-808"><a href="get-data.html#cb1-808" aria-hidden="true" tabindex="-1"></a>        <span class="at">circleOptions =</span> <span class="fu">drawCircleOptions</span>(<span class="at">shapeOptions =</span> <span class="fu">drawShapeOptions</span>(<span class="at">fillOpacity =</span> <span class="dv">0</span></span>
<span id="cb1-809"><a href="get-data.html#cb1-809" aria-hidden="true" tabindex="-1"></a>                                                                          ,<span class="at">color =</span> <span class="st">&#39;black&#39;</span></span>
<span id="cb1-810"><a href="get-data.html#cb1-810" aria-hidden="true" tabindex="-1"></a>                                                                          ,<span class="at">weight =</span> <span class="dv">3</span>)),</span>
<span id="cb1-811"><a href="get-data.html#cb1-811" aria-hidden="true" tabindex="-1"></a>        <span class="at">editOptions =</span> <span class="fu">editToolbarOptions</span>(<span class="at">edit =</span> <span class="cn">FALSE</span>, <span class="at">selectedPathOptions =</span> <span class="fu">selectedPathOptions</span>()))</span>
<span id="cb1-812"><a href="get-data.html#cb1-812" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-813"><a href="get-data.html#cb1-813" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-814"><a href="get-data.html#cb1-814" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-815"><a href="get-data.html#cb1-815" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-816"><a href="get-data.html#cb1-816" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>site_map <span class="ot">&lt;-</span> <span class="fu">renderLeaflet</span>({</span>
<span id="cb1-817"><a href="get-data.html#cb1-817" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-818"><a href="get-data.html#cb1-818" aria-hidden="true" tabindex="-1"></a>    <span class="fu">leaflet</span>(<span class="fu">site_list</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb1-819"><a href="get-data.html#cb1-819" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-820"><a href="get-data.html#cb1-820" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addMapPane</span>(<span class="st">&quot;base_sites&quot;</span>, <span class="at">zIndex =</span> <span class="dv">380</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-821"><a href="get-data.html#cb1-821" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addMapPane</span>(<span class="st">&quot;selected_sites&quot;</span>, <span class="at">zIndex =</span> <span class="dv">390</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-822"><a href="get-data.html#cb1-822" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addCircleMarkers</span>(<span class="at">fillColor =</span> <span class="st">&quot;grey&quot;</span>,</span>
<span id="cb1-823"><a href="get-data.html#cb1-823" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb1-824"><a href="get-data.html#cb1-824" aria-hidden="true" tabindex="-1"></a>                       <span class="at">label =</span> <span class="sc">~</span><span class="fu">glue</span>(<span class="st">&quot;&lt;p style=&#39;font-size:18px&#39;&gt;{local_site_name} ({state_code}-{county_code}-{site_number})&lt;br&gt;&lt;br&gt;</span></span>
<span id="cb1-825"><a href="get-data.html#cb1-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-826"><a href="get-data.html#cb1-826" aria-hidden="true" tabindex="-1"></a><span class="st">                                     {city_name}, {state_name}&lt;/p&gt;&quot;</span>) <span class="sc">%&gt;%</span> purrr<span class="sc">::</span><span class="fu">map</span>(HTML),</span>
<span id="cb1-827"><a href="get-data.html#cb1-827" aria-hidden="true" tabindex="-1"></a>                       <span class="at">layerId =</span> <span class="sc">~</span>siteid,</span>
<span id="cb1-828"><a href="get-data.html#cb1-828" aria-hidden="true" tabindex="-1"></a>                       <span class="at">options =</span> <span class="fu">pathOptions</span>(<span class="at">pane =</span> <span class="st">&quot;base_sites&quot;</span>)</span>
<span id="cb1-829"><a href="get-data.html#cb1-829" aria-hidden="true" tabindex="-1"></a>                       ) <span class="sc">%&gt;%</span></span>
<span id="cb1-830"><a href="get-data.html#cb1-830" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addDrawToolbar</span>(</span>
<span id="cb1-831"><a href="get-data.html#cb1-831" aria-hidden="true" tabindex="-1"></a>        <span class="at">targetGroup=</span><span class="st">&#39;Selected&#39;</span>,</span>
<span id="cb1-832"><a href="get-data.html#cb1-832" aria-hidden="true" tabindex="-1"></a>        <span class="at">polylineOptions =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-833"><a href="get-data.html#cb1-833" aria-hidden="true" tabindex="-1"></a>        <span class="at">markerOptions =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-834"><a href="get-data.html#cb1-834" aria-hidden="true" tabindex="-1"></a>        <span class="at">circleMarkerOptions =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-835"><a href="get-data.html#cb1-835" aria-hidden="true" tabindex="-1"></a>        <span class="at">polygonOptions =</span> <span class="fu">drawPolygonOptions</span>(<span class="at">shapeOptions=</span><span class="fu">drawShapeOptions</span>(<span class="at">fillOpacity =</span> <span class="dv">0</span></span>
<span id="cb1-836"><a href="get-data.html#cb1-836" aria-hidden="true" tabindex="-1"></a>                                                                          ,<span class="at">color =</span> <span class="st">&#39;black&#39;</span></span>
<span id="cb1-837"><a href="get-data.html#cb1-837" aria-hidden="true" tabindex="-1"></a>                                                                          ,<span class="at">weight =</span> <span class="dv">3</span>)),</span>
<span id="cb1-838"><a href="get-data.html#cb1-838" aria-hidden="true" tabindex="-1"></a>        <span class="at">rectangleOptions =</span> <span class="fu">drawRectangleOptions</span>(<span class="at">shapeOptions=</span><span class="fu">drawShapeOptions</span>(<span class="at">fillOpacity =</span> <span class="dv">0</span></span>
<span id="cb1-839"><a href="get-data.html#cb1-839" aria-hidden="true" tabindex="-1"></a>                                                                              ,<span class="at">color =</span> <span class="st">&#39;black&#39;</span></span>
<span id="cb1-840"><a href="get-data.html#cb1-840" aria-hidden="true" tabindex="-1"></a>                                                                              ,<span class="at">weight =</span> <span class="dv">3</span>)),</span>
<span id="cb1-841"><a href="get-data.html#cb1-841" aria-hidden="true" tabindex="-1"></a>        <span class="at">circleOptions =</span> <span class="fu">drawCircleOptions</span>(<span class="at">shapeOptions =</span> <span class="fu">drawShapeOptions</span>(<span class="at">fillOpacity =</span> <span class="dv">0</span></span>
<span id="cb1-842"><a href="get-data.html#cb1-842" aria-hidden="true" tabindex="-1"></a>                                                                          ,<span class="at">color =</span> <span class="st">&#39;black&#39;</span></span>
<span id="cb1-843"><a href="get-data.html#cb1-843" aria-hidden="true" tabindex="-1"></a>                                                                          ,<span class="at">weight =</span> <span class="dv">3</span>)),</span>
<span id="cb1-844"><a href="get-data.html#cb1-844" aria-hidden="true" tabindex="-1"></a>        <span class="at">editOptions =</span> <span class="fu">editToolbarOptions</span>(<span class="at">edit =</span> <span class="cn">FALSE</span>, <span class="at">selectedPathOptions =</span> <span class="fu">selectedPathOptions</span>()))</span>
<span id="cb1-845"><a href="get-data.html#cb1-845" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb1-846"><a href="get-data.html#cb1-846" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-847"><a href="get-data.html#cb1-847" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-848"><a href="get-data.html#cb1-848" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>site_map_marker_click,{</span>
<span id="cb1-849"><a href="get-data.html#cb1-849" aria-hidden="true" tabindex="-1"></a>    clicked <span class="ot">&lt;-</span> input<span class="sc">$</span>site_map_marker_click<span class="sc">$</span>id <span class="sc">%&gt;%</span> <span class="fu">str_extract</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">d{2}-</span><span class="sc">\\</span><span class="st">d{3}-</span><span class="sc">\\</span><span class="st">d{4}&quot;</span>)</span>
<span id="cb1-850"><a href="get-data.html#cb1-850" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(clicked <span class="sc">%in%</span> v<span class="sc">$</span>selected_sites) {</span>
<span id="cb1-851"><a href="get-data.html#cb1-851" aria-hidden="true" tabindex="-1"></a>      v<span class="sc">$</span>selected_sites <span class="ot">&lt;-</span> v<span class="sc">$</span>selected_sites[<span class="sc">!</span>(v<span class="sc">$</span>selected_sites <span class="sc">%in%</span> clicked)]</span>
<span id="cb1-852"><a href="get-data.html#cb1-852" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1-853"><a href="get-data.html#cb1-853" aria-hidden="true" tabindex="-1"></a>      v<span class="sc">$</span>selected_sites <span class="ot">&lt;-</span> <span class="fu">c</span>(v<span class="sc">$</span>selected_sites, clicked)  </span>
<span id="cb1-854"><a href="get-data.html#cb1-854" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-855"><a href="get-data.html#cb1-855" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-856"><a href="get-data.html#cb1-856" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-857"><a href="get-data.html#cb1-857" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>site_map_draw_new_feature,{</span>
<span id="cb1-858"><a href="get-data.html#cb1-858" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-859"><a href="get-data.html#cb1-859" aria-hidden="true" tabindex="-1"></a>    v<span class="sc">$</span>site_polys <span class="ot">&lt;-</span> <span class="fu">c</span>(v<span class="sc">$</span>site_polys, <span class="fu">list</span>(input<span class="sc">$</span>site_map_draw_new_feature)) <span class="sc">%&gt;%</span></span>
<span id="cb1-860"><a href="get-data.html#cb1-860" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_names</span>(purrr<span class="sc">::</span><span class="fu">map</span>(., <span class="sc">~</span>.x<span class="sc">$</span>properties<span class="sc">$</span><span class="st">`</span><span class="at">_leaflet_id</span><span class="st">`</span>))</span>
<span id="cb1-861"><a href="get-data.html#cb1-861" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-862"><a href="get-data.html#cb1-862" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-863"><a href="get-data.html#cb1-863" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(input<span class="sc">$</span>site_map_draw_deleted_features,{</span>
<span id="cb1-864"><a href="get-data.html#cb1-864" aria-hidden="true" tabindex="-1"></a>    remove_polys <span class="ot">&lt;-</span> <span class="fu">map_int</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(input<span class="sc">$</span>site_map_draw_deleted_features<span class="sc">$</span>features),</span>
<span id="cb1-865"><a href="get-data.html#cb1-865" aria-hidden="true" tabindex="-1"></a>                            <span class="sc">~</span><span class="fu">pluck</span>(input<span class="sc">$</span>site_map_draw_deleted_features, <span class="st">&quot;features&quot;</span>, .x, <span class="st">&quot;properties&quot;</span>, <span class="st">&quot;_leaflet_id&quot;</span>))</span>
<span id="cb1-866"><a href="get-data.html#cb1-866" aria-hidden="true" tabindex="-1"></a>    v<span class="sc">$</span>site_polys <span class="ot">&lt;-</span> v<span class="sc">$</span>site_polys[<span class="sc">!</span>(<span class="fu">names</span>(v<span class="sc">$</span>site_polys) <span class="sc">%in%</span> <span class="fu">as.character</span>(remove_polys))]</span>
<span id="cb1-867"><a href="get-data.html#cb1-867" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-868"><a href="get-data.html#cb1-868" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-869"><a href="get-data.html#cb1-869" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(v<span class="sc">$</span>site_polys, {</span>
<span id="cb1-870"><a href="get-data.html#cb1-870" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-871"><a href="get-data.html#cb1-871" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">length</span>(v<span class="sc">$</span>site_polys)) {</span>
<span id="cb1-872"><a href="get-data.html#cb1-872" aria-hidden="true" tabindex="-1"></a>      v<span class="sc">$</span>selected_sites <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-873"><a href="get-data.html#cb1-873" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>()</span>
<span id="cb1-874"><a href="get-data.html#cb1-874" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-875"><a href="get-data.html#cb1-875" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-876"><a href="get-data.html#cb1-876" aria-hidden="true" tabindex="-1"></a>    polys <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(v<span class="sc">$</span>site_polys, <span class="sc">~</span><span class="cf">if</span>(.x<span class="sc">$</span>properties<span class="sc">$</span>feature_type <span class="sc">==</span> <span class="st">&quot;circle&quot;</span>) {</span>
<span id="cb1-877"><a href="get-data.html#cb1-877" aria-hidden="true" tabindex="-1"></a>      .x<span class="sc">$</span>geometry<span class="sc">$</span>coordinates <span class="sc">%&gt;%</span> <span class="fu">unlist</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-878"><a href="get-data.html#cb1-878" aria-hidden="true" tabindex="-1"></a>        {<span class="fu">circle.polygon</span>(.[<span class="dv">1</span>], .[<span class="dv">2</span>], .x<span class="sc">$</span>properties<span class="sc">$</span>radius <span class="sc">/</span> <span class="dv">1000</span>, <span class="at">sides =</span> <span class="dv">1000</span>, <span class="at">by.length =</span> F,</span>
<span id="cb1-879"><a href="get-data.html#cb1-879" aria-hidden="true" tabindex="-1"></a>                        <span class="at">units =</span> <span class="st">&quot;km&quot;</span>, <span class="at">poly.type =</span> <span class="st">&quot;gc.earth&quot;</span>)} <span class="sc">%&gt;%</span></span>
<span id="cb1-880"><a href="get-data.html#cb1-880" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Polygon</span>()</span>
<span id="cb1-881"><a href="get-data.html#cb1-881" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1-882"><a href="get-data.html#cb1-882" aria-hidden="true" tabindex="-1"></a>      .x<span class="sc">$</span>geometry<span class="sc">$</span>coordinates[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">rbindlist</span>() <span class="sc">%&gt;%</span> <span class="fu">Polygon</span>()</span>
<span id="cb1-883"><a href="get-data.html#cb1-883" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb1-884"><a href="get-data.html#cb1-884" aria-hidden="true" tabindex="-1"></a>    polys <span class="ot">&lt;-</span> polys <span class="sc">%&gt;%</span> <span class="fu">imap</span>(<span class="sc">~</span><span class="fu">Polygons</span>(<span class="fu">list</span>(.x), .y)) <span class="sc">%&gt;%</span> <span class="fu">SpatialPolygons</span>() <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>()</span>
<span id="cb1-885"><a href="get-data.html#cb1-885" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_crs</span>(polys) <span class="ot">&lt;-</span> <span class="st">&quot;WGS84&quot;</span></span>
<span id="cb1-886"><a href="get-data.html#cb1-886" aria-hidden="true" tabindex="-1"></a>    site_data <span class="ot">&lt;-</span> <span class="fu">group_by</span>(site_data1, siteid) <span class="sc">%&gt;%</span> <span class="fu">group_modify</span>(<span class="sc">~</span><span class="fu">st_as_sf</span>(.x, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;longitude&quot;</span>, <span class="st">&quot;latitude&quot;</span>), <span class="at">crs =</span> .x<span class="sc">$</span>datum) <span class="sc">%&gt;%</span></span>
<span id="cb1-887"><a href="get-data.html#cb1-887" aria-hidden="true" tabindex="-1"></a>                                                          <span class="fu">st_transform</span>(<span class="st">&quot;WGS84&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb1-888"><a href="get-data.html#cb1-888" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">GEOID =</span> siteid) <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>()</span>
<span id="cb1-889"><a href="get-data.html#cb1-889" aria-hidden="true" tabindex="-1"></a>    v<span class="sc">$</span>selected_sites <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(site_data, polys) <span class="sc">%&gt;%</span></span>
<span id="cb1-890"><a href="get-data.html#cb1-890" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pull</span>(GEOID)</span>
<span id="cb1-891"><a href="get-data.html#cb1-891" aria-hidden="true" tabindex="-1"></a>    check5 <span class="ot">&lt;-</span> v<span class="sc">$</span>selected_sites</span>
<span id="cb1-892"><a href="get-data.html#cb1-892" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-893"><a href="get-data.html#cb1-893" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-894"><a href="get-data.html#cb1-894" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(v<span class="sc">$</span>selected_sites, {</span>
<span id="cb1-895"><a href="get-data.html#cb1-895" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-896"><a href="get-data.html#cb1-896" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-897"><a href="get-data.html#cb1-897" aria-hidden="true" tabindex="-1"></a>    shiny<span class="sc">::</span><span class="fu">validate</span>(<span class="fu">need</span>(<span class="fu">site_list</span>(), <span class="st">&quot;site_list&quot;</span>))</span>
<span id="cb1-898"><a href="get-data.html#cb1-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-899"><a href="get-data.html#cb1-899" aria-hidden="true" tabindex="-1"></a>    check5 <span class="ot">&lt;-</span> v<span class="sc">$</span>selected_sites</span>
<span id="cb1-900"><a href="get-data.html#cb1-900" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-901"><a href="get-data.html#cb1-901" aria-hidden="true" tabindex="-1"></a>    selected_sites <span class="ot">&lt;&lt;-</span> <span class="fu">filter</span>(<span class="fu">site_list</span>(), siteid <span class="sc">%in%</span> v<span class="sc">$</span>selected_sites)</span>
<span id="cb1-902"><a href="get-data.html#cb1-902" aria-hidden="true" tabindex="-1"></a>    not_selected_sites <span class="ot">&lt;&lt;-</span> <span class="fu">filter</span>(<span class="fu">site_list</span>(), <span class="sc">!</span>(siteid <span class="sc">%in%</span> v<span class="sc">$</span>selected_sites))</span>
<span id="cb1-903"><a href="get-data.html#cb1-903" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-904"><a href="get-data.html#cb1-904" aria-hidden="true" tabindex="-1"></a>    proxy <span class="ot">&lt;-</span> <span class="fu">leafletProxy</span>(<span class="st">&quot;site_map&quot;</span>, session)</span>
<span id="cb1-905"><a href="get-data.html#cb1-905" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(selected_sites) <span class="sc">&gt;</span> <span class="dv">0</span>) {proxy <span class="sc">%&gt;%</span></span>
<span id="cb1-906"><a href="get-data.html#cb1-906" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addCircleMarkers</span>(</span>
<span id="cb1-907"><a href="get-data.html#cb1-907" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> selected_sites,</span>
<span id="cb1-908"><a href="get-data.html#cb1-908" aria-hidden="true" tabindex="-1"></a>          <span class="at">fillColor =</span> <span class="st">&quot;blue&quot;</span>,</span>
<span id="cb1-909"><a href="get-data.html#cb1-909" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb1-910"><a href="get-data.html#cb1-910" aria-hidden="true" tabindex="-1"></a>          <span class="at">layerId =</span> <span class="sc">~</span><span class="fu">paste</span>(siteid, <span class="st">&quot;selected&quot;</span>)</span>
<span id="cb1-911"><a href="get-data.html#cb1-911" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1-912"><a href="get-data.html#cb1-912" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-913"><a href="get-data.html#cb1-913" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-914"><a href="get-data.html#cb1-914" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-915"><a href="get-data.html#cb1-915" aria-hidden="true" tabindex="-1"></a>    proxy <span class="sc">%&gt;%</span> <span class="fu">removeMarker</span>(<span class="at">layerId =</span> <span class="fu">paste</span>(not_selected_sites<span class="sc">$</span>siteid, <span class="st">&quot;selected&quot;</span>))</span>
<span id="cb1-916"><a href="get-data.html#cb1-916" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-917"><a href="get-data.html#cb1-917" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updatePickerInput</span>(<span class="at">session =</span> session, <span class="at">inputId =</span> <span class="st">&quot;site_select&quot;</span>,</span>
<span id="cb1-918"><a href="get-data.html#cb1-918" aria-hidden="true" tabindex="-1"></a>                      <span class="at">choices =</span> <span class="fu">site_list</span>()<span class="sc">$</span>siteid <span class="sc">%&gt;%</span> <span class="fu">setNames</span>(<span class="fu">paste0</span>(<span class="fu">site_list</span>()<span class="sc">$</span>siteid, <span class="st">&quot;: &quot;</span>, <span class="fu">site_list</span>()<span class="sc">$</span>local_site_name)),</span>
<span id="cb1-919"><a href="get-data.html#cb1-919" aria-hidden="true" tabindex="-1"></a>                      <span class="at">selected =</span> v<span class="sc">$</span>selected_sites)</span>
<span id="cb1-920"><a href="get-data.html#cb1-920" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-921"><a href="get-data.html#cb1-921" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">ignoreNULL =</span> F)</span>
<span id="cb1-922"><a href="get-data.html#cb1-922" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-923"><a href="get-data.html#cb1-923" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observeEvent</span>(purrr<span class="sc">::</span><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="sc">~</span>input[[<span class="fu">paste0</span>(<span class="st">&quot;go_back&quot;</span>, .x)]]),{</span>
<span id="cb1-924"><a href="get-data.html#cb1-924" aria-hidden="true" tabindex="-1"></a>               sheet <span class="ot">&lt;&lt;-</span> input<span class="sc">$</span>navBar</span>
<span id="cb1-925"><a href="get-data.html#cb1-925" aria-hidden="true" tabindex="-1"></a>               <span class="fu">recode</span>(input<span class="sc">$</span>navBar,</span>
<span id="cb1-926"><a href="get-data.html#cb1-926" aria-hidden="true" tabindex="-1"></a>                      <span class="at">panel2 =</span> <span class="st">&quot;panel1&quot;</span>,</span>
<span id="cb1-927"><a href="get-data.html#cb1-927" aria-hidden="true" tabindex="-1"></a>                      <span class="at">panel3 =</span> <span class="st">&quot;panel2&quot;</span>,</span>
<span id="cb1-928"><a href="get-data.html#cb1-928" aria-hidden="true" tabindex="-1"></a>                      <span class="at">panel4 =</span> <span class="st">&quot;panel3&quot;</span>,</span>
<span id="cb1-929"><a href="get-data.html#cb1-929" aria-hidden="true" tabindex="-1"></a>                      <span class="at">panel5 =</span> <span class="st">&quot;panel3&quot;</span>,</span>
<span id="cb1-930"><a href="get-data.html#cb1-930" aria-hidden="true" tabindex="-1"></a>                      <span class="at">panel6 =</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is_empty</span>(v<span class="sc">$</span>geo_select)) <span class="fu">recode</span>(v<span class="sc">$</span>geo_select,</span>
<span id="cb1-931"><a href="get-data.html#cb1-931" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">State =</span> <span class="st">&quot;panel3&quot;</span>,</span>
<span id="cb1-932"><a href="get-data.html#cb1-932" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">County =</span> <span class="st">&quot;panel4&quot;</span>,</span>
<span id="cb1-933"><a href="get-data.html#cb1-933" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">Site =</span> <span class="st">&quot;panel5&quot;</span>)</span>
<span id="cb1-934"><a href="get-data.html#cb1-934" aria-hidden="true" tabindex="-1"></a>                      ) <span class="sc">%&gt;%</span></span>
<span id="cb1-935"><a href="get-data.html#cb1-935" aria-hidden="true" tabindex="-1"></a>                 {<span class="fu">hide</span>(<span class="at">selector =</span> <span class="fu">glue</span>(<span class="st">&quot;#navBar li a[data-value={input$navBar}]&quot;</span>))</span>
<span id="cb1-936"><a href="get-data.html#cb1-936" aria-hidden="true" tabindex="-1"></a>                   shinyjs<span class="sc">::</span><span class="fu">show</span>(<span class="at">selector =</span> <span class="fu">glue</span>(<span class="st">&quot;#navBar li a[data-value={.}]&quot;</span>))</span>
<span id="cb1-937"><a href="get-data.html#cb1-937" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">updateNavbarPage</span>(session, <span class="st">&quot;navBar&quot;</span>, <span class="at">selected=</span>.)}</span>
<span id="cb1-938"><a href="get-data.html#cb1-938" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-939"><a href="get-data.html#cb1-939" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-940"><a href="get-data.html#cb1-940" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-941"><a href="get-data.html#cb1-941" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-942"><a href="get-data.html#cb1-942" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-943"><a href="get-data.html#cb1-943" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-944"><a href="get-data.html#cb1-944" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>table <span class="ot">&lt;-</span> <span class="fu">renderDT</span>({</span>
<span id="cb1-945"><a href="get-data.html#cb1-945" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(v<span class="sc">$</span>data) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>()</span>
<span id="cb1-946"><a href="get-data.html#cb1-946" aria-hidden="true" tabindex="-1"></a>    check6 <span class="ot">&lt;&lt;-</span> v<span class="sc">$</span>data</span>
<span id="cb1-947"><a href="get-data.html#cb1-947" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datatable</span>(v<span class="sc">$</span>data, <span class="at">filter =</span> <span class="fu">list</span>(<span class="at">position =</span> <span class="st">&#39;top&#39;</span>, <span class="at">clear =</span> <span class="cn">FALSE</span>))</span>
<span id="cb1-948"><a href="get-data.html#cb1-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-949"><a href="get-data.html#cb1-949" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-950"><a href="get-data.html#cb1-950" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-951"><a href="get-data.html#cb1-951" aria-hidden="true" tabindex="-1"></a>  output<span class="sc">$</span>downloadData <span class="ot">&lt;-</span> <span class="fu">downloadHandler</span>(</span>
<span id="cb1-952"><a href="get-data.html#cb1-952" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="cf">function</span>() {</span>
<span id="cb1-953"><a href="get-data.html#cb1-953" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste</span>(<span class="st">&quot;data-&quot;</span>, <span class="fu">Sys.Date</span>(), <span class="st">&quot;.csv&quot;</span>, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb1-954"><a href="get-data.html#cb1-954" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-955"><a href="get-data.html#cb1-955" aria-hidden="true" tabindex="-1"></a>    <span class="at">content =</span> <span class="cf">function</span>(file) {</span>
<span id="cb1-956"><a href="get-data.html#cb1-956" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fwrite</span>(v<span class="sc">$</span>data, file)</span>
<span id="cb1-957"><a href="get-data.html#cb1-957" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-958"><a href="get-data.html#cb1-958" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-959"><a href="get-data.html#cb1-959" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-960"><a href="get-data.html#cb1-960" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-961"><a href="get-data.html#cb1-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-962"><a href="get-data.html#cb1-962" aria-hidden="true" tabindex="-1"></a><span class="fu">runApp</span>(<span class="fu">shinyApp</span>(ui, server), <span class="at">launch.browser =</span> T)</span></code></pre></div>
</div>
<p><br></p>
</div>
<div id="wair" class="section level3" number="2.1.3">
<h3><span class="header-section-number">2.1.3</span> Retrieving data from MPCA WAIR database</h3>
<p>The WAIR database provides a queryable local copy of select air quality data extracted from multiple data sources. This database is managed by Margaret McCourtney. Contact Margaret to request login credentials.</p>
<p>See <a href="http://rainier.pca.state.mn.us/documentation/DataDictionary/wair/index.html">WAIR Data Dictionary</a> for available data tables.</p>
<p>Use the following code to query WAIR using the R package <code>dplyr</code>.</p>
<div class="toggle">
<button class="btn_code">
Show <strong>R</strong> code
</button>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="get-data.html#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">################################################################################################</span></span>
<span id="cb2-2"><a href="get-data.html#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="do">## This script loads the library and driver and connects to WAIR.  A dplyr query extracts </span></span>
<span id="cb2-3"><a href="get-data.html#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="do">## data from the database into a format specified by Cassie McMahon for calculating           </span></span>
<span id="cb2-4"><a href="get-data.html#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="do">## OZONE DESIGN VALUES                                                                        </span></span>
<span id="cb2-5"><a href="get-data.html#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="do">##                                                                                    </span></span>
<span id="cb2-6"><a href="get-data.html#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Note: WAIR does not contain values for SamplingFrequency and MonitorProtocolID </span></span>
<span id="cb2-7"><a href="get-data.html#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb2-8"><a href="get-data.html#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Note:  dplyr does not have a command to disconnect from the database. Connection will</span></span>
<span id="cb2-9"><a href="get-data.html#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="do">## terminate upon quitting R.  Please do not keep (many) connections open for long periods of</span></span>
<span id="cb2-10"><a href="get-data.html#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="do">## time.</span></span>
<span id="cb2-11"><a href="get-data.html#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="do">################################################################################################</span></span>
<span id="cb2-12"><a href="get-data.html#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="get-data.html#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Load the package</span></span>
<span id="cb2-14"><a href="get-data.html#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-15"><a href="get-data.html#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="get-data.html#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="do">## Open a connection to the database WAIR, schema AQS ##</span></span>
<span id="cb2-17"><a href="get-data.html#cb2-17" aria-hidden="true" tabindex="-1"></a>my_wair <span class="ot">&lt;-</span> <span class="fu">src_postgres</span>(<span class="at">dbname =</span> <span class="st">&#39;wair&#39;</span>, <span class="at">host =</span> <span class="st">&quot;eiger&quot;</span>, <span class="at">user =</span> <span class="st">&quot;username&quot;</span>, <span class="at">password =</span> <span class="st">&quot;password&quot;</span>,</span>
<span id="cb2-18"><a href="get-data.html#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="at">options =</span> <span class="st">&quot;-c search_path=aqs&quot;</span>)</span>
<span id="cb2-19"><a href="get-data.html#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="get-data.html#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="do">## Reference a table, or two if combining, in the database (e.g. aqs.monitor &amp; aqs.obs_value) ##</span></span>
<span id="cb2-21"><a href="get-data.html#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="do">## Select columns and filter by row ##</span></span>
<span id="cb2-22"><a href="get-data.html#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="get-data.html#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co">#aqs.monitor table in WAIR ##</span></span>
<span id="cb2-24"><a href="get-data.html#cb2-24" aria-hidden="true" tabindex="-1"></a>my_monitor <span class="ot">&lt;-</span> <span class="fu">tbl</span>(my_wair, <span class="st">&quot;monitor&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-25"><a href="get-data.html#cb2-25" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(id_mon<span class="sc">:</span>poc_code) <span class="sc">%&gt;%</span>  </span>
<span id="cb2-26"><a href="get-data.html#cb2-26" aria-hidden="true" tabindex="-1"></a>                <span class="fu">filter</span>(stateid<span class="sc">==</span><span class="dv">27</span> <span class="sc">&amp;&amp;</span> parm_code <span class="sc">==</span> <span class="dv">44201</span>)</span>
<span id="cb2-27"><a href="get-data.html#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="get-data.html#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co">#aqs.obs_value table in WAIR ##</span></span>
<span id="cb2-29"><a href="get-data.html#cb2-29" aria-hidden="true" tabindex="-1"></a>my_obs <span class="ot">&lt;-</span> <span class="fu">tbl</span>(my_wair, <span class="st">&quot;obs_value&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-30"><a href="get-data.html#cb2-30" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(parm_code <span class="sc">==</span> <span class="dv">44201</span> <span class="sc">&amp;&amp;</span> <span class="fu">between</span>(sampldate, <span class="st">&quot;2014-06-01&quot;</span>, <span class="st">&quot;2014-06-07&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-31"><a href="get-data.html#cb2-31" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(id_mon, dur_code, unitid, method_code,</span>
<span id="cb2-32"><a href="get-data.html#cb2-32" aria-hidden="true" tabindex="-1"></a>                     sampldate, startime, value, nulldata, qual_code)</span>
<span id="cb2-33"><a href="get-data.html#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="get-data.html#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="do">## Combine monitor data with observations </span></span>
<span id="cb2-35"><a href="get-data.html#cb2-35" aria-hidden="true" tabindex="-1"></a>my_mn_o3 <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(my_monitor, my_obs, <span class="at">type =</span> <span class="st">&quot;inner&quot;</span>, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;id_mon&quot;</span>)) </span>
<span id="cb2-36"><a href="get-data.html#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="get-data.html#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="get-data.html#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="do">## Collect data into a dataframe or table </span></span>
<span id="cb2-39"><a href="get-data.html#cb2-39" aria-hidden="true" tabindex="-1"></a>my_mn_o3_df <span class="ot">&lt;-</span> <span class="fu">collect</span>(my_mn_o3) <span class="sc">%&gt;%</span> </span>
<span id="cb2-40"><a href="get-data.html#cb2-40" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">arrange</span>(stateid, cntyid, siteid, parm_code,  <span class="co"># Arrange combined data in specified order</span></span>
<span id="cb2-41"><a href="get-data.html#cb2-41" aria-hidden="true" tabindex="-1"></a>                         poc_code, dur_code, unitid, method_code, </span>
<span id="cb2-42"><a href="get-data.html#cb2-42" aria-hidden="true" tabindex="-1"></a>                         sampldate, startime, value, nulldata, qual_code)</span>
<span id="cb2-43"><a href="get-data.html#cb2-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-44"><a href="get-data.html#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb2-45"><a href="get-data.html#cb2-45" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(my_mn_o3_df)</span></code></pre></div>
</div>
<p><br></p>
<p>Use the following code to query WAIR using the package <code>RPostgrSQL</code>.</p>
<div class="toggle">
<button class="btn_code">
Show <strong>R</strong> code
</button>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="get-data.html#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">################################################################################################</span></span>
<span id="cb3-2"><a href="get-data.html#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="do">## This script loads the library and driver and connects to WAIR.  A PostgrSQL query extracts </span></span>
<span id="cb3-3"><a href="get-data.html#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="do">## data from the database into a format specified by Cassie McMahon for calculating           </span></span>
<span id="cb3-4"><a href="get-data.html#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="do">## OZONE DESIGN VALUES                                                                        </span></span>
<span id="cb3-5"><a href="get-data.html#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="do">##                                                                                    </span></span>
<span id="cb3-6"><a href="get-data.html#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Please disconnect from database and unload the driver before proceeding with analysis of </span></span>
<span id="cb3-7"><a href="get-data.html#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="do">## the data in your dataframe.</span></span>
<span id="cb3-8"><a href="get-data.html#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb3-9"><a href="get-data.html#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Cassie&#39;s headings</span></span>
<span id="cb3-10"><a href="get-data.html#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="do">## &quot;State.Code&quot;, &quot;County.Code&quot;, &quot;Site.ID&quot;, &quot;Parameter&quot;, &quot;POC&quot;, &quot;Sample.Duration&quot;, &quot;Unit&quot;,</span></span>
<span id="cb3-11"><a href="get-data.html#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="do">## &quot;Method&quot;, &quot;Date&quot;, &quot;Start.Time&quot;, &quot;Sample.Value&quot;, &quot;NullDataCode&quot;, &quot;SamplingFrequency&quot;,</span></span>
<span id="cb3-12"><a href="get-data.html#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="do">## &quot;MonitorProtocolID&quot;, &quot;Qual1&quot;  </span></span>
<span id="cb3-13"><a href="get-data.html#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="do">##  Note: WAIR does not contain values for SamplingFrequency and MonitorProtocolID </span></span>
<span id="cb3-14"><a href="get-data.html#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb3-15"><a href="get-data.html#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="do">################################################################################################</span></span>
<span id="cb3-16"><a href="get-data.html#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="get-data.html#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="do">## call the library</span></span>
<span id="cb3-18"><a href="get-data.html#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RPostgreSQL)</span>
<span id="cb3-19"><a href="get-data.html#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="get-data.html#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="do">## load the PostgreSQL driver</span></span>
<span id="cb3-21"><a href="get-data.html#cb3-21" aria-hidden="true" tabindex="-1"></a>drv <span class="ot">&lt;-</span> <span class="fu">dbDriver</span>(<span class="st">&quot;PostgreSQL&quot;</span>)</span>
<span id="cb3-22"><a href="get-data.html#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="get-data.html#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="do">## Open a connection </span></span>
<span id="cb3-24"><a href="get-data.html#cb3-24" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(drv, <span class="at">dbname =</span> <span class="st">&quot;wair&quot;</span>, <span class="at">host =</span> <span class="st">&#39;eiger&#39;</span>, <span class="at">user =</span> <span class="st">&#39;username&#39;</span>, <span class="at">password =</span> <span class="st">&#39;password&#39;</span>)</span>
<span id="cb3-25"><a href="get-data.html#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="get-data.html#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co">#***************************** all in 1 step ***************************************************</span></span>
<span id="cb3-27"><a href="get-data.html#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="get-data.html#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="get-data.html#cb3-29" aria-hidden="true" tabindex="-1"></a>dframe <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, </span>
<span id="cb3-30"><a href="get-data.html#cb3-30" aria-hidden="true" tabindex="-1"></a>           <span class="at">statement =</span> <span class="fu">paste</span>(</span>
<span id="cb3-31"><a href="get-data.html#cb3-31" aria-hidden="true" tabindex="-1"></a>       <span class="do">################ insert SQL here ######################</span></span>
<span id="cb3-32"><a href="get-data.html#cb3-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;SELECT m.stateid AS state_code,\</span></span>
<span id="cb3-33"><a href="get-data.html#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="st">            m.cntyid AS county_code,\</span></span>
<span id="cb3-34"><a href="get-data.html#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="st">            m.siteid AS site_id,\</span></span>
<span id="cb3-35"><a href="get-data.html#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="st">            m.parm_code AS parameter,\</span></span>
<span id="cb3-36"><a href="get-data.html#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="st">            m.poc_code AS poc,\</span></span>
<span id="cb3-37"><a href="get-data.html#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="st">            o.dur_code AS sample_duration,\</span></span>
<span id="cb3-38"><a href="get-data.html#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="st">        o.unitid AS unit,\</span></span>
<span id="cb3-39"><a href="get-data.html#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="st">            o.method_code AS method,\</span></span>
<span id="cb3-40"><a href="get-data.html#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="st">            o.sampldate AS date,\</span></span>
<span id="cb3-41"><a href="get-data.html#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="st">            o.startime AS start_time,\</span></span>
<span id="cb3-42"><a href="get-data.html#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="st">            o.value AS sample_value,\</span></span>
<span id="cb3-43"><a href="get-data.html#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="st">            o.nulldata AS nulldatacode,\</span></span>
<span id="cb3-44"><a href="get-data.html#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="st">                NULL AS sampling_frequency,\</span></span>
<span id="cb3-45"><a href="get-data.html#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="st">        NULL AS monitor_protocol_id,\</span></span>
<span id="cb3-46"><a href="get-data.html#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="st">            o.qual_code\</span></span>
<span id="cb3-47"><a href="get-data.html#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="st">           FROM aqs.monitor m \</span></span>
<span id="cb3-48"><a href="get-data.html#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="st">           JOIN aqs.obs_value o \</span></span>
<span id="cb3-49"><a href="get-data.html#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="st">             ON m.id_mon = o.id_mon \ </span></span>
<span id="cb3-50"><a href="get-data.html#cb3-50" aria-hidden="true" tabindex="-1"></a><span class="st">          WHERE m.stateid = &#39;27&#39; \</span></span>
<span id="cb3-51"><a href="get-data.html#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="st">            AND m.parm_code = &#39;44201&#39; \</span></span>
<span id="cb3-52"><a href="get-data.html#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="st">            AND o.sampldate BETWEEN &#39;2014-06-01&#39; AND &#39;2014-06-07&#39;\</span></span>
<span id="cb3-53"><a href="get-data.html#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;</span></span>
<span id="cb3-54"><a href="get-data.html#cb3-54" aria-hidden="true" tabindex="-1"></a>       <span class="do">########################################################</span></span>
<span id="cb3-55"><a href="get-data.html#cb3-55" aria-hidden="true" tabindex="-1"></a>                     )); </span>
<span id="cb3-56"><a href="get-data.html#cb3-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-57"><a href="get-data.html#cb3-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-58"><a href="get-data.html#cb3-58" aria-hidden="true" tabindex="-1"></a><span class="co">#***********************************************************************************************</span></span>
<span id="cb3-59"><a href="get-data.html#cb3-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-60"><a href="get-data.html#cb3-60" aria-hidden="true" tabindex="-1"></a><span class="do">## Closes the connection</span></span>
<span id="cb3-61"><a href="get-data.html#cb3-61" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con)</span>
<span id="cb3-62"><a href="get-data.html#cb3-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-63"><a href="get-data.html#cb3-63" aria-hidden="true" tabindex="-1"></a><span class="do">## Frees all the resources on the driver</span></span>
<span id="cb3-64"><a href="get-data.html#cb3-64" aria-hidden="true" tabindex="-1"></a><span class="fu">dbUnloadDriver</span>(drv)</span></code></pre></div>
</div>
</div>
<div id="aqi-now" class="section level3" number="2.1.4">
<h3><span class="header-section-number">2.1.4</span> Current AQI observations</h3>
<p>Real-time air data for the entire United States is at your finger tips. <em>EPA’s AirNow</em> maintains a publicly accessible folder of current air monitoring data at <a href="https://files.airnowtech.org/" class="uri">https://files.airnowtech.org/</a>. Data retrieved from AirNow is preliminary and may change following quality assurance.</p>
<p><br> <strong>Sample <code>R</code> script</strong></p>
<p>Use the following R code to grab the most recent AQI results for the entire country.</p>
<div class="toggle">
<button class="btn_code">
Show <strong>R</strong> code
</button>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="get-data.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb4-2"><a href="get-data.html#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb4-3"><a href="get-data.html#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="get-data.html#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to AirNow data site</span></span>
<span id="cb4-5"><a href="get-data.html#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#https://files.airnowtech.org/</span></span>
<span id="cb4-6"><a href="get-data.html#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="get-data.html#cb4-7" aria-hidden="true" tabindex="-1"></a>airnow_link <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;https://s3-us-west-1.amazonaws.com//files.airnowtech.org/airnow/today/&quot;</span>,</span>
<span id="cb4-8"><a href="get-data.html#cb4-8" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;HourlyData_&quot;</span>,</span>
<span id="cb4-9"><a href="get-data.html#cb4-9" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">format</span>(<span class="fu">Sys.time</span>() <span class="sc">-</span> <span class="dv">60</span><span class="sc">*</span><span class="dv">75</span>, <span class="st">&quot;%Y%m%d%H&quot;</span>, <span class="at">tz =</span> <span class="st">&quot;GMT&quot;</span>),</span>
<span id="cb4-10"><a href="get-data.html#cb4-10" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;.dat&quot;</span>)</span>
<span id="cb4-11"><a href="get-data.html#cb4-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-12"><a href="get-data.html#cb4-12" aria-hidden="true" tabindex="-1"></a>aqi_now   <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(airnow_link, <span class="st">&quot;|&quot;</span>, </span>
<span id="cb4-13"><a href="get-data.html#cb4-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">col_names =</span> F)</span>
<span id="cb4-14"><a href="get-data.html#cb4-14" aria-hidden="true" tabindex="-1"></a>                        <span class="co">#col_types = c(&#39;cccciccdc&#39;))</span></span>
<span id="cb4-15"><a href="get-data.html#cb4-15" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb4-16"><a href="get-data.html#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Add column names</span></span>
<span id="cb4-17"><a href="get-data.html#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(aqi_now) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;time&quot;</span>, <span class="st">&quot;aqsid&quot;</span>, <span class="st">&quot;city&quot;</span>, <span class="st">&quot;local_time&quot;</span>, <span class="st">&quot;parameter&quot;</span>, <span class="st">&quot;units&quot;</span>, <span class="st">&quot;concentration&quot;</span>, <span class="st">&quot;agency&quot;</span>)</span>
<span id="cb4-18"><a href="get-data.html#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="get-data.html#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="get-data.html#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to Ozone and PM2.5 results</span></span>
<span id="cb4-21"><a href="get-data.html#cb4-21" aria-hidden="true" tabindex="-1"></a>aqi_now <span class="ot">&lt;-</span> <span class="fu">filter</span>(aqi_now, parameter <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;OZONE&quot;</span>, <span class="st">&quot;PM2.5&quot;</span>))</span></code></pre></div>
</div>
</div>
<div id="lims" class="section level3" number="2.1.5">
<h3><span class="header-section-number">2.1.5</span> Retrieving data from LIMS via Tableau</h3>
<p>The LIMS database is the primary data warehouse for AQ monitoring activities. The LIMS system is being retired and replaced. To ease data accessibilty during this transition LIMS data are available for download via an internal Tableau workbook at <a href="http://tableau.pca.state.mn.us/#/workbooks/3342" class="uri">http://tableau.pca.state.mn.us/#/workbooks/3342</a></p>
<p><br> <strong>Sample <code>R</code> script</strong></p>
<p>The following function reads LIMS data from Tableau. All inputs must be provided. The inputs are:</p>
<p>Sites: Integer vector representing site numbers (no state code, county code, or POC)
Parameter_list: Integer vector representing parameters to extract.
Start_date: Character string of date in YYYY-MM-DD format (or other format recognized by ymd())
End_date: Character string of date in YYYY-MM-DD format (or other format recognized by ymd())
Pollutant_Groups: Character vector of pollutant groups to extract. Air toxics include “metals (TSP),” “VOCs,” “carbonyls.”</p>
<div class="toggle">
<button class="btn_code">
Show <strong>R</strong> code
</button>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="get-data.html#cb5-1" aria-hidden="true" tabindex="-1"></a>read_AT_data_tableau <span class="ot">=</span> <span class="cf">function</span>(Sites, Parameter_list, <span class="at">Start_date =</span> <span class="st">&quot;2016-01-01&quot;</span>, <span class="at">End_date =</span> <span class="st">&quot;2016-03-31&quot;</span>, <span class="at">Pollutant_Groups =</span> <span class="fu">c</span>(<span class="st">&quot;metals (TSP)&quot;</span>, <span class="st">&quot;VOCs&quot;</span>, <span class="st">&quot;carbonyls&quot;</span>)) {</span>
<span id="cb5-2"><a href="get-data.html#cb5-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-3"><a href="get-data.html#cb5-3" aria-hidden="true" tabindex="-1"></a>  sample_calendar <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">start         =</span> <span class="st">&quot;2016-01-01&quot;</span>, </span>
<span id="cb5-4"><a href="get-data.html#cb5-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">end           =</span> <span class="st">&quot;2016-12-31&quot;</span>, </span>
<span id="cb5-5"><a href="get-data.html#cb5-5" aria-hidden="true" tabindex="-1"></a>                              <span class="at">day_interval  =</span> <span class="dv">6</span>,</span>
<span id="cb5-6"><a href="get-data.html#cb5-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">type          =</span> <span class="st">&quot;air_toxics&quot;</span>) {</span>
<span id="cb5-7"><a href="get-data.html#cb5-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-8"><a href="get-data.html#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(lubridate)</span>
<span id="cb5-9"><a href="get-data.html#cb5-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-10"><a href="get-data.html#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert &#39;start&#39; and &#39;end&#39; to class date</span></span>
<span id="cb5-11"><a href="get-data.html#cb5-11" aria-hidden="true" tabindex="-1"></a>    start <span class="ot">&lt;-</span> <span class="fu">ymd</span>(start)</span>
<span id="cb5-12"><a href="get-data.html#cb5-12" aria-hidden="true" tabindex="-1"></a>    end   <span class="ot">&lt;-</span> <span class="fu">ymd</span>(end)</span>
<span id="cb5-13"><a href="get-data.html#cb5-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-14"><a href="get-data.html#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set official start date to selected EPA calendar</span></span>
<span id="cb5-15"><a href="get-data.html#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(type <span class="sc">==</span> <span class="st">&quot;air_toxics&quot;</span>) {</span>
<span id="cb5-16"><a href="get-data.html#cb5-16" aria-hidden="true" tabindex="-1"></a>      epa_start <span class="ot">&lt;-</span> <span class="fu">ymd</span>(<span class="st">&quot;1989-12-24&quot;</span>)</span>
<span id="cb5-17"><a href="get-data.html#cb5-17" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb5-18"><a href="get-data.html#cb5-18" aria-hidden="true" tabindex="-1"></a>      epa_start <span class="ot">&lt;-</span> start</span>
<span id="cb5-19"><a href="get-data.html#cb5-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-20"><a href="get-data.html#cb5-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-21"><a href="get-data.html#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create full table of sampling dates</span></span>
<span id="cb5-22"><a href="get-data.html#cb5-22" aria-hidden="true" tabindex="-1"></a>    calendar <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> epa_start, </span>
<span id="cb5-23"><a href="get-data.html#cb5-23" aria-hidden="true" tabindex="-1"></a>                    <span class="at">to   =</span> end, </span>
<span id="cb5-24"><a href="get-data.html#cb5-24" aria-hidden="true" tabindex="-1"></a>                    <span class="at">by   =</span> <span class="fu">paste</span>(day_interval, <span class="st">&quot;days&quot;</span>))</span>
<span id="cb5-25"><a href="get-data.html#cb5-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-26"><a href="get-data.html#cb5-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-27"><a href="get-data.html#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subset to user&#39;s date range</span></span>
<span id="cb5-28"><a href="get-data.html#cb5-28" aria-hidden="true" tabindex="-1"></a>    calendar <span class="ot">&lt;-</span> calendar[calendar <span class="sc">&gt;=</span> start <span class="sc">&amp;</span> calendar <span class="sc">&lt;=</span> end]</span>
<span id="cb5-29"><a href="get-data.html#cb5-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-30"><a href="get-data.html#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(calendar)</span>
<span id="cb5-31"><a href="get-data.html#cb5-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-32"><a href="get-data.html#cb5-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-33"><a href="get-data.html#cb5-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-34"><a href="get-data.html#cb5-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate air toxics sampling dates</span></span>
<span id="cb5-35"><a href="get-data.html#cb5-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-36"><a href="get-data.html#cb5-36" aria-hidden="true" tabindex="-1"></a>  Dates <span class="ot">=</span> <span class="fu">sample_calendar</span>(Start_date, End_date)</span>
<span id="cb5-37"><a href="get-data.html#cb5-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-38"><a href="get-data.html#cb5-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Break dates into quarters</span></span>
<span id="cb5-39"><a href="get-data.html#cb5-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-40"><a href="get-data.html#cb5-40" aria-hidden="true" tabindex="-1"></a>  Quarters <span class="ot">=</span> <span class="fu">quarter</span>(Dates, <span class="at">with_year =</span> T)</span>
<span id="cb5-41"><a href="get-data.html#cb5-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-42"><a href="get-data.html#cb5-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tidyverse)</span>
<span id="cb5-43"><a href="get-data.html#cb5-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-44"><a href="get-data.html#cb5-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert fields to Tableau url format</span></span>
<span id="cb5-45"><a href="get-data.html#cb5-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-46"><a href="get-data.html#cb5-46" aria-hidden="true" tabindex="-1"></a>  base_url <span class="ot">=</span> <span class="st">&quot;http://tableau.pca.state.mn.us/views/exportDailyData/Datawithnullcodes.csv?&quot;</span></span>
<span id="cb5-47"><a href="get-data.html#cb5-47" aria-hidden="true" tabindex="-1"></a>  Sites <span class="ot">=</span> <span class="fu">paste</span>(<span class="fu">paste0</span>(Sites,<span class="st">&quot;-1&quot;</span>, <span class="at">collapse =</span> <span class="st">&quot;,&quot;</span>), <span class="fu">paste0</span>(Sites,<span class="st">&quot;-2&quot;</span>, <span class="at">collapse =</span> <span class="st">&quot;,&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb5-48"><a href="get-data.html#cb5-48" aria-hidden="true" tabindex="-1"></a>  Testnames <span class="ot">=</span> Pollutant_Groups <span class="sc">%&gt;%</span> <span class="fu">url_encode</span>() <span class="sc">%&gt;%</span> <span class="fu">paste0</span>(<span class="at">collapse =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb5-49"><a href="get-data.html#cb5-49" aria-hidden="true" tabindex="-1"></a>  Analytes <span class="ot">=</span> <span class="fu">url_encode</span>(Analytes) <span class="sc">%&gt;%</span> <span class="fu">gsub</span>(<span class="st">&quot;%2c&quot;</span>, <span class="st">&quot;%5C%2C&quot;</span>,.) <span class="sc">%&gt;%</span> <span class="fu">paste0</span>(<span class="at">collapse =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb5-50"><a href="get-data.html#cb5-50" aria-hidden="true" tabindex="-1"></a>  Parameter_list <span class="ot">=</span> <span class="fu">paste0</span>(Parameter_list, <span class="at">collapse =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb5-51"><a href="get-data.html#cb5-51" aria-hidden="true" tabindex="-1"></a>  AT_data <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb5-52"><a href="get-data.html#cb5-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-53"><a href="get-data.html#cb5-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">unique</span>(Quarters) ) {</span>
<span id="cb5-54"><a href="get-data.html#cb5-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-55"><a href="get-data.html#cb5-55" aria-hidden="true" tabindex="-1"></a>  Dates2 <span class="ot">=</span> <span class="fu">paste0</span>(Dates[Quarters <span class="sc">==</span> i], <span class="at">collapse =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb5-56"><a href="get-data.html#cb5-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-57"><a href="get-data.html#cb5-57" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Construct url for Tableau</span></span>
<span id="cb5-58"><a href="get-data.html#cb5-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-59"><a href="get-data.html#cb5-59" aria-hidden="true" tabindex="-1"></a>  url <span class="ot">=</span> <span class="fu">paste0</span>(base_url,</span>
<span id="cb5-60"><a href="get-data.html#cb5-60" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;site%20and%20poc=&quot;</span>, Sites,</span>
<span id="cb5-61"><a href="get-data.html#cb5-61" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;&amp;TESTNAME=&quot;</span>, Testnames,</span>
<span id="cb5-62"><a href="get-data.html#cb5-62" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;&amp;ANALYTES_ANALYTE=&quot;</span>, Analytes,</span>
<span id="cb5-63"><a href="get-data.html#cb5-63" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;&amp;PARAMCODE=&quot;</span>, Parameter_list,</span>
<span id="cb5-64"><a href="get-data.html#cb5-64" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;&amp;RUNDATE=&quot;</span>, Dates2</span>
<span id="cb5-65"><a href="get-data.html#cb5-65" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-66"><a href="get-data.html#cb5-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-67"><a href="get-data.html#cb5-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read data from Tableau server</span></span>
<span id="cb5-68"><a href="get-data.html#cb5-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-69"><a href="get-data.html#cb5-69" aria-hidden="true" tabindex="-1"></a>  AT_data <span class="ot">=</span> <span class="fu">bind_rows</span>(AT_data, <span class="fu">read_csv</span>(url, <span class="at">col_types =</span> <span class="st">&quot;ccccicccd&quot;</span>) )</span>
<span id="cb5-70"><a href="get-data.html#cb5-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-71"><a href="get-data.html#cb5-71" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-72"><a href="get-data.html#cb5-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-73"><a href="get-data.html#cb5-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(AT_data)</span>
<span id="cb5-74"><a href="get-data.html#cb5-74" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="AirVision" class="section level3" number="2.1.6">
<h3><span class="header-section-number">2.1.6</span> Retrieving continuous data from AirVision</h3>
<p>AirVision is the data acquistion and temporary storage database for continuous air monitoring data. Data collected in AirVision is transfered to LIMs and AQS for final data storage. If you need the most recent monitoring observations and would like to access continuous data before it has been transfered to the final data repository you can run reports from AirVision.</p>
<p>To run reports, the AirVision client must be installed on your computer and you need a user account. Contact the Air Monitoring Supervisor to request credentials. Alternatively, an AirVision administator can create a report task that will generate a data report and send it to a specified location (FTP site or e-mail).</p>
</div>
<div id="monitors" class="section level3" number="2.1.7">
<h3><span class="header-section-number">2.1.7</span> AirNow:Active AQI monitors</h3>
<p>A map of MPCA’s air monitoring network is available online at <a href="https://www.pca.state.mn.us/air/minnesota-air-monitoring-sites">Minnesota air monitoring sites</a>.</p>
<p>A list of all active AQI monitoring locations around the United States are published to <a href="https://files.airnowtech.org/?prefix=airnow/today/"><em>AirNow</em></a> in the <code>monitoring_site_locations.dat</code> file.</p>
<p><br> <strong>Sample <code>R</code> script</strong></p>
<p>Click the button below to view a step by step example.</p>
<div class="toggle">
<button class="btn_code">
Show <strong>R</strong> code
</button>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="get-data.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb6-2"><a href="get-data.html#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb6-3"><a href="get-data.html#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="get-data.html#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to AirNow data site</span></span>
<span id="cb6-5"><a href="get-data.html#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#https://files.airnowtech.org/</span></span>
<span id="cb6-6"><a href="get-data.html#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="get-data.html#cb6-7" aria-hidden="true" tabindex="-1"></a>airnow_link <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;https://s3-us-west-1.amazonaws.com//files.airnowtech.org/airnow/today/&quot;</span>,</span>
<span id="cb6-8"><a href="get-data.html#cb6-8" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;monitoring_site_locations.dat&quot;</span>)</span>
<span id="cb6-9"><a href="get-data.html#cb6-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-10"><a href="get-data.html#cb6-10" aria-hidden="true" tabindex="-1"></a>aqi_sites   <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(airnow_link, <span class="st">&quot;|&quot;</span>, <span class="at">col_names =</span> F)</span>
<span id="cb6-11"><a href="get-data.html#cb6-11" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb6-12"><a href="get-data.html#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop empty columns</span></span>
<span id="cb6-13"><a href="get-data.html#cb6-13" aria-hidden="true" tabindex="-1"></a>aqi_sites <span class="ot">&lt;-</span> aqi_sites[ , <span class="sc">-</span><span class="fu">c</span>(<span class="dv">14</span><span class="sc">:</span><span class="dv">16</span>,<span class="dv">22</span><span class="sc">:</span><span class="dv">23</span>)]</span>
<span id="cb6-14"><a href="get-data.html#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="get-data.html#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Add column names</span></span>
<span id="cb6-16"><a href="get-data.html#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(aqi_sites) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;aqsid&quot;</span>, </span>
<span id="cb6-17"><a href="get-data.html#cb6-17" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;parameter&quot;</span>, </span>
<span id="cb6-18"><a href="get-data.html#cb6-18" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;local_id&quot;</span>, </span>
<span id="cb6-19"><a href="get-data.html#cb6-19" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;name&quot;</span>, </span>
<span id="cb6-20"><a href="get-data.html#cb6-20" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;status&quot;</span>, </span>
<span id="cb6-21"><a href="get-data.html#cb6-21" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;state_region&quot;</span>, </span>
<span id="cb6-22"><a href="get-data.html#cb6-22" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;agency&quot;</span>, </span>
<span id="cb6-23"><a href="get-data.html#cb6-23" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;epa_region&quot;</span>, </span>
<span id="cb6-24"><a href="get-data.html#cb6-24" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;lat&quot;</span>, </span>
<span id="cb6-25"><a href="get-data.html#cb6-25" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;long&quot;</span>, </span>
<span id="cb6-26"><a href="get-data.html#cb6-26" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;elevation&quot;</span>,</span>
<span id="cb6-27"><a href="get-data.html#cb6-27" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;local_time&quot;</span>,</span>
<span id="cb6-28"><a href="get-data.html#cb6-28" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;country&quot;</span>,</span>
<span id="cb6-29"><a href="get-data.html#cb6-29" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;city&quot;</span>,</span>
<span id="cb6-30"><a href="get-data.html#cb6-30" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;state_fips&quot;</span>,</span>
<span id="cb6-31"><a href="get-data.html#cb6-31" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;state&quot;</span>,</span>
<span id="cb6-32"><a href="get-data.html#cb6-32" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;county_fips&quot;</span>,</span>
<span id="cb6-33"><a href="get-data.html#cb6-33" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;county&quot;</span>)</span>
<span id="cb6-34"><a href="get-data.html#cb6-34" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb6-35"><a href="get-data.html#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="get-data.html#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to Minnesota sites</span></span>
<span id="cb6-37"><a href="get-data.html#cb6-37" aria-hidden="true" tabindex="-1"></a>aqi_sites  <span class="ot">&lt;-</span> <span class="fu">filter</span>(aqi_sites, state_fips <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">27</span>))</span></code></pre></div>
</div>
<p><br></p>
</div>
<div id="EPAsites" class="section level3" number="2.1.8">
<h3><span class="header-section-number">2.1.8</span> EPA Google Earth Site Maps</h3>
<p>The AirData Air Quality Monitors app is a mapping application available on the web and on mobile devices that displays monitor locations and monitor-specific information. It also allows the querying and downloading of data daily and annual summary data. Static KMZ files are also available to download.</p>
<p><a href="https://www.epa.gov/outdoor-air-quality-data/interactive-map-air-quality-monitors" class="uri">https://www.epa.gov/outdoor-air-quality-data/interactive-map-air-quality-monitors</a></p>
</div>
<div id="wairsites" class="section level3" number="2.1.9">
<h3><span class="header-section-number">2.1.9</span> WAIR Site information table</h3>
<p>The WAIR database includes a copy of the EPA site information table, which includes site names and location information.</p>
<p><strong>Sample <code>R</code> script</strong></p>
<p>Click the button below to view a step by step example.</p>
<div class="toggle">
<button class="btn_code">
Show <strong>R</strong> code
</button>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="get-data.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RPostgreSQL)</span>
<span id="cb7-2"><a href="get-data.html#cb7-2" aria-hidden="true" tabindex="-1"></a>username <span class="ot">&lt;-</span> <span class="co">#Add WAIR UserName</span></span>
<span id="cb7-3"><a href="get-data.html#cb7-3" aria-hidden="true" tabindex="-1"></a>pass <span class="ot">&lt;-</span> <span class="co">#Add WAIR password</span></span>
<span id="cb7-4"><a href="get-data.html#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="get-data.html#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Load the PostgreSQL driver</span></span>
<span id="cb7-6"><a href="get-data.html#cb7-6" aria-hidden="true" tabindex="-1"></a>drv <span class="ot">&lt;-</span> <span class="fu">dbDriver</span>(<span class="st">&quot;PostgreSQL&quot;</span>) </span>
<span id="cb7-7"><a href="get-data.html#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="get-data.html#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Open a connection </span></span>
<span id="cb7-9"><a href="get-data.html#cb7-9" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(drv, <span class="at">dbname=</span><span class="st">&quot;wair&quot;</span>,<span class="at">host=</span><span class="st">&#39;eiger&#39;</span>,<span class="at">user=</span>username,<span class="at">password=</span>pass) </span>
<span id="cb7-10"><a href="get-data.html#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="get-data.html#cb7-11" aria-hidden="true" tabindex="-1"></a>sites <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, </span>
<span id="cb7-12"><a href="get-data.html#cb7-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">statement =</span> <span class="fu">paste</span>(</span>
<span id="cb7-13"><a href="get-data.html#cb7-13" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;SELECT *</span></span>
<span id="cb7-14"><a href="get-data.html#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="st">                      FROM wair.aqs.site  \</span></span>
<span id="cb7-15"><a href="get-data.html#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="st">                      &quot;</span></span>
<span id="cb7-16"><a href="get-data.html#cb7-16" aria-hidden="true" tabindex="-1"></a>                    )); </span>
<span id="cb7-17"><a href="get-data.html#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="get-data.html#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con)   <span class="do">## Closes the connection</span></span>
<span id="cb7-19"><a href="get-data.html#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="fu">dbUnloadDriver</span>(drv) <span class="do">## Frees all the resources on the driver</span></span></code></pre></div>
</div>
</div>
<div id="toxics" class="section level3" number="2.1.10">
<h3><span class="header-section-number">2.1.10</span> Air toxics Data Explorer</h3>
<p>View and download summarized air toxics monitoring data results from the online <a href="https://www.pca.state.mn.us/air/air-toxics-data-explorer">Air Toxics Data Explorer</a>.</p>
</div>
<div id="criteria" class="section level3" number="2.1.11">
<h3><span class="header-section-number">2.1.11</span> Criteria Pollutant Data Explorer</h3>
<p>View and download MPCA calculated annual criteria pollutant design values from the online <a href="get-data.html#criteria">Criteria Pollutant Data Explorer</a> (<a href="https://www.pca.state.mn.us/air/criteria-pollutant-data-explorer" class="uri">https://www.pca.state.mn.us/air/criteria-pollutant-data-explorer</a>).</p>
</div>
<div id="AQI" class="section level3" number="2.1.12">
<h3><span class="header-section-number">2.1.12</span> Air Quality Index Summary Reports</h3>
<p>View and download annual AQI Summary Reports (based on final montiroing data) from the online <a href="https://www.pca.state.mn.us/air/annual-aqi-summary-reports">Air Quality Index Data Explorer</a>.</p>
</div>
<div id="PAHs" class="section level3" number="2.1.13">
<h3><span class="header-section-number">2.1.13</span> Air Monitoring for PAHs</h3>
<p>View and download PAH monitoring results from the community and facility based special projects online at <a href="https://www.pca.state.mn.us/air/pah-study-results">Air Monitoring for PAHs</a>.</p>
</div>
<div id="tableau" class="section level3" number="2.1.14">
<h3><span class="header-section-number">2.1.14</span> Internal Data Explorers</h3>
<p>Not all data analysis projects are ready or intended for external audiences. You can find a variety of analzyed monitoring results on the internal Tableau Server.</p>
<ul>
<li><a href="http://tableau.pca.state.mn.us/#/projects/113/workbooks">Air Data Analysis</a></li>
<li><a href="http://tableau.pca.state.mn.us/#/projects/72/workbooks">Air Modeling and Risk Evaluation</a></li>
</ul>
</div>
</div>
<div id="health-and-standards" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Health and standards</h2>
<div id="IHBs" class="section level3" number="2.2.1">
<h3><span class="header-section-number">2.2.1</span> Inhalation health benchmarks (IHBs)</h3>
<p>The inhalation health benchmarks used by MPCA are available on the web in these formats:</p>
<ul>
<li><strong>Web table:</strong> <a href="https://public.tableau.com/profile/mpca.data.services#!/vizhome/Airtoxicityvalues/Airtoxicityvalues" class="uri">https://public.tableau.com/profile/mpca.data.services#!/vizhome/Airtoxicityvalues/Airtoxicityvalues</a></li>
<li><strong>Excel:</strong> <a href="https://www.pca.state.mn.us/sites/default/files/aq9-22.xlsm" class="uri">https://www.pca.state.mn.us/sites/default/files/aq9-22.xlsm</a></li>
<li><strong>CSV:</strong> <a href="https://raw.githubusercontent.com/MPCA-air/health-values/master/Inhalation_Health_Benchmarks(IHBs).csv" class="uri">https://raw.githubusercontent.com/MPCA-air/health-values/master/Inhalation_Health_Benchmarks(IHBs).csv</a></li>
</ul>
<p><br></p>
<p>Use the following R code to fetch the most recent inhalation health benchmarks and references used by MPCA.</p>
<div class="toggle">
<button class="btn_code">
Show <strong>R</strong> code
</button>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="get-data.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb8-2"><a href="get-data.html#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="get-data.html#cb8-3" aria-hidden="true" tabindex="-1"></a>url  <span class="ot">&lt;-</span> <span class="st">&quot;https://raw.githubusercontent.com/MPCA-air/health-values/master/Inhalation_Health_Benchmarks(IHBs).csv&quot;</span></span>
<span id="cb8-4"><a href="get-data.html#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="get-data.html#cb8-5" aria-hidden="true" tabindex="-1"></a>ihbs <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(url) </span></code></pre></div>
</div>
<p><br></p>
</div>
<div id="NAAQS" class="section level3" number="2.2.2">
<h3><span class="header-section-number">2.2.2</span> Air Quality Standards (NAAQS and MAAQS)</h3>
<p>Criteria air pollutants including: particulate (TSP, PM10, PM2.5), ozone, lead, sulfur dioxide, nitrogen dioxide, and carbon monoxide are regulated via ambient air quality standards. Ambient air quality standards are set at the national (NAAQS) and state (MAAQS) level.</p>
<p><strong>NAAQS</strong></p>
<p>The Clean Air Act, which was last amended in 1990, requires EPA to set National Ambient Air Quality Standards (40 CFR part 50) for pollutants considered harmful to public health and the environment. The Clean Air Act identifies two types of national ambient air quality standards. Primary standards provide public health protection, including protecting the health of “sensitive” populations such as asthmatics, children, and the elderly. Secondary standards provide public welfare protection, including protection against decreased visibility and damage to animals, crops, vegetation, and buildings.</p>
<ul>
<li>A summary of current NAAQS is available on EPA’s website:
<ul>
<li><a href="https://www.epa.gov/criteria-air-pollutants/naaqs-table" class="uri">https://www.epa.gov/criteria-air-pollutants/naaqs-table</a></li>
</ul></li>
<li>When calculating NAAQS design values, analysts must follow the procedures defined in the pollutant specific <a href="https://www.ecfr.gov/cgi-bin/text-idx?SID=c118ce8b63f65737a282c4281a59abf0&amp;mc=true&amp;node=pt40.2.50&amp;rgn=div5">appendices to 40 CFR 50</a>.</li>
<li>In August each year, EPA posts official design values here:
<ul>
<li><a href="https://www.epa.gov/air-trends/air-quality-design-values" class="uri">https://www.epa.gov/air-trends/air-quality-design-values</a></li>
</ul></li>
</ul>
<p><br></p>
<p><strong>MAAQS</strong></p>
<p>Minnesota Ambient Air Quality Standards (MAAQS) are established in <a href="https://www.revisor.mn.gov/rules?id=7009&amp;keyword_type=all&amp;keyword=7009&amp;keyword_sg=rule&amp;redirect=0">Minnesota Administrative Rules 7009</a>.</p>
<p>In most cases, the MAAQS are the same as the NAAQS. The MAAQS also include standards for two pollutants that are not covered by the NAAQS: TSP and hydrogen sulfide. The MAAQS were last updated in January 2017.</p>
<p>When calculating MAAQS design values:</p>
<ul>
<li>If MAAQS = NAAQS, use methods described in appendices to 40 CFR 50.</li>
<li>If MAAQS = revoked NAAQS, use methods described in archived appendices to 40 CFR 50.</li>
<li>For MAAQS without a NAAQS, such as H2S, use the “Form of the standard” language to guide your calculations.</li>
</ul>
</div>
</div>
<div id="air-modeling" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Air modeling</h2>
<div id="nata" class="section level3" number="2.3.1">
<h3><span class="header-section-number">2.3.1</span> NATA modeling</h3>
<p>The National Air Toxics Assessment is a nationwide air modeling effort to provide air concentrations and risks for all U.S. census tracts. These results may be pulled from a map project or data tables at <a href="https://www.epa.gov/national-air-toxics-assessment">NATA</a>. After each inventory is completed the Minnesota statewide cumulative air pollution model is compared to these results.</p>
<p><br></p>
</div>
<div id="mnrisks" class="section level3" number="2.3.2">
<h3><span class="header-section-number">2.3.2</span> MNRISKS statewide risk modeling</h3>
<p>MNRISKS is the statewide cumulative air pollution model that is produced by MPCA every three years with the air toxics emissions inventory publication. The model itself produces point estimates for air concentrations and potential human health risks for hundreds of air pollutants across Minnesota. The model also incorporates a date and transport component that produces multi-pathway risk results. Census block group averaged results are available on MPCA’s <a href="https://www.pca.state.mn.us/air/air-modeling-and-human-health">Air modeling and human health</a> webpage.
<br></p>
</div>
<div id="downscale" class="section level3" number="2.3.3">
<h3><span class="header-section-number">2.3.3</span> Downscaler modeling results for Ozone and PM2.5</h3>
<p>Downscaled data <em>(a blend of modeling and monitoring results)</em> are provided by the CDC in cooperation with the EPA for the pollutants ozone and PM-2.5. Daily predicitons are available for each Census tract throughout the country for the years 2001 to 2013.</p>
<ul>
<li>CDC information about this platform is available online at <a href="https://ephtracking.cdc.gov/showAirData.action">https://ephtracking.cdc.gov/showAirData.action</a>.</li>
<li>Data from this platform can be downloaded from the EPA at <a href="https://www.epa.gov/air-research/downscaler-model-predicting-daily-air-pollution">https://www.epa.gov/air-research/downscaler-model-predicting-daily-air-pollution</a>.</li>
<li>Downloaded data filtered to Minnesota results is available internally in the folder: <code>X:\Programs\Air_Quality_Programs\Air Monitoring Data and Risks\6 Air Data\EPA Downscaler Modeling</code>.</li>
</ul>
</div>
<div id="cmaq" class="section level3" number="2.3.4">
<h3><span class="header-section-number">2.3.4</span> CMAQ Ozone modeling</h3>
<p>The Community Multiscale Air Quality Modeling System (CMAQ) is defined by EPA as:</p>
<blockquote>
<p>an active open-source project of the EPA that consists of a suite of programs for conducting air quality model simulations. CMAQ combines current knowledge in atmospheric science and air quality modeling, and an open-source framework to deliver fast, technically sound estimates of ozone, particulates, air toxics and acids deposition.</p>
</blockquote>
<p>The information and data from this platform can be found at the following website <a href="https://www.epa.gov/cmaq">CMAQ</a>.</p>
</div>
</div>
<div id="context" class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> Context</h2>
<div id="mn-ei" class="section level3" number="2.4.1">
<h3><span class="header-section-number">2.4.1</span> MN Emissions Inventory</h3>
<p>Every year all facilities (stationary point sources) report criteria pollutant emissions and every three years facilities report air toxics emissions. The EPA and the state of Minnesota emissions inventory team also calculate and report emissions for all other types of emissions sources such as mobile, non-road mobile, and area sources. These non-point emissions are reported every three years with the air toxics emissions. The Minnesota emission inventory is the foundation of MNRISKS. These emissions levels are reported in several data tools on the MPCA website. Their data and the visualization tools can be found on the following website <a href="https://www.pca.state.mn.us/air/emissions-data">https://www.pca.state.mn.us/air/emissions-data</a>.</p>
<p><br></p>
</div>
<div id="nei" class="section level3" number="2.4.2">
<h3><span class="header-section-number">2.4.2</span> EPA’s NEI</h3>
<p>The National Emissions Inventory (NEI) provides air toxics and criteria and air toxic pollutant emissions for the entire U.S. on the same schedule as described in the Minnesota Emissions Inventory section. This information can be found at the following website <a href="https://www.epa.gov/air-emissions-inventories/national-emissions-inventory-nei">https://www.epa.gov/air-emissions-inventories/national-emissions-inventory-nei</a>.</p>
</div>
<div id="fac-coords" class="section level3" number="2.4.3">
<h3><span class="header-section-number">2.4.3</span> Facility locations</h3>
<p>The most recent compilation of facility coordinates was performed for the 2017 emission inventory. This data is available in the <code>INV_SOURCES</code> table found in the <em>RAPIDS</em> schema of MPCA’s <em>DELTA</em> database.</p>
<p>Use the following code to load the current facility coordinates.</p>
<div class="toggle">
<button class="btn_code">
Show <strong>R</strong> code
</button>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="get-data.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This script connects to the MPCA database DELTA. </span></span>
<span id="cb9-2"><a href="get-data.html#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># A dplyr query collects source coordinates from the RAPIDS schema.</span></span>
<span id="cb9-3"><a href="get-data.html#cb9-3" aria-hidden="true" tabindex="-1"></a>                                                                          </span>
<span id="cb9-4"><a href="get-data.html#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages</span></span>
<span id="cb9-5"><a href="get-data.html#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb9-6"><a href="get-data.html#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RODBC)</span>
<span id="cb9-7"><a href="get-data.html#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span></code></pre></div>
<p>You can view available database connections in R using the function <code>odbcDataSources()</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="get-data.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">odbcDataSources</span>()</span></code></pre></div>
<pre><code>##                  PostgreSQL35W                         deltaw 
##      &quot;PostgreSQL Unicode(x64)&quot; &quot;Oracle in OraClient11g_home2&quot; 
##       Amazon Redshift ODBC DSN 
##        &quot;Amazon Redshift (x64)&quot;</code></pre>
<p><br></p>
<p>To connect to <code>deltaw</code>, use the function <code>odbcConnect()</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="get-data.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load credentials</span></span>
<span id="cb12-2"><a href="get-data.html#cb12-2" aria-hidden="true" tabindex="-1"></a>credentials <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/R/R_Camp/Student Folder/credentials.csv&quot;</span>)</span>
<span id="cb12-3"><a href="get-data.html#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="get-data.html#cb12-4" aria-hidden="true" tabindex="-1"></a>user      <span class="ot">&lt;-</span> credentials<span class="sc">$</span>delta_user</span>
<span id="cb12-5"><a href="get-data.html#cb12-5" aria-hidden="true" tabindex="-1"></a>password  <span class="ot">&lt;-</span> credentials<span class="sc">$</span>delta_pwd</span>
<span id="cb12-6"><a href="get-data.html#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="get-data.html#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternatively, use your own</span></span>
<span id="cb12-8"><a href="get-data.html#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#user      &lt;- &quot;ta*******&quot;</span></span>
<span id="cb12-9"><a href="get-data.html#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#password  &lt;- &quot;da**_*******&quot;</span></span>
<span id="cb12-10"><a href="get-data.html#cb12-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-11"><a href="get-data.html#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to DELTA</span></span>
<span id="cb12-12"><a href="get-data.html#cb12-12" aria-hidden="true" tabindex="-1"></a>deltaw <span class="ot">&lt;-</span> <span class="fu">odbcConnect</span>(<span class="st">&quot;deltaw&quot;</span>, </span>
<span id="cb12-13"><a href="get-data.html#cb12-13" aria-hidden="true" tabindex="-1"></a>                      <span class="at">uid =</span> user, </span>
<span id="cb12-14"><a href="get-data.html#cb12-14" aria-hidden="true" tabindex="-1"></a>                      <span class="at">pwd =</span> password,</span>
<span id="cb12-15"><a href="get-data.html#cb12-15" aria-hidden="true" tabindex="-1"></a>                      <span class="at">believeNRows =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-16"><a href="get-data.html#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="get-data.html#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="get-data.html#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Show all tables in RAPIDS schema</span></span>
<span id="cb12-19"><a href="get-data.html#cb12-19" aria-hidden="true" tabindex="-1"></a>rapids_tbls <span class="ot">&lt;-</span> <span class="fu">sqlTables</span>(deltaw, <span class="at">tableType =</span> <span class="st">&quot;TABLE&quot;</span>, <span class="at">schema =</span> <span class="st">&quot;RAPIDS&quot;</span>)  </span>
<span id="cb12-20"><a href="get-data.html#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="get-data.html#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(rapids_tbls)</span></code></pre></div>
<pre><code>##   TABLE_CAT TABLE_SCHEM         TABLE_NAME TABLE_TYPE REMARKS
## 1      &lt;NA&gt;      RAPIDS     GEO_ACTIVITIES      TABLE    &lt;NA&gt;
## 2      &lt;NA&gt;      RAPIDS       GEO_COUNTIES      TABLE    &lt;NA&gt;
## 3      &lt;NA&gt;      RAPIDS        GEO_NATIONS      TABLE    &lt;NA&gt;
## 4      &lt;NA&gt;      RAPIDS        GEO_REGIONS      TABLE    &lt;NA&gt;
## 5      &lt;NA&gt;      RAPIDS GEO_REGION_MEMBERS      TABLE    &lt;NA&gt;
## 6      &lt;NA&gt;      RAPIDS         GEO_STATES      TABLE    &lt;NA&gt;</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="get-data.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get inventory year codes</span></span>
<span id="cb14-2"><a href="get-data.html#cb14-2" aria-hidden="true" tabindex="-1"></a>inv_codes  <span class="ot">&lt;-</span> <span class="fu">sqlQuery</span>(deltaw, <span class="st">&quot;SELECT * FROM RAPIDS.INV_INVENTORIES&quot;</span>, <span class="at">max =</span> <span class="dv">100</span>, <span class="at">stringsAsFactors =</span> F)</span>
<span id="cb14-3"><a href="get-data.html#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="get-data.html#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get code for 2017</span></span>
<span id="cb14-5"><a href="get-data.html#cb14-5" aria-hidden="true" tabindex="-1"></a>inv_id  <span class="ot">&lt;-</span> <span class="fu">filter</span>(inv_codes, INVENTORY_YEAR <span class="sc">==</span> <span class="dv">2017</span>)<span class="sc">$</span>RID</span>
<span id="cb14-6"><a href="get-data.html#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="get-data.html#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get sources for inventory year</span></span>
<span id="cb14-8"><a href="get-data.html#cb14-8" aria-hidden="true" tabindex="-1"></a>sources   <span class="ot">&lt;-</span> <span class="fu">sqlQuery</span>(deltaw, <span class="fu">paste0</span>(<span class="st">&quot;SELECT * FROM RAPIDS.INV_SOURCES WHERE INVENTORY_RID = &quot;</span>, inv_id),</span>
<span id="cb14-9"><a href="get-data.html#cb14-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">max              =</span> <span class="dv">10000</span>, </span>
<span id="cb14-10"><a href="get-data.html#cb14-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">stringsAsFactors =</span> F, </span>
<span id="cb14-11"><a href="get-data.html#cb14-11" aria-hidden="true" tabindex="-1"></a>                        <span class="at">as.is            =</span> T)</span>
<span id="cb14-12"><a href="get-data.html#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="get-data.html#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="get-data.html#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Get source coordinates</span></span>
<span id="cb14-15"><a href="get-data.html#cb14-15" aria-hidden="true" tabindex="-1"></a>src_coords   <span class="ot">&lt;-</span> <span class="fu">sqlQuery</span>(deltaw, <span class="st">&quot;SELECT * FROM RAPIDS.INV_COORDINATES&quot;</span>,</span>
<span id="cb14-16"><a href="get-data.html#cb14-16" aria-hidden="true" tabindex="-1"></a>                        <span class="at">max              =</span> <span class="dv">100000</span>, </span>
<span id="cb14-17"><a href="get-data.html#cb14-17" aria-hidden="true" tabindex="-1"></a>                        <span class="at">stringsAsFactors =</span> F, </span>
<span id="cb14-18"><a href="get-data.html#cb14-18" aria-hidden="true" tabindex="-1"></a>                        <span class="at">as.is            =</span> T)</span>
<span id="cb14-19"><a href="get-data.html#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="get-data.html#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="get-data.html#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Join coordinates to sources</span></span>
<span id="cb14-22"><a href="get-data.html#cb14-22" aria-hidden="true" tabindex="-1"></a>sources <span class="ot">&lt;-</span> <span class="fu">left_join</span>(sources, src_coords, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;RID&quot;</span> <span class="ot">=</span> <span class="st">&quot;ENTITY_RID&quot;</span>))</span>
<span id="cb14-23"><a href="get-data.html#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="get-data.html#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="get-data.html#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co"># View data </span></span>
<span id="cb14-26"><a href="get-data.html#cb14-26" aria-hidden="true" tabindex="-1"></a>sources <span class="sc">%&gt;%</span> <span class="fu">select</span>(SOURCE_ID, SOURCE_TYPE, SOURCE_NAME, LONGITUDE, LATITUDE) <span class="sc">%&gt;%</span> <span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 9,426
## Columns: 5
## $ SOURCE_ID   &lt;chr&gt; &quot;2799000257&quot;, &quot;2703700102&quot;, &quot;2706900014&quot;, &quot;2708900012&quot;, &quot;2~
## $ SOURCE_TYPE &lt;chr&gt; &quot;POINT&quot;, &quot;POINT&quot;, &quot;POINT&quot;, &quot;POINT&quot;, &quot;POINT&quot;, &quot;POINT&quot;, &quot;POI~
## $ SOURCE_NAME &lt;chr&gt; &quot;Gravel Products Inc&quot;, &quot;Great Lakes Coca-Cola Distribution~
## $ LONGITUDE   &lt;chr&gt; NA, &quot;-93.153&quot;, &quot;-97.0603&quot;, &quot;-96.2385&quot;, &quot;-95.2051&quot;, &quot;-93.38~
## $ LATITUDE    &lt;chr&gt; NA, &quot;44.8567&quot;, &quot;48.9907&quot;, &quot;48.2558&quot;, &quot;47.5853&quot;, &quot;45.111953~</code></pre>
</div>
</div>
<div id="wx-obs" class="section level3" number="2.4.4">
<h3><span class="header-section-number">2.4.4</span> Weather observations</h3>
<p>Historical meteorological observations are available from multiple sources.</p>
<p><strong>Raw data</strong></p>
<ol style="list-style-type: decimal">
<li>An internal Tableau workbook provides raw results for Minnesota meteorological stations: <a href="tableau.pca.state.mn.us/#/workbooks/5714">tableau.pca.state.mn.us/#/workbooks/5714</a>.</li>
</ol>
<p><strong>Quality assured data</strong></p>
<ol style="list-style-type: decimal">
<li>The AQI forecast uses a web API provided by <a href="https://darksky.net/dev"><em>DarkSky</em></a> for current forecast information and quality assured historical observations.</li>
</ol>
</div>
<div id="hysplit" class="section level3" number="2.4.5">
<h3><span class="header-section-number">2.4.5</span> HYSPLIT wind trajectories</h3>
<p>Wind trajectories are useful for determining the primary sources contributing to elevated air monitoring results. Trajectory results for the air monitoring netowork are available in WAIR for the years 2007 to 2017. The R package <a href="https://github.com/rich-iannone/SplitR">SplitR</a> was used to automate HYSPLIT modeling for each air monitoring location.</p>
<p>Use the following code to query WAIR for HYSPLIT results.</p>
<div class="toggle">
<button class="btn_code">
Show <strong>R</strong> code
</button>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="get-data.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This script connects to the MPCA database WAIR.  </span></span>
<span id="cb16-2"><a href="get-data.html#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># A dplyr query collects HYSPLIT modeling results for Anoka Airport.</span></span>
<span id="cb16-3"><a href="get-data.html#cb16-3" aria-hidden="true" tabindex="-1"></a>                                                                                </span>
<span id="cb16-4"><a href="get-data.html#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="get-data.html#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages</span></span>
<span id="cb16-6"><a href="get-data.html#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb16-7"><a href="get-data.html#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="get-data.html#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Open a connection to the database WAIR, schema hys ##</span></span>
<span id="cb16-9"><a href="get-data.html#cb16-9" aria-hidden="true" tabindex="-1"></a>my_wair <span class="ot">&lt;-</span> <span class="fu">src_postgres</span>(<span class="at">dbname =</span> <span class="st">&#39;wair&#39;</span>, <span class="at">host =</span> <span class="st">&quot;eiger&quot;</span>, <span class="at">user =</span> <span class="st">&quot;username&quot;</span>, <span class="at">password =</span> <span class="st">&quot;password&quot;</span>)</span>
<span id="cb16-10"><a href="get-data.html#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="get-data.html#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Show tables</span></span>
<span id="cb16-12"><a href="get-data.html#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="fu">src_tbls</span>(my_wair) <span class="sc">%&gt;%</span> <span class="fu">sort</span>()</span>
<span id="cb16-13"><a href="get-data.html#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="get-data.html#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="get-data.html#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to hys.backtrajectory table ##</span></span>
<span id="cb16-16"><a href="get-data.html#cb16-16" aria-hidden="true" tabindex="-1"></a>hys <span class="ot">&lt;-</span> <span class="fu">tbl</span>(my_wair, <span class="st">&quot;hys.backtrajectory&quot;</span>)</span>
<span id="cb16-17"><a href="get-data.html#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="get-data.html#cb16-18" aria-hidden="true" tabindex="-1"></a>hys <span class="ot">&lt;-</span> <span class="fu">tbl</span>(my_wair, <span class="fu">sql</span>(<span class="st">&#39;hys.backtrajectory&#39;</span>))</span>
<span id="cb16-19"><a href="get-data.html#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="get-data.html#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect data for Anoka Airport after year 2010 ##</span></span>
<span id="cb16-21"><a href="get-data.html#cb16-21" aria-hidden="true" tabindex="-1"></a>hys_mpls  <span class="ot">&lt;-</span> hys <span class="sc">%&gt;%</span> </span>
<span id="cb16-22"><a href="get-data.html#cb16-22" aria-hidden="true" tabindex="-1"></a>               <span class="fu">select</span>(<span class="sc">-</span>the_geom) <span class="sc">%&gt;%</span></span>
<span id="cb16-23"><a href="get-data.html#cb16-23" aria-hidden="true" tabindex="-1"></a>               <span class="fu">filter</span>(site_catid <span class="sc">==</span> <span class="st">&quot;27-003-1002&quot;</span>, yr <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb16-24"><a href="get-data.html#cb16-24" aria-hidden="true" tabindex="-1"></a>               <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">2000</span>)</span>
<span id="cb16-25"><a href="get-data.html#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="get-data.html#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="co"># View data </span></span>
<span id="cb16-27"><a href="get-data.html#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(hys_mpls)</span></code></pre></div>
</div>
</div>
<div id="landuse" class="section level3" number="2.4.6">
<h3><span class="header-section-number">2.4.6</span> Land use maps</h3>
<p>Land use shapefiles are maintained by MPCA GIS technical staff and stored on the agency R-drive at <code>R:\landuse_landcover</code>.</p>
</div>
<div id="census" class="section level3" number="2.4.7">
<h3><span class="header-section-number">2.4.7</span> United States Census boundaries</h3>
<p>Census boundaries can be loaded into R for mapping air data to Census tracts and block groups.</p>
<p>Use the following code to download and map MN boundaries.</p>
<div class="toggle">
<button class="btn_code">
Show <strong>R</strong> code
</button>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="get-data.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This script downloads shapefiles of Minnesota </span></span>
<span id="cb17-2"><a href="get-data.html#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Counties</span></span>
<span id="cb17-3"><a href="get-data.html#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Census tracts</span></span>
<span id="cb17-4"><a href="get-data.html#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Census Block groups  </span></span>
<span id="cb17-5"><a href="get-data.html#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="get-data.html#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages</span></span>
<span id="cb17-7"><a href="get-data.html#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tigris)</span>
<span id="cb17-8"><a href="get-data.html#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="get-data.html#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load boundaries</span></span>
<span id="cb17-10"><a href="get-data.html#cb17-10" aria-hidden="true" tabindex="-1"></a>county_bounds <span class="ot">&lt;-</span> <span class="fu">counties</span>(<span class="at">state =</span> <span class="st">&quot;MN&quot;</span>, <span class="at">cb =</span> T)</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="get-data.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot </span></span>
<span id="cb18-2"><a href="get-data.html#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(county_bounds, <span class="at">col =</span> <span class="st">&quot;steelblue&quot;</span>)</span></code></pre></div>
<p><img src="air-methods_files/figure-html/county-plot-1.png" width="672" /></p>
<p><strong>Tracts &amp; Block groups</strong></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="get-data.html#cb19-1" aria-hidden="true" tabindex="-1"></a>tract_bounds  <span class="ot">&lt;-</span> <span class="fu">tracts</span>(<span class="at">state =</span> <span class="st">&quot;MN&quot;</span>, <span class="at">cb =</span> T)</span>
<span id="cb19-2"><a href="get-data.html#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="get-data.html#cb19-3" aria-hidden="true" tabindex="-1"></a>bg_bounds     <span class="ot">&lt;-</span> <span class="fu">block_groups</span>(<span class="at">state =</span> <span class="st">&quot;MN&quot;</span>, <span class="at">cb =</span> T)</span></code></pre></div>
</div>
</div>
<div id="acs" class="section level3" number="2.4.8">
<h3><span class="header-section-number">2.4.8</span> American Community Survey (ACS)</h3>
<p>The ACS provides updated demographic statistics used for population estimates and Environmental Justice indicators.</p>
<p>Use the following code to download Minnesota ACS results.</p>
<div class="toggle">
<button class="btn_code">
Show <strong>R</strong> code
</button>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="get-data.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This script downloads American Community Survey (ACS) results for MN</span></span>
<span id="cb20-2"><a href="get-data.html#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="get-data.html#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages</span></span>
<span id="cb20-4"><a href="get-data.html#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidycensus)</span>
<span id="cb20-5"><a href="get-data.html#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="get-data.html#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ACS data requires a Census key</span></span>
<span id="cb20-7"><a href="get-data.html#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Visit: http://api.census.gov/data/key_signup.html</span></span>
<span id="cb20-8"><a href="get-data.html#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="fu">census_api_key</span>(<span class="st">&quot;Your_API_key&quot;</span>)</span>
<span id="cb20-9"><a href="get-data.html#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="get-data.html#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co"># View all ACS variables</span></span>
<span id="cb20-11"><a href="get-data.html#cb20-11" aria-hidden="true" tabindex="-1"></a>acs_variables <span class="ot">&lt;-</span> <span class="fu">load_variables</span>(<span class="dv">2015</span>, <span class="st">&quot;acs5&quot;</span>, <span class="at">cache =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-12"><a href="get-data.html#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="get-data.html#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="get-data.html#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Download 5-yr population estimates for 2015</span></span>
<span id="cb20-15"><a href="get-data.html#cb20-15" aria-hidden="true" tabindex="-1"></a>pops_2015 <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(<span class="at">geography =</span> <span class="st">&quot;tract&quot;</span>, </span>
<span id="cb20-16"><a href="get-data.html#cb20-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">state     =</span> <span class="st">&quot;MN&quot;</span>, </span>
<span id="cb20-17"><a href="get-data.html#cb20-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">variables =</span> <span class="st">&quot;B01003_001&quot;</span>, </span>
<span id="cb20-18"><a href="get-data.html#cb20-18" aria-hidden="true" tabindex="-1"></a>                     <span class="at">survey    =</span> <span class="st">&quot;acs5&quot;</span>, </span>
<span id="cb20-19"><a href="get-data.html#cb20-19" aria-hidden="true" tabindex="-1"></a>                     <span class="at">year      =</span> <span class="dv">2015</span>)</span>
<span id="cb20-20"><a href="get-data.html#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="get-data.html#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="get-data.html#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Download decennial population estimates for 2010</span></span>
<span id="cb20-23"><a href="get-data.html#cb20-23" aria-hidden="true" tabindex="-1"></a>pops_2010 <span class="ot">&lt;-</span> <span class="fu">get_decennial</span>(<span class="at">geography =</span> <span class="st">&quot;tract&quot;</span>, </span>
<span id="cb20-24"><a href="get-data.html#cb20-24" aria-hidden="true" tabindex="-1"></a>                           <span class="at">state     =</span> <span class="st">&quot;MN&quot;</span>, </span>
<span id="cb20-25"><a href="get-data.html#cb20-25" aria-hidden="true" tabindex="-1"></a>                           <span class="at">variables =</span> <span class="st">&quot;P0080001&quot;</span>, </span>
<span id="cb20-26"><a href="get-data.html#cb20-26" aria-hidden="true" tabindex="-1"></a>                           <span class="at">year      =</span> <span class="dv">2010</span>)</span>
<span id="cb20-27"><a href="get-data.html#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="get-data.html#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="get-data.html#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Download household median income for 2015</span></span>
<span id="cb20-30"><a href="get-data.html#cb20-30" aria-hidden="true" tabindex="-1"></a>med_inc_2015 <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(<span class="at">geography =</span> <span class="st">&quot;tract&quot;</span>, </span>
<span id="cb20-31"><a href="get-data.html#cb20-31" aria-hidden="true" tabindex="-1"></a>                        <span class="at">state     =</span> <span class="st">&quot;MN&quot;</span>, </span>
<span id="cb20-32"><a href="get-data.html#cb20-32" aria-hidden="true" tabindex="-1"></a>                        <span class="at">variables =</span> <span class="st">&quot;B19013_001&quot;</span>, </span>
<span id="cb20-33"><a href="get-data.html#cb20-33" aria-hidden="true" tabindex="-1"></a>                        <span class="at">survey    =</span> <span class="st">&quot;acs5&quot;</span>, </span>
<span id="cb20-34"><a href="get-data.html#cb20-34" aria-hidden="true" tabindex="-1"></a>                        <span class="at">year      =</span> <span class="dv">2015</span>)</span></code></pre></div>
</div>
<p><br> <a href="get-data.html#get-data">Back to top</a></p>

</div>
</div>
</div>
<script>
  $(".btn_code").click(function() {
    $(this.parentNode).toggleClass("open");
  });
</script>
  
            </section>

          </div>
        </div>
      </div>
<a href="best-practices.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="quality-assurance-methods.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/MPCA-air/air-methods/edit/master/01-get_data.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["air-methods.pdf", "air-methods.epub"],
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
