<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title></title>
  <meta name="description" content="">
  <meta name="generator" content="bookdown 0.5.2 and GitBook 2.6.7">

  <meta property="og:title" content="" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://github.com/MPCA-air/air-methods" />
  <meta property="og:image" content="https://github.com/MPCA-air/air-methodsimages/cover.jpeg" />
  
  <meta name="github-repo" content="MPCA-air/air-methods" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="" />
  
  
  <meta name="twitter:image" content="https://github.com/MPCA-air/air-methodsimages/cover.jpeg" />




  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="completeness-checks-dorian-cassie.html">
<link rel="next" href="site-comparisons-derek-cassie.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-0.9/htmlwidgets.js"></script>
<script src="libs/datatables-binding-0.2/datatables.js"></script>
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.12/js/jquery.dataTables.min.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://mpca-air.github.io/air-methods">Methods for air data analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="data-cleaning-dorian-cassie.html"><a href="data-cleaning-dorian-cassie.html"><i class="fa fa-check"></i><b>1</b> Data cleaning (Dorian &amp; Cassie)</a><ul>
<li class="chapter" data-level="1.1" data-path="data-cleaning-dorian-cassie.html"><a href="data-cleaning-dorian-cassie.html#missing"><i class="fa fa-check"></i><b>1.1</b> Remove blank, NULL, and missing values</a></li>
<li class="chapter" data-level="1.2" data-path="data-cleaning-dorian-cassie.html"><a href="data-cleaning-dorian-cassie.html#quals"><i class="fa fa-check"></i><b>1.2</b> Remove <em>Qualified</em> data</a></li>
<li class="chapter" data-level="1.3" data-path="data-cleaning-dorian-cassie.html"><a href="data-cleaning-dorian-cassie.html#dups"><i class="fa fa-check"></i><b>1.3</b> Duplicate observations</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-validation-kristie.html"><a href="data-validation-kristie.html"><i class="fa fa-check"></i><b>2</b> Data validation (Kristie)</a><ul>
<li class="chapter" data-level="2.1" data-path="data-validation-kristie.html"><a href="data-validation-kristie.html#leaks"><i class="fa fa-check"></i><b>2.1</b> Identifying Instrument drift or leaks in a system.</a></li>
<li class="chapter" data-level="2.2" data-path="data-validation-kristie.html"><a href="data-validation-kristie.html#outs"><i class="fa fa-check"></i><b>2.2</b> Identify exceptional and extreme values aka outliers.</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="collocated-monitors-derek.html"><a href="collocated-monitors-derek.html"><i class="fa fa-check"></i><b>3</b> Collocated monitors (Derek)</a><ul>
<li class="chapter" data-level="3.1" data-path="collocated-monitors-derek.html"><a href="collocated-monitors-derek.html#evalpocs"><i class="fa fa-check"></i><b>3.1</b> Evaluate collocated air monitors (POCs)</a></li>
<li class="chapter" data-level="3.2" data-path="collocated-monitors-derek.html"><a href="collocated-monitors-derek.html#pripocs"><i class="fa fa-check"></i><b>3.2</b> Prioritize multiple air monitors (POCs)</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html"><i class="fa fa-check"></i><b>4</b> Detection limits (Kristie &amp; Cassie)</a><ul>
<li class="chapter" data-level="4.1" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#method-detection-limit---definition"><i class="fa fa-check"></i><b>4.1</b> Method Detection Limit - Definition</a></li>
<li class="chapter" data-level="4.2" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#procedure-for-calculating-method-detection-limits"><i class="fa fa-check"></i><b>4.2</b> Procedure for calculating method detection limits</a></li>
<li class="chapter" data-level="4.3" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#finding-detection-limits-cassie"><i class="fa fa-check"></i><b>4.3</b> Finding detection limits (Cassie)</a></li>
<li class="chapter" data-level="4.4" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#qualifier-codes-for-detection-limits"><i class="fa fa-check"></i><b>4.4</b> Qualifier Codes for Detection Limits</a></li>
<li class="chapter" data-level="4.5" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#below-detection-values-kristie"><i class="fa fa-check"></i><b>4.5</b> Below detection values (Kristie)</a><ul>
<li class="chapter" data-level="" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#example-charts-for-visualizing-data-below-detection-limits"><i class="fa fa-check"></i>Example charts for visualizing data below detection limits</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#multiple-detection-limits"><i class="fa fa-check"></i><b>4.6</b> Multiple detection limits</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="completeness-checks-dorian-cassie.html"><a href="completeness-checks-dorian-cassie.html"><i class="fa fa-check"></i><b>5</b> Completeness checks (Dorian &amp; Cassie)</a><ul>
<li class="chapter" data-level="5.1" data-path="completeness-checks-dorian-cassie.html"><a href="completeness-checks-dorian-cassie.html#complete"><i class="fa fa-check"></i><b>5.1</b> Completeness checks</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="summary-statistics.html"><a href="summary-statistics.html"><i class="fa fa-check"></i><b>6</b> Summary statistics</a><ul>
<li class="chapter" data-level="6.1" data-path="summary-statistics.html"><a href="summary-statistics.html#boots"><i class="fa fa-check"></i><b>6.1</b> Bootstrapping (Dorian)</a></li>
<li class="chapter" data-level="6.2" data-path="summary-statistics.html"><a href="summary-statistics.html#below"><i class="fa fa-check"></i><b>6.2</b> Below the detection limit</a></li>
<li class="chapter" data-level="6.3" data-path="summary-statistics.html"><a href="summary-statistics.html#confidence"><i class="fa fa-check"></i><b>6.3</b> Confidence intervals (Derek)</a></li>
<li class="chapter" data-level="6.4" data-path="summary-statistics.html"><a href="summary-statistics.html#incomplete"><i class="fa fa-check"></i><b>6.4</b> Annual summaries for incomplete data</a></li>
<li class="chapter" data-level="6.5" data-path="summary-statistics.html"><a href="summary-statistics.html#health"><i class="fa fa-check"></i><b>6.5</b> Comparison of data to inhalation health benchmarks (Kristie)</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="site-comparisons-derek-cassie.html"><a href="site-comparisons-derek-cassie.html"><i class="fa fa-check"></i><b>7</b> Site comparisons (Derek &amp; Cassie)</a><ul>
<li class="chapter" data-level="7.1" data-path="site-comparisons-derek-cassie.html"><a href="site-comparisons-derek-cassie.html#confidence-intervals"><i class="fa fa-check"></i><b>7.1</b> Confidence intervals</a></li>
<li class="chapter" data-level="7.2" data-path="site-comparisons-derek-cassie.html"><a href="site-comparisons-derek-cassie.html#tools-to-visualize-data"><i class="fa fa-check"></i><b>7.2</b> Tools to visualize data</a></li>
<li class="chapter" data-level="7.3" data-path="site-comparisons-derek-cassie.html"><a href="site-comparisons-derek-cassie.html#correlation-matrices-cassie"><i class="fa fa-check"></i><b>7.3</b> Correlation matrices (Cassie)</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="start-finish.html"><a href="start-finish.html"><i class="fa fa-check"></i><b>8</b> Start to finish (all hands on deck)</a></li>
<li class="chapter" data-level="9" data-path="charts.html"><a href="charts.html"><i class="fa fa-check"></i><b>9</b> Charts</a><ul>
<li class="chapter" data-level="9.1" data-path="charts.html"><a href="charts.html#boxplots-dorian"><i class="fa fa-check"></i><b>9.1</b> Boxplots (Dorian)</a><ul>
<li class="chapter" data-level="9.1.1" data-path="charts.html"><a href="charts.html#log-boxplot"><i class="fa fa-check"></i><b>9.1.1</b> Log boxplot</a></li>
<li class="chapter" data-level="9.1.2" data-path="charts.html"><a href="charts.html#outliers"><i class="fa fa-check"></i><b>9.1.2</b> Outliers</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="charts.html"><a href="charts.html#calendar-plots-cassie"><i class="fa fa-check"></i><b>9.2</b> Calendar plots (Cassie)</a></li>
<li class="chapter" data-level="9.3" data-path="charts.html"><a href="charts.html#colors-dorian"><i class="fa fa-check"></i><b>9.3</b> Colors (Dorian)</a></li>
<li class="chapter" data-level="9.4" data-path="charts.html"><a href="charts.html#openair-package-derek-cassie"><i class="fa fa-check"></i><b>9.4</b> <em>openair</em> package (Derek &amp; Cassie)</a></li>
<li class="chapter" data-level="9.5" data-path="charts.html"><a href="charts.html#pollution-roses-and-love-poems-derek"><i class="fa fa-check"></i><b>9.5</b> Pollution roses and love poems (Derek)</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="time-series.html"><a href="time-series.html"><i class="fa fa-check"></i><b>10</b> Time series</a><ul>
<li class="chapter" data-level="10.1" data-path="time-series.html"><a href="time-series.html#seasonality"><i class="fa fa-check"></i><b>10.1</b> Seasonality</a></li>
<li class="chapter" data-level="10.2" data-path="time-series.html"><a href="time-series.html#changepoints-before-after-tests"><i class="fa fa-check"></i><b>10.2</b> Changepoints (before &amp; after tests)</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="maps-kristie.html"><a href="maps-kristie.html"><i class="fa fa-check"></i><b>11</b> Maps (Kristie)</a><ul>
<li class="chapter" data-level="11.1" data-path="maps-kristie.html"><a href="maps-kristie.html#kriging"><i class="fa fa-check"></i><b>11.1</b> Kriging</a></li>
<li class="chapter" data-level="11.2" data-path="maps-kristie.html"><a href="maps-kristie.html#spatial-averaging-and-aggregation"><i class="fa fa-check"></i><b>11.2</b> Spatial averaging and aggregation</a></li>
<li class="chapter" data-level="11.3" data-path="maps-kristie.html"><a href="maps-kristie.html#creating-shapefiles-in-r-adn-joining-to-ej-areas"><i class="fa fa-check"></i><b>11.3</b> Creating shapefiles in R adn joining to EJ areas</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="additional-resources-kristie.html"><a href="additional-resources-kristie.html"><i class="fa fa-check"></i><b>12</b> Additional resources (Kristie)</a></li>
<li class="chapter" data-level="" data-path="edit-this-book.html"><a href="edit-this-book.html"><i class="fa fa-check"></i>Edit this book</a></li>
<li class="divider"></li>
<li><a href="https://github.com/MPCA-air" target="blank">Created by MPCA-air</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="summary-statistics" class="section level1">
<h1><span class="header-section-number"></span> Summary statistics</h1>
<p><img src="https://d21ii91i3y6o6h.cloudfront.net/gallery_images/from_proof/12936/large/1464301097/number-rcatladies.png" width="40%" style="display: block; margin: auto;" /></p>
<p>The summary methods described in this chapter inlcude:</p>
<p><a href="summary-statistics.html#boots">6.1</a> <strong>Bootstrapping</strong><br />
<a href="summary-statistics.html#below">6.2</a> <strong>Below the detection limit</strong><br />
<a href="summary-statistics.html#confidence">6.3</a> <strong>Confidence intervals</strong><br />
<a href="summary-statistics.html#incomplete">6.4</a> <strong>Annual summaries for incomplete data</strong><br />
<a href="summary-statistics.html#health">6.5</a> <strong>Comparison of data to inhalation health benchmarks</strong></p>
<p><br></p>
<p><strong>Notes</strong></p>
<p>Data must be tested for normality prior to determining what type of summarization to report. In general environmental data are non-normal and skewed towards the low end of detrection (left skewed). Many normality tests exist and they cary in sensitivity. A good article for the lay person can be found at this link:</p>
<p>When to use a arithmetic or geometric mean:</p>
<ul>
<li>Use an arithmetic mean when your data are normal and there are less than 5% below detection limit values per year/analyte/site [Kristie made up the 5%, but there is an EPA document looking at the impacts of BDL data. Will cite and incorporate.].</li>
<li>For non-automated scripts: Use a geometric mean if your data are log-normally distributed and there are less than 5% below detection limit values per year/analyte/site.</li>
</ul>
<div id="boots" class="section level2">
<h2><span class="header-section-number">6.1</span> Bootstrapping (Dorian)</h2>
<p>Bootstrapping provides methods for calculating summary statistics without making assumptions about whether the data is sampled from a normal dirstribution.</p>
<p>Packages</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(readr)</code></pre></div>
<p>Our data is organized by monitoring site and date. Here’s a sample.</p>
<table>
<thead>
<tr>
<th style="text-align:right;">
AQS_ID
</th>
<th style="text-align:left;">
Date
</th>
<th style="text-align:right;">
Conc
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
270535501
</td>
<td style="text-align:left;">
2009-07-30
</td>
<td style="text-align:right;">
0.00148
</td>
</tr>
<tr>
<td style="text-align:right;">
270535501
</td>
<td style="text-align:left;">
2009-09-30
</td>
<td style="text-align:right;">
0.00064
</td>
</tr>
<tr>
<td style="text-align:right;">
270535501
</td>
<td style="text-align:left;">
2009-11-30
</td>
<td style="text-align:right;">
0.34256
</td>
</tr>
<tr>
<td style="text-align:right;">
270535501
</td>
<td style="text-align:left;">
2009-12-30
</td>
<td style="text-align:right;">
0.00064
</td>
</tr>
<tr>
<td style="text-align:right;">
270535502
</td>
<td style="text-align:left;">
2009-03-30
</td>
<td style="text-align:right;">
0.26219
</td>
</tr>
<tr>
<td style="text-align:right;">
270535502
</td>
<td style="text-align:left;">
2009-07-30
</td>
<td style="text-align:right;">
0.01113
</td>
</tr>
<tr>
<td style="text-align:right;">
270535502
</td>
<td style="text-align:left;">
2009-09-30
</td>
<td style="text-align:right;">
0.00044
</td>
</tr>
<tr>
<td style="text-align:right;">
270535502
</td>
<td style="text-align:left;">
2009-11-30
</td>
<td style="text-align:right;">
0.00127
</td>
</tr>
<tr>
<td style="text-align:right;">
270535502
</td>
<td style="text-align:left;">
2009-12-30
</td>
<td style="text-align:right;">
0.00113
</td>
</tr>
</tbody>
</table>
<p>Bootstrap function</p>
<p>We currently use the <code>EnvStats</code> package to generate our summary values. It has built in functions to account for non-detect data and allows for different distributions. However, if you’re not dealing with non-detects you can use a simple loop to boot things yourself.</p>
<p>Before you start you’ll want to set the random number generator to ensure you’ll be able to reproduce your results. I’ll use <code>#27</code> below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">27</span>)</code></pre></div>
<p>The general idea is to take a random sample from the data set, generate the statistic that you’re interested in, record it, then rinse and repeat. Below is the code for how to resample a single site.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Filter data to a single site</span>
df_site1 &lt;-<span class="st"> </span><span class="kw">filter</span>(df, AQS_ID <span class="op">==</span><span class="st"> </span>AQS_ID[<span class="dv">1</span>])

<span class="co"># Pull random sample</span>
<span class="co"># `replace=T` allows for the same value to be pulled multiple times</span>
<span class="co"># `size=nrow(df)` ensures the number of observations in the new table to match the original </span>
random_df &lt;-<span class="st"> </span><span class="kw">sample</span>(df_site1<span class="op">$</span>Conc, <span class="dt">replace=</span>T)

<span class="co"># Generate summary statistic</span>
<span class="kw">quantile</span>(random_df, <span class="fl">0.1</span>)</code></pre></div>
<pre><code>##     10% 
## 0.00064</code></pre>
<p>To repeat this 3,000 times we can wrap these steps into a <code>resample</code> function, and then use <code>sapply</code> to collect the results.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create  resample function</span>
resample_Conc &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">data=</span> df_site1<span class="op">$</span>Conc, <span class="dt">Conc_pct=</span> <span class="fl">0.10</span>){

random_df &lt;-<span class="st"> </span><span class="kw">sample</span>(data, <span class="dt">replace=</span>T)

<span class="kw">quantile</span>(random_df, Conc_pct, <span class="dt">na.rm=</span>T)[[<span class="dv">1</span>]]

}

<span class="co"># Repeat using `sapply`</span>
repeats &lt;-<span class="st"> </span><span class="dv">3000</span>

booted_10pct &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>repeats, <span class="dt">FUN=</span><span class="cf">function</span>(x) <span class="kw">resample_Conc</span>(df_site1<span class="op">$</span>Conc))

<span class="co"># The 50th percentile or median Conc</span>
<span class="kw">median</span>(booted_10pct, <span class="dt">na.rm=</span>T)</code></pre></div>
<pre><code>## [1] 0.00064</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Return the 95th percentile of the booted concentrations</span>
<span class="kw">quantile</span>(booted_10pct, <span class="fl">0.95</span>, <span class="dt">na.rm=</span>T)[[<span class="dv">1</span>]]</code></pre></div>
<pre><code>## [1] 0.00148</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Force the 95th percentile to be a recorded value</span>
<span class="kw">sort</span>(booted_10pct)[repeats<span class="op">*</span>.<span class="dv">95</span> <span class="op">+</span><span class="dv">1</span>]</code></pre></div>
<pre><code>## [1] 0.00148</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Upper and lower confidence interval around the median</span>
<span class="kw">quantile</span>(booted_10pct, <span class="kw">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>), <span class="dt">na.rm=</span>T)</code></pre></div>
<pre><code>##     2.5%      50%    97.5% 
## 0.000640 0.000640 0.103216</code></pre>
<p>Automate</p>
<p>To finish, put these steps into a <code>boot</code> function and run it on each site by using <code>group_by</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create boot function</span>
boot_low_Conc &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">data=</span>df<span class="op">$</span>Conc, <span class="dt">Conc_pct=</span><span class="fl">0.10</span>, <span class="dt">conf_int=</span><span class="fl">0.95</span>, <span class="dt">repeats=</span><span class="dv">3000</span>){

alpha &lt;-<span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>conf_int)<span class="op">/</span><span class="dv">2</span>

booted_10pct &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="dv">1</span><span class="op">:</span>repeats, <span class="dt">FUN=</span><span class="cf">function</span>(x) <span class="kw">resample_Conc</span>(data, Conc_pct))

<span class="co"># Upper and lower confidence interval around the median</span>
<span class="kw">list</span>(<span class="kw">quantile</span>(booted_10pct, <span class="kw">c</span>(alpha, <span class="fl">0.5</span>, <span class="dv">1</span><span class="op">-</span>alpha), <span class="dt">na.rm=</span>T))

}

<span class="co"># Use `group_by` to send data for each site to your boot function</span>
conc_summary &lt;-<span class="st"> </span><span class="kw">group_by</span>(df, AQS_ID) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                </span><span class="kw">mutate</span>(<span class="dt">boot_results   =</span> <span class="kw">boot_low_Conc</span>(Conc, <span class="dt">Conc_pct=</span><span class="fl">0.10</span>, <span class="dt">conf_int=</span><span class="fl">0.95</span>)) <span class="op">%&gt;%</span>
<span class="st">                </span><span class="kw">summarize</span>(<span class="dt">Conc_10pct  =</span>  <span class="kw">quantile</span>(Conc, <span class="fl">0.10</span>, <span class="dt">na.rm=</span>T)[[<span class="dv">1</span>]],
                <span class="dt">Low_CL95_conc         =</span> <span class="kw">unlist</span>(boot_results[<span class="dv">1</span>])[[<span class="dv">1</span>]], 
                <span class="dt">Boot_conc             =</span> <span class="kw">unlist</span>(boot_results[<span class="dv">1</span>])[[<span class="dv">2</span>]], 
                <span class="dt">Upper_CL95_conc       =</span> <span class="kw">unlist</span>(boot_results[<span class="dv">1</span>])[[<span class="dv">3</span>]])  </code></pre></div>
<p>Results</p>
The booted confidence limits
<table>
<thead>
<tr>
<th style="text-align:right;">
AQS_ID
</th>
<th style="text-align:right;">
Conc_10pct
</th>
<th style="text-align:right;">
Low_CL95_conc
</th>
<th style="text-align:right;">
Boot_conc
</th>
<th style="text-align:right;">
Upper_CL95_conc
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
270535501
</td>
<td style="text-align:right;">
0.000640
</td>
<td style="text-align:right;">
0.00064
</td>
<td style="text-align:right;">
0.000640
</td>
<td style="text-align:right;">
0.103216
</td>
</tr>
<tr>
<td style="text-align:right;">
270535502
</td>
<td style="text-align:right;">
0.000716
</td>
<td style="text-align:right;">
0.00044
</td>
<td style="text-align:right;">
0.000716
</td>
<td style="text-align:right;">
0.005214
</td>
</tr>
</tbody>
</table>
</div>
<div id="below" class="section level2">
<h2><span class="header-section-number">6.2</span> Below the detection limit</h2>
<p>The annual mean or upper confidence limit is considered below the method detection limit when one of the following conditions is true:</p>
<ul>
<li>The number of censored values is greater than 80%.
<ul>
<li>This is based on <em>Cox 2006</em> and MPCA simulations (cite work and results)[www.google.com].</li>
</ul></li>
<li>The annual 95% upper confidence limit is below the method detection limit.</li>
</ul>
</div>
<div id="confidence" class="section level2">
<h2><span class="header-section-number">6.3</span> Confidence intervals (Derek)</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Data must have names&quot;AQS_ID&quot;, &quot;POC&quot;, &quot;Param_Code&quot;, &quot;Date&quot;, &quot;Concentration&quot;, &quot;Null_Data_Code&quot;, &quot;MDL&quot;, &quot;Pollutant&quot;, &quot;Year&quot;, &quot;CAS&quot;</span>
<span class="co"># Data must also have column named &quot;Censored&quot; indicating whether Concentration &lt; MDL</span>
<span class="co"># Data must also have column &quot;ID&quot; with grouping criteria. ID = Site + Pollutant + Year if data has multiple sites, pollutants, and years. If data has only one site, pollutant, or year, then those elements do not need to be included in ID.</span>


<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(EnvStats)
data =<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&#39;https://raw.githubusercontent.com/MPCA-air/air-methods/master/airtoxics_data_2009_2013.csv&#39;</span>, <span class="dt">stringsAsFactors =</span> F)

<span class="kw">names</span>(data)[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;AQS_ID&quot;</span>, <span class="st">&quot;POC&quot;</span>, <span class="st">&quot;Param_Code&quot;</span>, <span class="st">&quot;Date&quot;</span>,<span class="st">&quot;Concentration&quot;</span>,
                       <span class="st">&quot;Null_Data_Code&quot;</span>, <span class="st">&quot;MDL&quot;</span>, <span class="st">&quot;Pollutant&quot;</span>, <span class="st">&quot;Year&quot;</span>, <span class="st">&quot;CAS&quot;</span>)

data =<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(AQS_ID <span class="op">==</span><span class="st"> </span><span class="dv">270370020</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">ID =</span> <span class="kw">paste</span>(Pollutant, Year), <span class="dt">Censored =</span> Concentration <span class="op">&lt;</span><span class="st"> </span>MDL)

UCL_<span class="dv">95</span> =<span class="st"> </span><span class="cf">function</span>(data, <span class="dt">Boot_Repeats =</span> <span class="dv">1000</span>, <span class="dt">seed =</span> <span class="dv">2017</span>) {

  
MLE_est &lt;-<span class="st"> </span><span class="cf">function</span>(data){
    
    results =<span class="st"> </span>data<span class="op">$</span>Concentration
    censored =<span class="st"> </span>data<span class="op">$</span>Censored
    n =<span class="st"> </span><span class="kw">sum</span>(<span class="op">!</span><span class="kw">is.na</span>(data<span class="op">$</span>Concentration))
    
    MLE_means =<span class="st"> </span><span class="ot">NULL</span>
    
    
    <span class="cf">if</span> ( (n <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.75</span> <span class="op">*</span><span class="st"> </span><span class="kw">length</span>(results)) <span class="op">|</span><span class="st"> </span>((<span class="kw">sum</span>(<span class="op">!</span>censored, <span class="dt">na.rm =</span> T) ) <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.2</span> <span class="op">*</span><span class="st"> </span>n) <span class="op">|</span><span class="st"> </span>( <span class="kw">length</span>(<span class="kw">unique</span>(results[<span class="op">!</span><span class="kw">is.na</span>(results) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span>censored] ) ) <span class="op">&lt;</span><span class="st"> </span><span class="dv">2</span> ) ) {
      MLE_means =<span class="st"> </span><span class="ot">NA</span>
    } <span class="cf">else</span>
    {
      
      random.rows =<span class="st"> </span><span class="ot">NULL</span>  
      random.rows &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">which</span>(<span class="op">!</span><span class="kw">is.na</span>(censored) <span class="op">&amp;</span><span class="st"> </span>(<span class="op">!</span>censored) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">duplicated</span>(results) ), <span class="dv">2</span>, <span class="dt">replace =</span> <span class="ot">FALSE</span>)
      random.rows =<span class="st"> </span><span class="kw">c</span>(random.rows, <span class="kw">sample</span>(<span class="kw">which</span>(<span class="op">!</span><span class="kw">is.na</span>(censored)), n<span class="op">-</span><span class="dv">2</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>))
      
      
      <span class="cf">if</span> (<span class="kw">sum</span>(censored[random.rows], <span class="dt">na.rm =</span> T) <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span>){
        MLE_means =<span class="st"> </span><span class="kw">mean</span>(results[random.rows])  
      }
      
      <span class="cf">else</span> {
        MLE_means =<span class="st"> </span><span class="kw">exp</span> (<span class="kw">elnormCensored</span>(results[random.rows] <span class="op">+</span><span class="st"> </span><span class="fl">1e-16</span>,
                                        censored[random.rows],
                                        <span class="dt">method =</span> <span class="st">&quot;mle&quot;</span>, 
                                        <span class="dt">ci =</span> F 
        )<span class="op">$</span>parameters[[<span class="dv">1</span>]])
      }
      
    }
    
    <span class="kw">return</span>(MLE_means)
}

<span class="kw">set.seed</span>(seed)

data =<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(ID) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">n =</span> <span class="kw">sum</span>(<span class="op">!</span><span class="kw">is.na</span>(Concentration) ), <span class="st">`</span><span class="dt">% Censored</span><span class="st">`</span> =<span class="st"> </span><span class="kw">sum</span>(Censored, <span class="dt">na.rm =</span> T) <span class="op">*</span><span class="st"> </span><span class="dv">100</span> <span class="op">/</span><span class="st"> </span>n)

site_means =<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(ID) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise</span>(<span class="dt">Mean =</span> <span class="kw">ifelse</span>( <span class="kw">mean</span>(n) <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.75</span> <span class="op">*</span><span class="st"> </span><span class="kw">length</span>(Concentration) <span class="op">|</span><span class="st"> </span><span class="kw">mean</span> (<span class="st">`</span><span class="dt">% Censored</span><span class="st">`</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">80</span> <span class="op">|</span><span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(Concentration[<span class="op">!</span><span class="kw">is.na</span>(Concentration) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span>Censored] ) ) <span class="op">&lt;</span><span class="st"> </span><span class="dv">3</span>, <span class="ot">NA</span>, <span class="kw">ifelse</span> (<span class="kw">any</span>(Censored, <span class="dt">na.rm =</span> T), <span class="kw">exp</span> (<span class="kw">elnormCensored</span>(Concentration <span class="op">+</span><span class="st"> </span><span class="fl">1e-16</span>, Censored, <span class="dt">method =</span> <span class="st">&quot;mle&quot;</span>, <span class="dt">ci =</span> F)<span class="op">$</span>parameters[[<span class="dv">1</span>]]), <span class="kw">mean</span>(Concentration, <span class="dt">na.rm =</span> T) ) ) )

Bootstrap_means =<span class="st"> </span><span class="kw">replicate</span>(Boot_Repeats, (<span class="kw">by</span>(data, data<span class="op">$</span>ID, MLE_est) ) )

UCL =<span class="st"> </span><span class="kw">apply</span>(Bootstrap_means, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="kw">sort</span>(x)[<span class="kw">ceiling</span>(<span class="fl">0.975</span> <span class="op">*</span><span class="st"> </span>Boot_Repeats)])

UCL =<span class="st"> </span><span class="kw">cbind</span>(site_means, UCL)

<span class="kw">rownames</span>(UCL) =<span class="st"> </span><span class="ot">NULL</span>

<span class="kw">return</span>(UCL)

}

UCLs =<span class="st"> </span><span class="kw">UCL_95</span>(data)</code></pre></div>
</div>
<div id="incomplete" class="section level2">
<h2><span class="header-section-number">6.4</span> Annual summaries for incomplete data</h2>
</div>
<div id="health" class="section level2">
<h2><span class="header-section-number">6.5</span> Comparison of data to inhalation health benchmarks (Kristie)</h2>
<p>The annual 95% upper confidence limit is compared to chronic inhalation health benchmarks according to the MPCA/MDH hierarchy for inhalation health benchmarks information sources.The ways this is done is different for annual measured data reports (The Air Toxics Data Explorer) or if the comparison is used in a cumulative analysis (cumulative AERA) to inform air permitting or environmental review.</p>
<ul>
<li>Treatment of data for Annual Comparisons of Measured Data to IHBs
<ul>
<li>Chronic values are compared to UCL-95 values that reflect data that meet completeness and non-censored rules discussed in this document. Refer to where the UCL-95s come from in this chapter</li>
<li>Acute health benchmarks are intended for comparison with an hourly max value.Since air toxics measurements are 24 hour integrated samples, the hourly maxima is estimated by multiplying the second highest value by 10. The justification for this estimation stemmed from an analysis comparing hourly gas (NO2) and particle (PM2.5) measurements to 24hour means. (reference this work?) Refer to where the hourly max estimates come from in this chapter.</li>
</ul></li>
<li>Treatment of measured data for use in a cumulative AERA to inform permitting or environmental review
<ul>
<li>A cumulative AERA requires risks summed across pollutants. Since not all pollutants are measured at each monitoring site, means of sites are estimated based on population density. An estimation based on population density is based in the assumption that pollution sources are greater near greater numbers of people. Means are calculated for mid-density sites, and rural sites. Facilities within urban areas are provided risk estimates at hte closest monitor with all pollutants measured.(reference guidance here and do not repeat the guidance that is already written down)</li>
<li>Based somewhat on criteria pollutant guidance for design values, the cumualtive risk estimates determined from monitoring data for cumulative AERAs are the means of the most recent three years of monitored data.</li>
<li>The following scripts estimate 3 year means for measurements of all pollutant data, and compare to inhalation health benchmarks. A mid-script product is a table of the IHBs used by the agency in tabular form, which can be knit individually into a pdf document. (pipe dreams, but I know I can make it real!)</li>
</ul></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#pull all the data</span></code></pre></div>

</div>
</div>
<script>
  $(".btn_code").click(function() {
    $(this.parentNode).toggleClass("open");
  });
</script>
            </section>

          </div>
        </div>
      </div>
<a href="completeness-checks-dorian-cassie.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="site-comparisons-derek-cassie.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/MPCA-air/air-methods/edit/master/07-summary_statistics.Rmd",
"text": "Edit"
},
"download": ["air-methods.pdf"],
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
