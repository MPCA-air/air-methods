<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title></title>
  <meta name="description" content="">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://github.com/MPCA-air/air-methods" />
  <meta property="og:image" content="https://github.com/MPCA-air/air-methodsimages/cover.jpeg" />
  
  <meta name="github-repo" content="MPCA-air/air-methods" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="" />
  
  
  <meta name="twitter:image" content="https://github.com/MPCA-air/air-methodsimages/cover.jpeg" />




  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="summary-statistics.html">
<link rel="next" href="charts.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://mpca-air.github.io/air-methods">Methods for air data analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="data-cleaning-dorian-cassie.html"><a href="data-cleaning-dorian-cassie.html"><i class="fa fa-check"></i><b>1</b> Data cleaning (Dorian &amp; Cassie)</a><ul>
<li class="chapter" data-level="1.1" data-path="data-cleaning-dorian-cassie.html"><a href="data-cleaning-dorian-cassie.html#missing"><i class="fa fa-check"></i><b>1.1</b> Remove blank, NULL, and missing values</a></li>
<li class="chapter" data-level="1.2" data-path="data-cleaning-dorian-cassie.html"><a href="data-cleaning-dorian-cassie.html#quals"><i class="fa fa-check"></i><b>1.2</b> Remove <em>Qualified</em> data</a></li>
<li class="chapter" data-level="1.3" data-path="data-cleaning-dorian-cassie.html"><a href="data-cleaning-dorian-cassie.html#dups"><i class="fa fa-check"></i><b>1.3</b> Duplicate observations</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-validation-kristie.html"><a href="data-validation-kristie.html"><i class="fa fa-check"></i><b>2</b> Data validation (Kristie)</a><ul>
<li class="chapter" data-level="2.1" data-path="data-validation-kristie.html"><a href="data-validation-kristie.html#leaks"><i class="fa fa-check"></i><b>2.1</b> Identifying Instrument drift or leaks in a system.</a></li>
<li class="chapter" data-level="2.2" data-path="data-validation-kristie.html"><a href="data-validation-kristie.html#outs"><i class="fa fa-check"></i><b>2.2</b> Identify exceptional and extreme values aka outliers.</a></li>
<li class="chapter" data-level="2.3" data-path="data-validation-kristie.html"><a href="data-validation-kristie.html#sticky"><i class="fa fa-check"></i><b>2.3</b> Identify sequential repeats aka “sticky” numbers</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="collocated-monitors-derek.html"><a href="collocated-monitors-derek.html"><i class="fa fa-check"></i><b>3</b> Collocated monitors (Derek)</a><ul>
<li class="chapter" data-level="3.1" data-path="collocated-monitors-derek.html"><a href="collocated-monitors-derek.html#evalpocs"><i class="fa fa-check"></i><b>3.1</b> Evaluate collocated air monitors (POCs)</a></li>
<li class="chapter" data-level="3.2" data-path="collocated-monitors-derek.html"><a href="collocated-monitors-derek.html#pripocs"><i class="fa fa-check"></i><b>3.2</b> Prioritize multiple air monitors (POCs)</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html"><i class="fa fa-check"></i><b>4</b> Detection limits (Kristie &amp; Cassie)</a><ul>
<li class="chapter" data-level="4.1" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#method-detection-limit---definition"><i class="fa fa-check"></i><b>4.1</b> Method Detection Limit - Definition</a></li>
<li class="chapter" data-level="4.2" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#procedure-for-calculating-method-detection-limits"><i class="fa fa-check"></i><b>4.2</b> Procedure for calculating method detection limits</a></li>
<li class="chapter" data-level="4.3" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#finding-detection-limits-cassie"><i class="fa fa-check"></i><b>4.3</b> Finding detection limits (Cassie)</a></li>
<li class="chapter" data-level="4.4" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#qualifier-codes-for-detection-limits"><i class="fa fa-check"></i><b>4.4</b> Qualifier Codes for Detection Limits</a></li>
<li class="chapter" data-level="4.5" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#below-detection-values-kristie"><i class="fa fa-check"></i><b>4.5</b> Below detection values (Kristie)</a><ul>
<li class="chapter" data-level="" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#example-charts-for-visualizing-data-below-detection-limits"><i class="fa fa-check"></i>Example charts for visualizing data below detection limits</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#multiple-detection-limits"><i class="fa fa-check"></i><b>4.6</b> Multiple detection limits</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="completeness-checks-dorian-cassie.html"><a href="completeness-checks-dorian-cassie.html"><i class="fa fa-check"></i><b>5</b> Completeness checks (Dorian &amp; Cassie)</a><ul>
<li class="chapter" data-level="5.1" data-path="completeness-checks-dorian-cassie.html"><a href="completeness-checks-dorian-cassie.html#complete"><i class="fa fa-check"></i><b>5.1</b> Completeness checks</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="summary-statistics.html"><a href="summary-statistics.html"><i class="fa fa-check"></i><b>6</b> Summary statistics</a><ul>
<li class="chapter" data-level="6.1" data-path="summary-statistics.html"><a href="summary-statistics.html#boots"><i class="fa fa-check"></i><b>6.1</b> Bootstrapping (Dorian)</a></li>
<li class="chapter" data-level="6.2" data-path="summary-statistics.html"><a href="summary-statistics.html#below"><i class="fa fa-check"></i><b>6.2</b> Below the detection limit</a></li>
<li class="chapter" data-level="6.3" data-path="summary-statistics.html"><a href="summary-statistics.html#confidence"><i class="fa fa-check"></i><b>6.3</b> Confidence intervals (Derek)</a></li>
<li class="chapter" data-level="6.4" data-path="summary-statistics.html"><a href="summary-statistics.html#incomplete"><i class="fa fa-check"></i><b>6.4</b> Annual summaries for incomplete data</a></li>
<li class="chapter" data-level="6.5" data-path="summary-statistics.html"><a href="summary-statistics.html#health"><i class="fa fa-check"></i><b>6.5</b> Comparison of data to inhalation health benchmarks (Kristie)</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="site-comparisons-derek-cassie.html"><a href="site-comparisons-derek-cassie.html"><i class="fa fa-check"></i><b>7</b> Site comparisons (Derek &amp; Cassie)</a><ul>
<li class="chapter" data-level="7.1" data-path="site-comparisons-derek-cassie.html"><a href="site-comparisons-derek-cassie.html#confidence-intervals"><i class="fa fa-check"></i><b>7.1</b> Confidence intervals</a></li>
<li class="chapter" data-level="7.2" data-path="site-comparisons-derek-cassie.html"><a href="site-comparisons-derek-cassie.html#tools-to-visualize-data"><i class="fa fa-check"></i><b>7.2</b> Tools to visualize data</a></li>
<li class="chapter" data-level="7.3" data-path="site-comparisons-derek-cassie.html"><a href="site-comparisons-derek-cassie.html#correlation-matrices-cassie"><i class="fa fa-check"></i><b>7.3</b> Correlation matrices (Cassie)</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="charts.html"><a href="charts.html"><i class="fa fa-check"></i><b>8</b> Charts</a><ul>
<li class="chapter" data-level="8.1" data-path="charts.html"><a href="charts.html#boxplots-dorian"><i class="fa fa-check"></i><b>8.1</b> Boxplots (Dorian)</a><ul>
<li class="chapter" data-level="8.1.1" data-path="charts.html"><a href="charts.html#log-boxplot"><i class="fa fa-check"></i><b>8.1.1</b> Log boxplot</a></li>
<li class="chapter" data-level="8.1.2" data-path="charts.html"><a href="charts.html#outliers"><i class="fa fa-check"></i><b>8.1.2</b> Outliers</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="charts.html"><a href="charts.html#calendar-plots-cassie"><i class="fa fa-check"></i><b>8.2</b> Calendar plots (Cassie)</a></li>
<li class="chapter" data-level="8.3" data-path="charts.html"><a href="charts.html#colors-dorian"><i class="fa fa-check"></i><b>8.3</b> Colors (Dorian)</a></li>
<li class="chapter" data-level="8.4" data-path="charts.html"><a href="charts.html#openair-package-derek-cassie"><i class="fa fa-check"></i><b>8.4</b> <em>openair</em> package (Derek &amp; Cassie)</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="generates-pollution-roses-for-all-air-toxics-for-a-site-and-saves-them-in-a-folder-defined-by-output-path.html"><a href="generates-pollution-roses-for-all-air-toxics-for-a-site-and-saves-them-in-a-folder-defined-by-output-path.html"><i class="fa fa-check"></i><b>9</b> Generates pollution roses for all air toxics for a site and saves them in a folder defined by output_path</a><ul>
<li class="chapter" data-level="9.0.1" data-path="generates-pollution-roses-for-all-air-toxics-for-a-site-and-saves-them-in-a-folder-defined-by-output-path.html"><a href="generates-pollution-roses-for-all-air-toxics-for-a-site-and-saves-them-in-a-folder-defined-by-output-path.html#pollution-roses-and-love-poems-derek"><i class="fa fa-check"></i><b>9.0.1</b> Pollution roses and love poems (Derek)</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="time-series.html"><a href="time-series.html"><i class="fa fa-check"></i><b>10</b> Time series</a><ul>
<li class="chapter" data-level="10.1" data-path="time-series.html"><a href="time-series.html#seasonality"><i class="fa fa-check"></i><b>10.1</b> Seasonality</a></li>
<li class="chapter" data-level="10.2" data-path="time-series.html"><a href="time-series.html#changepoints-before-after-tests"><i class="fa fa-check"></i><b>10.2</b> Changepoints (before &amp; after tests)</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="maps-kristie.html"><a href="maps-kristie.html"><i class="fa fa-check"></i><b>11</b> Maps (Kristie)</a><ul>
<li class="chapter" data-level="11.1" data-path="maps-kristie.html"><a href="maps-kristie.html#kriging"><i class="fa fa-check"></i><b>11.1</b> Kriging</a></li>
<li class="chapter" data-level="11.2" data-path="maps-kristie.html"><a href="maps-kristie.html#spatial-averaging-and-aggregation"><i class="fa fa-check"></i><b>11.2</b> Spatial averaging and aggregation</a></li>
<li class="chapter" data-level="11.3" data-path="maps-kristie.html"><a href="maps-kristie.html#creating-shapefiles-in-r-adn-joining-to-ej-areas"><i class="fa fa-check"></i><b>11.3</b> Creating shapefiles in R adn joining to EJ areas</a></li>
<li class="chapter" data-level="11.4" data-path="maps-kristie.html"><a href="maps-kristie.html#spatial-join-to-census-tracts-and-then-left_join-to-ej-areas-status"><i class="fa fa-check"></i><b>11.4</b> Spatial join to census tracts and then left_join to EJ areas status</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="additional-resources-kristie.html"><a href="additional-resources-kristie.html"><i class="fa fa-check"></i><b>12</b> Additional resources (Kristie)</a></li>
<li class="chapter" data-level="" data-path="edit-this-book.html"><a href="edit-this-book.html"><i class="fa fa-check"></i>Edit this book</a></li>
<li class="divider"></li>
<li><a href="https://github.com/MPCA-air" target="blank">Created by MPCA-air</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="site-comparisons-derek-cassie" class="section level1">
<h1><span class="header-section-number"></span> Site comparisons (Derek &amp; Cassie)</h1>
<p><strong>Notes</strong></p>
<p>Steps:</p>
<ul>
<li>Chart data with box and whisker plots. Some site differences might be very apparent and not require statistical comparisons. [Need to think about what is apparent enough for a visual test, maybe no overlap of box, or only half or less overlap] look at cenboxplot with NADA packages, or use Kristies boxplot with censored values.</li>
<li>Check for normality Chi-squared test (Is normality a valid assumption?). If the data are normal, and there is equal variance [Levenes test–generic script here] complete an ANOVA to compare sites. If there are more than 2 sites, follow with a post hoc test [I say Tukey, but Derek weigh in here].</li>
<li>If the data are not normal, and there is not equal variance [see generic script from above] complete a Kruskal wallis test (but there are other ones if you have &lt; or &gt; 50 samples…look into this). If there are more than 2 sites to compare, use Dunns test for post hoc site by site comparisons [Kristie has a script for this, will make it generic].</li>
</ul>
<div id="confidence-intervals" class="section level2">
<h2><span class="header-section-number">7.1</span> Confidence intervals</h2>
<p>If data is not normal, use bootstraping to generate means for each site and take the differences of those means. If the lower bound of the 95% confidence interval for those differences is greater than zero, or the upper bound is less than zero, then the site means are significantly different. You cannot just genrate confidence intervals for the means individually and see if they overlap since the joint probability of both means being in the same region is lower than the marginal probabilities of each mean being in the region. (Will add code later.)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Data must have names&quot;AQS_ID&quot;, &quot;POC&quot;, &quot;Param_Code&quot;, &quot;Date&quot;, &quot;Concentration&quot;, &quot;Null_Data_Code&quot;, &quot;MDL&quot;, &quot;Pollutant&quot;, &quot;Year&quot;, &quot;CAS&quot;</span>
<span class="co"># Data must also have column named &quot;Censored&quot; indicating whether Concentration &lt; MDL</span>
<span class="co"># Data must also have column &quot;ID&quot; with grouping criteria. ID = Pollutant if only grouping by pollutant, ID = Pollutant + Year if grouping by pollutant &amp; year, ID = Pollutant + Site ID if comparing the same site across multiple years. See example below. Other options for ID are also acceptable depending on type of analysis.</span>

<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(EnvStats)

data =<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&#39;https://raw.githubusercontent.com/MPCA-air/air-methods/master/airtoxics_data_2009_2013.csv&#39;</span>, <span class="dt">stringsAsFactors =</span> F)
<span class="kw">names</span>(data)[<span class="dv">1</span>:<span class="dv">10</span>] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;AQS_ID&quot;</span>, <span class="st">&quot;POC&quot;</span>, <span class="st">&quot;Param_Code&quot;</span>, <span class="st">&quot;Date&quot;</span>,<span class="st">&quot;Concentration&quot;</span>,
                       <span class="st">&quot;Null_Data_Code&quot;</span>, <span class="st">&quot;MDL&quot;</span>, <span class="st">&quot;Pollutant&quot;</span>, <span class="st">&quot;Year&quot;</span>, <span class="st">&quot;CAS&quot;</span>)


site1_data =<span class="st"> </span>data %&gt;%<span class="st"> </span><span class="kw">filter</span>(AQS_ID ==<span class="st"> </span><span class="dv">270370020</span>) %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">ID =</span> <span class="kw">paste</span>(Pollutant, Year), <span class="dt">Censored =</span> Concentration &lt;<span class="st"> </span>MDL)
site2_data =<span class="st"> </span>data %&gt;%<span class="st"> </span><span class="kw">filter</span>(AQS_ID ==<span class="st"> </span><span class="dv">270370470</span>) %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">ID =</span> <span class="kw">paste</span>(Pollutant, Year), <span class="dt">Censored =</span> Concentration &lt;<span class="st"> </span>MDL)



site_comparisons =<span class="st"> </span>function(site1_data, site2_data, <span class="dt">Boot_Repeats =</span> <span class="dv">1000</span>, <span class="dt">seed =</span> <span class="dv">2017</span>) {

  <span class="kw">library</span>(dplyr)
  <span class="kw">library</span>(EnvStats)
  
  MLE_est &lt;-<span class="st"> </span>function(data){
    
    results =<span class="st"> </span>data$Concentration
    censored =<span class="st"> </span>data$Censored
    n =<span class="st"> </span><span class="kw">sum</span>(!<span class="kw">is.na</span>(data$Concentration))
    
    MLE_means =<span class="st"> </span><span class="ot">NULL</span>
    
    
    if ( (n &lt;<span class="st"> </span><span class="fl">0.75</span> *<span class="st"> </span><span class="kw">length</span>(results)) |<span class="st"> </span>((<span class="kw">sum</span>(!censored, <span class="dt">na.rm =</span> T) ) &lt;<span class="st"> </span><span class="fl">0.2</span> *<span class="st"> </span>n) |<span class="st"> </span>( <span class="kw">length</span>(<span class="kw">unique</span>(results[!<span class="kw">is.na</span>(results) &amp;<span class="st"> </span>!censored] ) ) &lt;<span class="st"> </span><span class="dv">2</span> ) ) {
      MLE_means =<span class="st"> </span><span class="ot">NA</span>
    } else
    {
      
      random.rows =<span class="st"> </span><span class="ot">NULL</span>  
      random.rows &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">which</span>(!<span class="kw">is.na</span>(censored) &amp;<span class="st"> </span>(!censored) &amp;<span class="st"> </span>!<span class="kw">duplicated</span>(results) ), <span class="dv">2</span>, <span class="dt">replace =</span> <span class="ot">FALSE</span>)
      random.rows =<span class="st"> </span><span class="kw">c</span>(random.rows, <span class="kw">sample</span>(<span class="kw">which</span>(!<span class="kw">is.na</span>(censored)), n<span class="dv">-2</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>))
      
      
      if (<span class="kw">sum</span>(censored[random.rows], <span class="dt">na.rm =</span> T) &lt;<span class="st"> </span><span class="dv">1</span>){
        MLE_means =<span class="st"> </span><span class="kw">mean</span>(results[random.rows])  
      }
      
      else {
        MLE_means =<span class="st"> </span><span class="kw">exp</span> (<span class="kw">elnormCensored</span>(results[random.rows] +<span class="st"> </span><span class="fl">1e-16</span>,
                                        censored[random.rows],
                                        <span class="dt">method =</span> <span class="st">&quot;mle&quot;</span>, 
                                        <span class="dt">ci =</span> F 
        )$parameters[[<span class="dv">1</span>]])
      }
      
    }
    
    
    
    
    <span class="kw">return</span>(MLE_means)
  }
  
  site1_data =<span class="st"> </span><span class="kw">filter</span>(site1_data, ID %in%<span class="st"> </span><span class="kw">unique</span>(site2_data$ID) )
  site2_data =<span class="st"> </span><span class="kw">filter</span>(site2_data, ID %in%<span class="st"> </span><span class="kw">unique</span>(site1_data$ID) )
  
  <span class="kw">set.seed</span>(seed)
  
  Bootstrap_means1 =<span class="st"> </span><span class="kw">replicate</span>(Boot_Repeats, (<span class="kw">by</span>(site1_data, site1_data$ID, MLE_est) ) )
  Bootstrap_means2 =<span class="st"> </span><span class="kw">replicate</span>(Boot_Repeats, (<span class="kw">by</span>(site2_data, site2_data$ID, MLE_est) ) )
  Bootstrap_diffs =<span class="st"> </span>Bootstrap_means2 -<span class="st"> </span>Bootstrap_means1
  
  CI_lower =<span class="st"> </span><span class="kw">apply</span>(Bootstrap_diffs, <span class="dv">1</span>, function(x) <span class="kw">sort</span>(x)[<span class="kw">floor</span>(<span class="fl">0.025</span> *<span class="st"> </span>Boot_Repeats)])
  CI_upper =<span class="st"> </span><span class="kw">apply</span>(Bootstrap_diffs, <span class="dv">1</span>, function(x) <span class="kw">sort</span>(x)[<span class="kw">ceiling</span>(<span class="fl">0.975</span> *<span class="st"> </span>Boot_Repeats)])
  Higher =<span class="st"> </span>CI_lower &gt;<span class="st"> </span><span class="dv">0</span>
  Lower =<span class="st"> </span>CI_upper &lt;<span class="st"> </span><span class="dv">0</span>
  Same =<span class="st"> </span>!Higher &amp;<span class="st"> </span>!Lower
  
  comparison_table =<span class="st"> </span><span class="ot">NULL</span>
  comparison_table[Lower ==<span class="st"> </span><span class="ot">TRUE</span>] =<span class="st"> &quot;Lower&quot;</span>
  comparison_table[Higher ==<span class="st"> </span><span class="ot">TRUE</span>] =<span class="st"> &quot;Higher&quot;</span>
  comparison_table[Same ==<span class="st"> </span><span class="ot">TRUE</span>] =<span class="st"> &quot;Same&quot;</span>
  
  CI_lower =<span class="st"> </span><span class="kw">data.frame</span>(CI_lower)
  CI_upper =<span class="st"> </span><span class="kw">data.frame</span>(CI_upper)
  comparison_table =<span class="st"> </span><span class="kw">data.frame</span>(comparison_table)
  <span class="kw">rownames</span>(comparison_table) =<span class="st"> </span><span class="kw">rownames</span>(Bootstrap_diffs)
  comparison_table =<span class="st"> </span><span class="kw">cbind</span>(comparison_table, CI_lower, CI_upper)
  <span class="kw">names</span>(comparison_table)[<span class="dv">1</span>]=<span class="st">&quot;Site_comparison&quot;</span>
  <span class="kw">return</span>(comparison_table)
  
}

comparison_table =<span class="st"> </span><span class="kw">site_comparisons</span>(site1_data, site2_data)</code></pre></div>
</div>
<div id="tools-to-visualize-data" class="section level2">
<h2><span class="header-section-number">7.2</span> Tools to visualize data</h2>
<p>Beeswarm</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Data must have names&quot;AQS_ID&quot;, &quot;POC&quot;, &quot;Param_Code&quot;, &quot;Date&quot;, &quot;Concentration&quot;, &quot;Null_Data_Code&quot;, &quot;MDL&quot;, &quot;Pollutant&quot;, &quot;Year&quot;, &quot;CAS&quot;</span>
<span class="co"># Data must also have column named &quot;Censored&quot; indicating whether Concentration &lt; MDL</span>
<span class="co"># Data must also have column &quot;ID&quot; with grouping criteria. ID = Pollutant if only grouping by pollutant, ID = Pollutant + Year if grouping by pollutant &amp; year, ID = Pollutant + Site ID if comparing the same site across multiple years. See example below. Other options for ID are also acceptable depending on type of analysis.</span>

<span class="kw">library</span>(ggbeeswarm)</code></pre></div>
<pre><code>## Loading required package: ggplot2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data =<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&#39;https://raw.githubusercontent.com/MPCA-air/air-methods/master/airtoxics_data_2009_2013.csv&#39;</span>, <span class="dt">stringsAsFactors =</span> F)
<span class="kw">names</span>(data)[<span class="dv">1</span>:<span class="dv">10</span>] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;AQS_ID&quot;</span>, <span class="st">&quot;POC&quot;</span>, <span class="st">&quot;Param_Code&quot;</span>, <span class="st">&quot;Date&quot;</span>,<span class="st">&quot;Concentration&quot;</span>,
                       <span class="st">&quot;Null_Data_Code&quot;</span>, <span class="st">&quot;MDL&quot;</span>, <span class="st">&quot;Pollutant&quot;</span>, <span class="st">&quot;Year&quot;</span>, <span class="st">&quot;CAS&quot;</span>)

data$censored=<span class="kw">ifelse</span>(data$Concentration&lt;data$MDL,T,F)

lead=<span class="kw">subset</span>(data,data$Param_Code==<span class="dv">14129</span> &amp;<span class="st"> </span>data$Year==<span class="dv">2013</span>)
ggplot2::<span class="kw">ggplot</span>(lead,<span class="kw">aes</span>(<span class="dt">y=</span><span class="kw">as.factor</span>(lead$AQS_ID),<span class="dt">x=</span>lead$Concentration,<span class="dt">color=</span>lead$censored))+<span class="kw">geom_quasirandom</span>(<span class="kw">aes</span>(),<span class="dt">groupOnX=</span>F)+<span class="kw">ggtitle</span>(<span class="st">&quot;Lead, 2013 (ug/m3)&quot;</span>)</code></pre></div>
<pre><code>## Warning: Removed 31 rows containing missing values (position_quasirandom).</code></pre>
<p><img src="air-methods_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">arsenic=<span class="kw">subset</span>(data,data$Param_Code==<span class="dv">12103</span> &amp;<span class="st"> </span>data$Year==<span class="dv">2013</span>)
ggplot2::<span class="kw">ggplot</span>(arsenic,<span class="kw">aes</span>(<span class="dt">y=</span><span class="kw">as.factor</span>(arsenic$AQS_ID),<span class="dt">x=</span>arsenic$Concentration,<span class="dt">color=</span>arsenic$censored))+<span class="kw">geom_quasirandom</span>(<span class="kw">aes</span>(),<span class="dt">groupOnX=</span>F)+<span class="kw">ggtitle</span>(<span class="st">&quot;arsenic, 2013 (ug/m3)&quot;</span>)</code></pre></div>
<pre><code>## Warning: Removed 31 rows containing missing values (position_quasirandom).</code></pre>
<p><img src="air-methods_files/figure-html/unnamed-chunk-2-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">benzene=<span class="kw">subset</span>(data,data$Param_Code==<span class="dv">45201</span> &amp;<span class="st"> </span>data$Year==<span class="dv">2013</span>)
ggplot2::<span class="kw">ggplot</span>(benzene,<span class="kw">aes</span>(<span class="dt">y=</span><span class="kw">as.factor</span>(benzene$AQS_ID),<span class="dt">x=</span>benzene$Concentration,<span class="dt">color=</span>benzene$censored))+<span class="kw">geom_quasirandom</span>(<span class="kw">aes</span>(),<span class="dt">groupOnX=</span>F,<span class="dt">varwidth=</span><span class="ot">TRUE</span>)+<span class="kw">ggtitle</span>(<span class="st">&quot;Benzene, 2013 (ug/m3)&quot;</span>)</code></pre></div>
<pre><code>## Warning: Removed 33 rows containing missing values (position_quasirandom).</code></pre>
<p><img src="air-methods_files/figure-html/unnamed-chunk-2-3.png" width="672" /></p>
</div>
<div id="correlation-matrices-cassie" class="section level2">
<h2><span class="header-section-number">7.3</span> Correlation matrices (Cassie)</h2>

</div>
</div>
<script>
  $(".toggle").click(function() {
    $(this).toggleClass("open");
  });
</script>
            </section>

          </div>
        </div>
      </div>
<a href="summary-statistics.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="charts.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/MPCA-air/air-methods/edit/master/08-site_comparisons.Rmd",
"text": "Edit"
},
"download": ["air-methods.pdf"],
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
