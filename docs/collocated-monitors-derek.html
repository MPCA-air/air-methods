<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title></title>
  <meta name="description" content="">
  <meta name="generator" content="bookdown 0.5.2 and GitBook 2.6.7">

  <meta property="og:title" content="" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://github.com/MPCA-air/air-methods" />
  <meta property="og:image" content="https://github.com/MPCA-air/air-methodsimages/cover.jpeg" />
  
  <meta name="github-repo" content="MPCA-air/air-methods" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="" />
  
  
  <meta name="twitter:image" content="https://github.com/MPCA-air/air-methodsimages/cover.jpeg" />




  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="data-validation-kristie.html">
<link rel="next" href="detection-limits-kristie-cassie.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-0.9/htmlwidgets.js"></script>
<script src="libs/datatables-binding-0.2/datatables.js"></script>
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.12/js/jquery.dataTables.min.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://mpca-air.github.io/air-methods">Methods for air data analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a><ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#RQAMD"><i class="fa fa-check"></i><b>0.1</b> Retrieving data from AQS DataMart using RQAMD</a></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#WAIR"><i class="fa fa-check"></i><b>0.2</b> Retrieving data from MPCA WAIR database</a></li>
<li class="chapter" data-level="0.3" data-path="index.html"><a href="index.html#aqi-now"><i class="fa fa-check"></i><b>0.3</b> Current AQI obs</a></li>
<li class="chapter" data-level="0.4" data-path="index.html"><a href="index.html#monitors"><i class="fa fa-check"></i><b>0.4</b> Current AQI observations</a></li>
<li class="chapter" data-level="0.5" data-path="index.html"><a href="index.html#tableau"><i class="fa fa-check"></i><b>0.5</b> Retrieving data from Tableau</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="data-cleaning-dorian-cassie.html"><a href="data-cleaning-dorian-cassie.html"><i class="fa fa-check"></i><b>1</b> Data cleaning (Dorian &amp; Cassie)</a><ul>
<li class="chapter" data-level="1.1" data-path="data-cleaning-dorian-cassie.html"><a href="data-cleaning-dorian-cassie.html#missing"><i class="fa fa-check"></i><b>1.1</b> Remove blank, NULL, and missing values</a></li>
<li class="chapter" data-level="1.2" data-path="data-cleaning-dorian-cassie.html"><a href="data-cleaning-dorian-cassie.html#quals"><i class="fa fa-check"></i><b>1.2</b> Remove <em>Qualified</em> data</a></li>
<li class="chapter" data-level="1.3" data-path="data-cleaning-dorian-cassie.html"><a href="data-cleaning-dorian-cassie.html#dups"><i class="fa fa-check"></i><b>1.3</b> Duplicate observations</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-validation-kristie.html"><a href="data-validation-kristie.html"><i class="fa fa-check"></i><b>2</b> Data validation (Kristie)</a><ul>
<li class="chapter" data-level="2.1" data-path="data-validation-kristie.html"><a href="data-validation-kristie.html#leaks"><i class="fa fa-check"></i><b>2.1</b> Identifying Instrument drift or leaks in a system.</a></li>
<li class="chapter" data-level="2.2" data-path="data-validation-kristie.html"><a href="data-validation-kristie.html#outs"><i class="fa fa-check"></i><b>2.2</b> Identify exceptional and extreme values aka outliers.</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="collocated-monitors-derek.html"><a href="collocated-monitors-derek.html"><i class="fa fa-check"></i><b>3</b> Collocated monitors (Derek)</a><ul>
<li class="chapter" data-level="3.1" data-path="collocated-monitors-derek.html"><a href="collocated-monitors-derek.html#evalpocs"><i class="fa fa-check"></i><b>3.1</b> Evaluate collocated air monitors (POCs)</a></li>
<li class="chapter" data-level="3.2" data-path="collocated-monitors-derek.html"><a href="collocated-monitors-derek.html#pripocs"><i class="fa fa-check"></i><b>3.2</b> Prioritize multiple air monitors (POCs)</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html"><i class="fa fa-check"></i><b>4</b> Detection limits (Kristie &amp; Cassie)</a><ul>
<li class="chapter" data-level="4.1" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#method-detection-limit---definition"><i class="fa fa-check"></i><b>4.1</b> Method Detection Limit - Definition</a></li>
<li class="chapter" data-level="4.2" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#procedure-for-calculating-method-detection-limits"><i class="fa fa-check"></i><b>4.2</b> Procedure for calculating method detection limits</a></li>
<li class="chapter" data-level="4.3" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#finding-detection-limits-cassie"><i class="fa fa-check"></i><b>4.3</b> Finding detection limits (Cassie)</a></li>
<li class="chapter" data-level="4.4" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#qualifier-codes-for-detection-limits"><i class="fa fa-check"></i><b>4.4</b> Qualifier Codes for Detection Limits</a></li>
<li class="chapter" data-level="4.5" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#below-detection-values-kristie"><i class="fa fa-check"></i><b>4.5</b> Below detection values (Kristie)</a><ul>
<li class="chapter" data-level="" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#example-charts-for-visualizing-data-below-detection-limits"><i class="fa fa-check"></i>Example charts for visualizing data below detection limits</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="detection-limits-kristie-cassie.html"><a href="detection-limits-kristie-cassie.html#multiple-detection-limits"><i class="fa fa-check"></i><b>4.6</b> Multiple detection limits</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="completeness-checks-dorian-cassie.html"><a href="completeness-checks-dorian-cassie.html"><i class="fa fa-check"></i><b>5</b> Completeness checks (Dorian &amp; Cassie)</a><ul>
<li class="chapter" data-level="5.1" data-path="completeness-checks-dorian-cassie.html"><a href="completeness-checks-dorian-cassie.html#complete"><i class="fa fa-check"></i><b>5.1</b> Completeness checks</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="summary-statistics.html"><a href="summary-statistics.html"><i class="fa fa-check"></i><b>6</b> Summary statistics</a><ul>
<li class="chapter" data-level="6.1" data-path="summary-statistics.html"><a href="summary-statistics.html#boots"><i class="fa fa-check"></i><b>6.1</b> Bootstrapping (Dorian)</a></li>
<li class="chapter" data-level="6.2" data-path="summary-statistics.html"><a href="summary-statistics.html#below"><i class="fa fa-check"></i><b>6.2</b> Below the detection limit</a></li>
<li class="chapter" data-level="6.3" data-path="summary-statistics.html"><a href="summary-statistics.html#confidence"><i class="fa fa-check"></i><b>6.3</b> Confidence intervals (Derek)</a></li>
<li class="chapter" data-level="6.4" data-path="summary-statistics.html"><a href="summary-statistics.html#incomplete"><i class="fa fa-check"></i><b>6.4</b> Annual summaries for incomplete data</a></li>
<li class="chapter" data-level="6.5" data-path="summary-statistics.html"><a href="summary-statistics.html#health"><i class="fa fa-check"></i><b>6.5</b> Comparison of data to inhalation health benchmarks (Kristie)</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="site-comparisons-derek-cassie.html"><a href="site-comparisons-derek-cassie.html"><i class="fa fa-check"></i><b>7</b> Site comparisons (Derek &amp; Cassie)</a><ul>
<li class="chapter" data-level="7.1" data-path="site-comparisons-derek-cassie.html"><a href="site-comparisons-derek-cassie.html#confidence-intervals"><i class="fa fa-check"></i><b>7.1</b> Confidence intervals</a></li>
<li class="chapter" data-level="7.2" data-path="site-comparisons-derek-cassie.html"><a href="site-comparisons-derek-cassie.html#tools-to-visualize-data"><i class="fa fa-check"></i><b>7.2</b> Tools to visualize data</a></li>
<li class="chapter" data-level="7.3" data-path="site-comparisons-derek-cassie.html"><a href="site-comparisons-derek-cassie.html#correlation-matrices-cassie"><i class="fa fa-check"></i><b>7.3</b> Correlation matrices (Cassie)</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="start-finish.html"><a href="start-finish.html"><i class="fa fa-check"></i><b>8</b> Start to finish (all hands on deck)</a></li>
<li class="chapter" data-level="9" data-path="charts.html"><a href="charts.html"><i class="fa fa-check"></i><b>9</b> Charts</a><ul>
<li class="chapter" data-level="9.1" data-path="charts.html"><a href="charts.html#boxplots-dorian"><i class="fa fa-check"></i><b>9.1</b> Boxplots (Dorian)</a><ul>
<li class="chapter" data-level="9.1.1" data-path="charts.html"><a href="charts.html#log-boxplot"><i class="fa fa-check"></i><b>9.1.1</b> Log boxplot</a></li>
<li class="chapter" data-level="9.1.2" data-path="charts.html"><a href="charts.html#outliers"><i class="fa fa-check"></i><b>9.1.2</b> Outliers</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="charts.html"><a href="charts.html#calendar-plots-cassie"><i class="fa fa-check"></i><b>9.2</b> Calendar plots (Cassie)</a></li>
<li class="chapter" data-level="9.3" data-path="charts.html"><a href="charts.html#colors-dorian"><i class="fa fa-check"></i><b>9.3</b> Colors (Dorian)</a></li>
<li class="chapter" data-level="9.4" data-path="charts.html"><a href="charts.html#openair-package-derek-cassie"><i class="fa fa-check"></i><b>9.4</b> <em>openair</em> package (Derek &amp; Cassie)</a></li>
<li class="chapter" data-level="9.5" data-path="charts.html"><a href="charts.html#pollution-roses-and-love-poems-derek"><i class="fa fa-check"></i><b>9.5</b> Pollution roses and love poems (Derek)</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="time-series.html"><a href="time-series.html"><i class="fa fa-check"></i><b>10</b> Time series</a><ul>
<li class="chapter" data-level="10.1" data-path="time-series.html"><a href="time-series.html#seasonality"><i class="fa fa-check"></i><b>10.1</b> Seasonality</a></li>
<li class="chapter" data-level="10.2" data-path="time-series.html"><a href="time-series.html#changepoints-before-after-tests"><i class="fa fa-check"></i><b>10.2</b> Changepoints (before &amp; after tests)</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="maps-kristie.html"><a href="maps-kristie.html"><i class="fa fa-check"></i><b>11</b> Maps (Kristie)</a><ul>
<li class="chapter" data-level="11.1" data-path="maps-kristie.html"><a href="maps-kristie.html#kriging"><i class="fa fa-check"></i><b>11.1</b> Kriging</a></li>
<li class="chapter" data-level="11.2" data-path="maps-kristie.html"><a href="maps-kristie.html#spatial-averaging-and-aggregation"><i class="fa fa-check"></i><b>11.2</b> Spatial averaging and aggregation</a></li>
<li class="chapter" data-level="11.3" data-path="maps-kristie.html"><a href="maps-kristie.html#creating-shapefiles-in-r-adn-joining-to-ej-areas"><i class="fa fa-check"></i><b>11.3</b> Creating shapefiles in R adn joining to EJ areas</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="additional-resources-kristie.html"><a href="additional-resources-kristie.html"><i class="fa fa-check"></i><b>12</b> Additional resources (Kristie)</a></li>
<li><a href="mpca-data-tools.html#mpca-data-tools"><strong>MPCA data tools</strong></a></li>
<li class="chapter" data-level="13" data-path="aqi-explorer.html"><a href="aqi-explorer.html"><i class="fa fa-check"></i><b>13</b> AQI explorer</a></li>
<li class="chapter" data-level="14" data-path="criteria-pollutant-explorer.html"><a href="criteria-pollutant-explorer.html"><i class="fa fa-check"></i><b>14</b> Criteria pollutant explorer</a></li>
<li class="chapter" data-level="15" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html"><i class="fa fa-check"></i><b>15</b> Air toxics explorer</a><ul>
<li class="chapter" data-level="15.1" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#mpca-air-toxics-methods"><i class="fa fa-check"></i><b>15.1</b> MPCA Air Toxics Methods</a><ul>
<li class="chapter" data-level="15.1.1" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#data-cleaning"><i class="fa fa-check"></i><b>15.1.1</b> Data Cleaning</a></li>
<li class="chapter" data-level="15.1.2" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#data-validation"><i class="fa fa-check"></i><b>15.1.2</b> Data Validation</a></li>
<li class="chapter" data-level="15.1.3" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#parameter-occurrence-codes-pocs"><i class="fa fa-check"></i><b>15.1.3</b> Parameter Occurrence Codes (POCs)</a></li>
<li class="chapter" data-level="15.1.4" data-path="air-toxics-explorer.html"><a href="air-toxics-explorer.html#producing-annual-summaries"><i class="fa fa-check"></i><b>15.1.4</b> Producing Annual Summaries</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="edit-this-book.html"><a href="edit-this-book.html"><i class="fa fa-check"></i>Edit this book</a></li>
<li class="divider"></li>
<li><a href="https://github.com/MPCA-air" target="blank">Created by MPCA-air</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="collocated-monitors-derek" class="section level1">
<h1><span class="header-section-number"></span> Collocated monitors (Derek)</h1>
<p><img src="https://imgs.xkcd.com/comics/box_plot.png" width="95%" /></p>
<p>Analysis steps for collocated monitors include:</p>
<p><a href="collocated-monitors-derek.html#evalpocs">3.1</a> <strong>Evaluate sites with collocated monitors (POCs)</strong><br />
<a href="collocated-monitors-derek.html#pripocs">3.2</a> <strong>Prioritize observations from collocated monitors (POCs)</strong></p>
<div id="evalpocs" class="section level2">
<h2><span class="header-section-number">3.1</span> Evaluate collocated air monitors (POCs)</h2>
<p><strong>Description</strong></p>
<p>Collocated samples are multiple samples taken for a pollutant from the same monitoring site at the same time. Collocated samples provide an extra layer of quality assurance by taking multiple measurements under very similar conditions which helps detect machine, lab, and human error. Depending on the results from collocated monitors, only one of the monitors, or potentially neither may be considered as valid measurements.</p>
<p><br> <strong>Why not keep all the data?</strong></p>
<p>Leaving observations for multiple POCs in the data set is likely to bias calculated summary statistics. For example, consider a site that starts with two monitors operating during the winter months, but after one malfunctions, the site is left with one monitor operating for the remainder of the year. If we were to calculate the annual average for this site, the mean would be biased by having twice as many observations during the winter months. By limiting the number of observations to 1 per day, we can remove the bias due to the extra winter observations.</p>
<p><br> <strong>Recommended steps</strong></p>
<p>Viewing a scatterplot of collocated measurements is suggested as it helps to view both obvious and subtle irregularities between collocated measurements. If there is evidence of bias in one of the monitors (values from one collocated monitor are usually higher than the other), or there is large variance between the collocated monitors (values differ from each other by significant margins), then both collocated monitors need to be investigated further.</p>
<p>EPA recommends that collocated monitors have no higher than a 15% coefficient of variation between their measurements. Calculating the CV for every measurement pair does not make sense as small differences (i.e. 0.001 and 0.002) have the same CV as large differences (i.e. 10 and 20). Therefore, we chose to look at the median CV for each site, pollutant, and year then flag collocated monitors if the median CV is greater than 15 which suggests differences between the collocated monitors are systematic. We only calculate the CV for collocated monitors on days which both have valid measurements greater than or equal to the MDL since there is lower confidence in values below the MDL. We only compare the median CV to the threshold of 15 if there are at least 10 calculated CV values since it does not make sense to flag monitors where only a few values are above detection.</p>
<p>If collocated monitors do not agree, then consult with the lab, field or quality assurance team to determine if there is a problem with one of the POCs. If they determine that one of POCs is reliable and the other is not, then only use data from the reliable POC. If they cannot determine which POC is the problem, then confidence in the measurements from both collocated monitors is reduced and * no measurements taken from either collocated monitor should be used.* More than likely, we will be asked to report results. We will have lower confidence in the accuracy of those results</p>
<p><br> <strong>Notes</strong></p>
<p>Identify bias</p>
<ul>
<li>Pairwise t-test for the POC means? Look at quantiles of differences?</li>
<li>Who should we notify if one POC is higher than the other? Develop a process for this potentially in Air Vision with email notifications to field and lab.</li>
<li>Default option if one is biased higher than the other: Go with higher POC? Go with lower POC? Use mean? Exclude both POCs?</li>
<li>This might be pollutant dependent. Carbon tetrachloride, for example, we can determine which monitor is correct. Formaldehyde is stable enough to somewhat know what is correct. Maybe this is true for 1,3 butadiene too.</li>
<li>Otherwise, take the mean.</li>
<li>Exclude extreme values for the POC or all values for the POC? Need input from laboratory or see the decision criteria above.</li>
<li>Variance: Minimum correlation for both POCs to be valid? Possibly use a R2 of 0.99 (2 significant digits).</li>
<li>May require unique COV for each pollutant or pollutant group.</li>
</ul>
<p>One value above detection, one value below?</p>
<ul>
<li>Derek suggests going with the value above detection. We don’t want to do substitutions unless we have to, so if there are not any problems with the POC above detection, then use the actual measured value. (EPA Data Analysis Workbook?)</li>
</ul>
<p>One value above acute IHB and one value below?</p>
<ul>
<li>First check validity of monitors to see if there are problems with one of the monitors.</li>
<li>If both POCs seem valid, use the mean? (I suggest this because I think it’s the most defensible thing to do. The true concentration is likely between the POCs and the mean is the most unbiased estimate given the 2 POC measurements. If one POC is well above the IHB and one is just barely below, then the true concentration is likely above the IHB. If one POC is just barely above the IHB and the other is well below, then the true concentration is likely below the IHB. We could go with the higher POC if we want to be conservative.)</li>
<li>Pull the highest POC for the daily maximum and the annual second high comparison to acute IHB. Take the mean of the POCS for the UCL-95, assuming both are valid values.</li>
</ul>
<p><br> <strong>Sample <code>R</code> script</strong></p>
<p>POC_check generates scatterplots comparing all POCs in the data. Data must have columns with “AQS_ID”, “POC”, “Param_Code”, “Date”,“Concentration”, “Null_Data_Code”, “MDL”, “Pollutant”, “Year”, “CAS” in order from left to right.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">POC_check =<span class="st"> </span><span class="cf">function</span>(data) {
  <span class="kw">library</span>(tidyverse)
  <span class="kw">library</span>(lubridate)

  
  POC_ratio =<span class="st"> </span><span class="cf">function</span>(Concentration.x, Concentration.y, MDL) {
    
    <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(Concentration.x) <span class="op">&amp;</span><span class="st"> </span>Concentration.x <span class="op">&gt;</span><span class="st"> </span>MDL <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(Concentration.y) <span class="op">&amp;</span><span class="st"> </span>Concentration.y <span class="op">&gt;</span><span class="st"> </span>MDL) {
      <span class="kw">return</span> (Concentration.y <span class="op">/</span><span class="st"> </span>Concentration.x )
    }
    <span class="cf">else</span> {
      <span class="kw">return</span> (<span class="ot">NA</span>)
    }
    
  }
  
  POC_diff =<span class="st"> </span><span class="cf">function</span>(Concentration.x, Concentration.y, MDL) {
    
    <span class="kw">return</span>( <span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.na</span>(Concentration.x) <span class="op">&amp;</span><span class="st"> </span>Concentration.x <span class="op">&gt;</span><span class="st"> </span>MDL <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(Concentration.y) <span class="op">&amp;</span><span class="st"> </span>Concentration.y <span class="op">&gt;</span><span class="st"> </span>MDL, Concentration.y <span class="op">-</span><span class="st"> </span>Concentration.x, <span class="ot">NA</span>) )
    
  }
  
  POC_avg =<span class="st"> </span><span class="cf">function</span>(Concentration.x, Concentration.y, MDL) {
    
    <span class="kw">return</span>( <span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.na</span>(Concentration.x) <span class="op">&amp;</span><span class="st"> </span>Concentration.x <span class="op">&gt;</span><span class="st"> </span>MDL <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(Concentration.y) <span class="op">&amp;</span><span class="st"> </span>Concentration.y <span class="op">&gt;</span><span class="st"> </span>MDL, (Concentration.y <span class="op">+</span><span class="st"> </span>Concentration.x) <span class="op">/</span><span class="st"> </span><span class="dv">2</span> , <span class="ot">NA</span>) )
    
  }
  
  POC_sd =<span class="st"> </span><span class="cf">function</span>(Concentration.x, Concentration.y, MDL) {
    
    <span class="kw">return</span>( <span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.na</span>(Concentration.x) <span class="op">&amp;</span><span class="st"> </span>Concentration.x <span class="op">&gt;</span><span class="st"> </span>MDL <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(Concentration.y) <span class="op">&amp;</span><span class="st"> </span>Concentration.y <span class="op">&gt;</span><span class="st"> </span>MDL, <span class="kw">apply</span>(<span class="kw">rbind</span>(Concentration.x, Concentration.y), <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">sd</span>(x, <span class="dt">na.rm =</span> T) ), <span class="ot">NA</span>) )
    
  }
  
  <span class="kw">names</span>(data)[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;AQS_ID&quot;</span>, <span class="st">&quot;POC&quot;</span>, <span class="st">&quot;Param_Code&quot;</span>, <span class="st">&quot;Date&quot;</span>,<span class="st">&quot;Concentration&quot;</span>,
                   <span class="st">&quot;Null_Data_Code&quot;</span>, <span class="st">&quot;MDL&quot;</span>, <span class="st">&quot;Pollutant&quot;</span>, <span class="st">&quot;Year&quot;</span>, <span class="st">&quot;CAS&quot;</span>)
  data =<span class="st"> </span><span class="kw">select</span>(data, AQS_ID, POC, Date, Concentration, MDL, Pollutant, Year)
  data =<span class="st"> </span><span class="kw">distinct</span>(data)
  POCs =<span class="st"> </span><span class="kw">filter</span>(data, POC <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>)
  data =<span class="st"> </span><span class="kw">filter</span>(data, POC <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)
  POCs =<span class="st"> </span><span class="kw">full_join</span>(data, POCs, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;AQS_ID&quot;</span>, <span class="st">&quot;Pollutant&quot;</span>, <span class="st">&quot;Date&quot;</span>, <span class="st">&quot;MDL&quot;</span>, <span class="st">&quot;Year&quot;</span>))
  POC_differences =<span class="st"> </span>POCs <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">difference =</span> <span class="kw">POC_diff</span>(Concentration.x, Concentration.y, MDL), <span class="dt">average =</span> <span class="kw">POC_avg</span>(Concentration.x, Concentration.y, MDL), <span class="dt">sd =</span> <span class="kw">POC_sd</span>(Concentration.x, Concentration.y, MDL) )
  POC_summary =<span class="st"> </span>POC_differences <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">CV =</span> sd<span class="op">/</span>average <span class="op">*</span><span class="st"> </span><span class="dv">100</span>)
  POC_flag =<span class="st"> </span>POC_summary <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(AQS_ID, Pollutant, Year) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise</span>(<span class="dt">median_CV =</span> <span class="kw">median</span>(CV, <span class="dt">na.rm =</span> T), <span class="dt">n =</span> <span class="kw">sum</span>(<span class="op">!</span><span class="kw">is.na</span>(CV) ) ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">flag =</span> median_CV <span class="op">&gt;</span><span class="st"> </span><span class="dv">15</span> <span class="op">&amp;</span><span class="st"> </span>n <span class="op">&gt;=</span><span class="st"> </span><span class="dv">10</span>)
  
  
  POCs =<span class="st"> </span>POCs <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">Conc =</span> Concentration.y <span class="op">/</span><span class="st"> </span>Concentration.x <span class="op">*</span><span class="st"> </span>(Concentration.x <span class="op">&gt;</span><span class="st"> </span>MDL) <span class="op">*</span><span class="st"> </span>(Concentration.y <span class="op">&gt;</span><span class="st"> </span>MDL))
  POCs =<span class="st"> </span><span class="kw">filter</span>(POCs, <span class="op">!</span><span class="kw">is.na</span>(Conc) <span class="op">&amp;</span><span class="st"> </span>Conc <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>)
  POCs<span class="op">$</span>Unique &lt;-<span class="st"> </span><span class="kw">paste</span>(POCs<span class="op">$</span>AQS_ID, POCs<span class="op">$</span>Pollutant)
  POCs<span class="op">$</span>Date =<span class="st"> </span><span class="kw">as.Date</span>(POCs<span class="op">$</span>Date)
  
  POC_plot =<span class="st"> </span><span class="kw">ggplot</span>(POCs, <span class="kw">aes</span>(Date, Conc)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">scale_x_date</span>() <span class="op">+</span><span class="st"> </span><span class="kw">scale_y_log10</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">facet_wrap</span> ( <span class="op">~</span><span class="st"> </span>Unique) <span class="op">+</span>
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;POC 2 / POC 1 (log scale&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.title.x=</span><span class="kw">element_blank</span>(),
      <span class="dt">axis.text.x=</span><span class="kw">element_blank</span>(),
      <span class="dt">axis.ticks.x=</span><span class="kw">element_blank</span>())
  
  <span class="kw">return</span>(<span class="kw">list</span>(POC_flag, POC_plot) )
}</code></pre></div>
<p><br> <strong>Contributors</strong></p>
<blockquote>
<p>Derek</p>
</blockquote>
<p><strong>References</strong></p>
</div>
<div id="pripocs" class="section level2">
<h2><span class="header-section-number">3.2</span> Prioritize multiple air monitors (POCs)</h2>
<p><strong>Description</strong></p>
<p>If collocated monitors at a site are both considered valid, then a single value must be chosen from multiple collocated values to avoid double-counting values at a single site.</p>
<p><br> <strong>Recommended steps</strong></p>
<p>For air toxics, measurements from collocated monitors are considered equally valid unless there is a specific reason to treat them differently. Therefore, these methods are used for dealing with collocated samples.</p>
<ol style="list-style-type: decimal">
<li><p>If one monitor has a valid measurement, and the other does not, then the valid measurement is used.</p></li>
<li><p>If one monitor has a valid measurement greater than or equal to the MDL and the other has a valid measurement less than the MDL, then the measurement above the MDL is used as a conservative approach as there is greater confidence in the value above the MDL.</p></li>
<li><p>If both monitors have valid measurements above the MDL, then those values are averaged since both values are equally valid and the “true” value is assumed to likely be between the two values.</p></li>
</ol>
<p><br> <strong>Sample <code>R</code> script</strong></p>
<p>Averages POCs. All POCs with valid measurements &gt;= MDL are averaged. If no POC has a valid measurement &gt;= MDL, then all valid measurements are averaged (result will be &lt; MDL and estimated using MLE approximation). If there are no valid measurements, then result will be NA and filtered out later.</p>
<p>Data must have columns with “Monitoring Site”, “AQSID”, “Parameter”, “Pollutant”,“PollutantGroup”, “Date”, “MDL”, “Result”, “Censored”.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">POC_average =<span class="st"> </span><span class="cf">function</span>(data) {
  
  POC_averaging =<span class="st"> </span><span class="cf">function</span>(Result, Censored) {
    
    Result =<span class="st"> </span>Result[<span class="op">!</span><span class="kw">is.na</span>(Result)]
    Censored =<span class="st"> </span>Censored[<span class="op">!</span><span class="kw">is.na</span>(Censored)]
    
    <span class="cf">if</span>(<span class="kw">all</span>(Censored, <span class="dt">na.rm =</span> T)) {
      <span class="kw">return</span> (<span class="kw">mean</span>(Result, <span class="dt">na.rm =</span> T))
    }
    <span class="cf">else</span> {
      <span class="kw">return</span> (<span class="kw">mean</span>(Result[<span class="op">!</span>Censored], <span class="dt">na.rm =</span> T ) )
    }
    
  }
  
  data =<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">Monitoring Site</span><span class="st">`</span>, AQSID, Parameter, Pollutant, PollutantGroup, Date, MDL) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise</span>(<span class="dt">Result =</span> <span class="kw">POC_averaging</span>(Result, MDL), <span class="dt">Censored =</span> <span class="kw">all</span>(Censored, <span class="dt">na.rm =</span> T) ) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Result =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(Result), <span class="ot">NA</span>, Result), <span class="dt">Censored =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(Result), <span class="ot">NA</span>, Censored))
  <span class="kw">return</span> (<span class="kw">select</span>(data, <span class="st">`</span><span class="dt">Monitoring Site</span><span class="st">`</span>, AQSID, Parameter, Pollutant, PollutantGroup, Date, Result, MDL, Censored) )
}</code></pre></div>
<p><br> <strong>Contributors</strong></p>
<blockquote>
<p>Derek</p>
</blockquote>
<p><strong>References</strong></p>

</div>
</div>
<script>
  $(".btn_code").click(function() {
    $(this.parentNode).toggleClass("open");
  });
</script>
            </section>

          </div>
        </div>
      </div>
<a href="data-validation-kristie.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="detection-limits-kristie-cassie.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/MPCA-air/air-methods/edit/master/04-collocated_monitors.Rmd",
"text": "Edit"
},
"download": ["air-methods.pdf"],
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
