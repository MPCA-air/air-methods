<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title></title>
  <meta name="description" content="">
  <meta name="generator" content="bookdown 0.4 and GitBook 2.6.7">

  <meta property="og:title" content="" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://github.com/MPCA-air/air-methods" />
  <meta property="og:image" content="https://github.com/MPCA-air/air-methodsimages/cover.jpeg" />
  
  <meta name="github-repo" content="MPCA-air/air-methods" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="" />
  
  
  <meta name="twitter:image" content="https://github.com/MPCA-air/air-methodsimages/cover.jpeg" />




  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="index.html">
<link rel="next" href="detection-limits.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-0.8/htmlwidgets.js"></script>
<script src="libs/datatables-binding-0.2/datatables.js"></script>
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.12/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.12/js/jquery.dataTables.min.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Methods for air data analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#edit-this-book"><i class="fa fa-check"></i>Edit this book</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="data-cleaning.html"><a href="data-cleaning.html"><i class="fa fa-check"></i><b>1</b> Data cleaning</a><ul>
<li class="chapter" data-level="1.1" data-path="data-cleaning.html"><a href="data-cleaning.html#missing"><i class="fa fa-check"></i><b>1.1</b> Remove blank, NULL, and missing values</a></li>
<li class="chapter" data-level="1.2" data-path="data-cleaning.html"><a href="data-cleaning.html#quals"><i class="fa fa-check"></i><b>1.2</b> Remove <code>Qualified</code> data</a></li>
<li class="chapter" data-level="1.3" data-path="data-cleaning.html"><a href="data-cleaning.html#dups"><i class="fa fa-check"></i><b>1.3</b> Duplicate obersvations</a></li>
<li class="chapter" data-level="1.4" data-path="data-cleaning.html"><a href="data-cleaning.html#pocs"><i class="fa fa-check"></i><b>1.4</b> Multiple air monitors (POCs)</a></li>
<li class="chapter" data-level="1.5" data-path="data-cleaning.html"><a href="data-cleaning.html#outs"><i class="fa fa-check"></i><b>1.5</b> Outliers</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="detection-limits.html"><a href="detection-limits.html"><i class="fa fa-check"></i><b>2</b> Detection limits</a><ul>
<li class="chapter" data-level="2.1" data-path="detection-limits.html"><a href="detection-limits.html#below-detection"><i class="fa fa-check"></i><b>2.1</b> Below detection</a></li>
<li class="chapter" data-level="2.2" data-path="detection-limits.html"><a href="detection-limits.html#multiple-detection-limits"><i class="fa fa-check"></i><b>2.2</b> Multiple detection limits</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="summary-statistics.html"><a href="summary-statistics.html"><i class="fa fa-check"></i><b>3</b> Summary statistics</a><ul>
<li class="chapter" data-level="3.1" data-path="summary-statistics.html"><a href="summary-statistics.html#bootstrapping"><i class="fa fa-check"></i><b>3.1</b> Bootstrapping</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="site-comparisons.html"><a href="site-comparisons.html"><i class="fa fa-check"></i><b>4</b> Site comparisons</a><ul>
<li class="chapter" data-level="4.1" data-path="site-comparisons.html"><a href="site-comparisons.html#confidence-intervals"><i class="fa fa-check"></i><b>4.1</b> Confidence intervals</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="charts.html"><a href="charts.html"><i class="fa fa-check"></i><b>5</b> Charts</a><ul>
<li class="chapter" data-level="5.1" data-path="charts.html"><a href="charts.html#boxplots"><i class="fa fa-check"></i><b>5.1</b> Boxplots</a><ul>
<li class="chapter" data-level="5.1.1" data-path="charts.html"><a href="charts.html#log-boxplot"><i class="fa fa-check"></i><b>5.1.1</b> Log boxplot</a></li>
<li class="chapter" data-level="5.1.2" data-path="charts.html"><a href="charts.html#outliers"><i class="fa fa-check"></i><b>5.1.2</b> Outliers</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="charts.html"><a href="charts.html#calendar-plots"><i class="fa fa-check"></i><b>5.2</b> Calendar plots</a></li>
<li class="chapter" data-level="5.3" data-path="charts.html"><a href="charts.html#tableau"><i class="fa fa-check"></i><b>5.3</b> Tableau</a></li>
<li class="chapter" data-level="5.4" data-path="charts.html"><a href="charts.html#r"><i class="fa fa-check"></i><b>5.4</b> R</a></li>
<li class="chapter" data-level="5.5" data-path="charts.html"><a href="charts.html#wind-pollution-roses"><i class="fa fa-check"></i><b>5.5</b> Wind &amp; pollution roses</a></li>
<li class="chapter" data-level="5.6" data-path="charts.html"><a href="charts.html#openair-package"><i class="fa fa-check"></i><b>5.6</b> <em>openair</em> package</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="time-series.html"><a href="time-series.html"><i class="fa fa-check"></i><b>6</b> Time series</a><ul>
<li class="chapter" data-level="6.1" data-path="time-series.html"><a href="time-series.html#seasonality"><i class="fa fa-check"></i><b>6.1</b> Seasonality</a><ul>
<li class="chapter" data-level="6.1.1" data-path="time-series.html"><a href="time-series.html#sub-sub-section"><i class="fa fa-check"></i><b>6.1.1</b> Sub-sub section</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="time-series.html"><a href="time-series.html#change-points-before-after"><i class="fa fa-check"></i><b>6.2</b> Change points (before &amp; after)</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="maps.html"><a href="maps.html"><i class="fa fa-check"></i><b>7</b> Maps</a><ul>
<li class="chapter" data-level="7.1" data-path="maps.html"><a href="maps.html#kriging"><i class="fa fa-check"></i><b>7.1</b> Kriging</a></li>
<li class="chapter" data-level="7.2" data-path="maps.html"><a href="maps.html#spatial-averaging-and-aggregation"><i class="fa fa-check"></i><b>7.2</b> Spatial averaging and aggregation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="edit-this-book-1.html"><a href="edit-this-book-1.html"><i class="fa fa-check"></i>Edit this book</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/MPCA-air" target="blank">Created by MPCA-air</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-cleaning" class="section level1">
<h1><span class="header-section-number"></span> Data cleaning</h1>
<p><img src="images/data-cleaning.jpg" width="55%" /></p>
<style>
.showopt {
  background-color: #4183c4;
  color: #FFFFFF; 
  width: 104px;
  height: 26px;
  text-align: center;
  vertical-align: middle !important;
  float: right;
  font-family: sans-serif;
  border-radius: 9px;
}

.showopt:hover {
    background-color: #dfe4f2;
    color: #004c93;
}

pre.plot {
  background-color: white !important;
}
</style>
<p>Before jumping into your analysis you’ll want to clean it up with some helpful quality checks and formatting procedures.</p>
<p>These procedures include steps to:</p>
<ul>
<li><a href="data-cleaning.html#missing">1.1</a> <strong>Remove blank, NULL, and missing values</strong><br />
</li>
<li><a href="data-cleaning.html#quals">1.2</a> <strong>Evaluate qualified data</strong><br />
</li>
<li><a href="data-cleaning.html#dups">1.3</a> <strong>Remove duplicate observations</strong></li>
<li><a href="data-cleaning.html#pocs">1.4</a> <strong>Prioritize observations from multiple monitors (POCs)</strong><br />
</li>
<li><a href="data-cleaning.html#outs">1.5</a> <strong>Evaluate outliers</strong></li>
</ul>
<div id="missing" class="section level2">
<h2><span class="header-section-number">1.1</span> Remove blank, NULL, and missing values</h2>
<p><strong>Description</strong><br />
Large monitoring data sets often contain observations with missing concentrations, detection limits or other labeling errors that can lead to incorrect summary statistics if not removed.</p>
<p><br> <strong>Recommended steps</strong></p>
<ol style="list-style-type: decimal">
<li>Identify blank, NULL, <code>-999</code>, and missing values.</li>
<li>Remove those observations.</li>
</ol>
<p><br> <strong>Why not keep them?</strong></p>
<p>Unless you can confirm what the missing values are meant to represent, such as observations below the detection limit, there is not an accurate means to determine the meaning of a missing value.</p>
<p><br> <strong>Sample <code>R</code> script</strong></p>
<p><br> Load the sample monitoring data.</p>
<div class="fold s o">
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)

data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="dt">text =</span> <span class="st">&#39;</span>
<span class="st">aqs_id,poc,param_code,date,conc,null_code,md_limit,pollutant,cas</span>
<span class="st">271231003,1,12101,&quot;2004-01-04&quot;,-999.99,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-01-10&quot;,0.23,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-01-16&quot;,0.35,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-01-22&quot;,0.22,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-01-28&quot;,NA,NA,0.08,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-02-03&quot;,0.07,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-02-09&quot;,0.02,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-02-15&quot;,&quot; &quot;,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-02-21&quot;,0.03,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-02-27&quot;,0.21,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271377001,1,12101,&quot;2007-09-21&quot;,NULL,a,0.04,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271377001,1,12101,&quot;2007-09-21&quot;,0.14,NA,0.04,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">&#39;</span>, <span class="dt">stringsAsFactor =</span> F)</code></pre></div>
</div>
<p><em>Table: Sample monitoring data</em><br />
<div id="htmlwidget-b2d40888fda94f465e41" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b2d40888fda94f465e41">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12"],[271231003,271231003,271231003,271231003,271231003,271231003,271231003,271231003,271231003,271231003,271377001,271377001],[1,1,1,1,1,1,1,1,1,1,1,1],[12101,12101,12101,12101,12101,12101,12101,12101,12101,12101,12101,12101],["2004-01-04","2004-01-10","2004-01-16","2004-01-22","2004-01-28","2004-02-03","2004-02-09","2004-02-15","2004-02-21","2004-02-27","2007-09-21","2007-09-21"],["-999.99","0.23","0.35","0.22",null,"0.07","0.02"," ","0.03","0.21","NULL","0.14"],[null,null,null,null,null,null,null,null,null,null,"a",null],[0.06,0.06,0.06,0.06,0.08,0.06,0.06,0.06,0.06,0.06,0.04,0.04],["Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum"],["7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>aqs_id<\/th>\n      <th>poc<\/th>\n      <th>param_code<\/th>\n      <th>date<\/th>\n      <th>conc<\/th>\n      <th>null_code<\/th>\n      <th>md_limit<\/th>\n      <th>pollutant<\/th>\n      <th>cas<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"autoWidth":true,"searching":false,"ordering":false,"lengthChange":false,"paginate":false,"info":false,"columnDefs":[{"className":"dt-right","targets":[1,2,3,7]},{"orderable":false,"targets":0}],"order":[],"orderClasses":false}},"evals":[],"jsHooks":[]}</script></p>
<p><br> Create function to test for missing concentration values.</p>
<div class="fold s o">
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Test for missing concentrations, non-numeric values, and -999</span>
missing_conc &lt;-<span class="st"> </span>function(x) {
    <span class="kw">is.na</span>(<span class="kw">as.numeric</span>(x)) ||<span class="st"> </span><span class="kw">as.numeric</span>(x) &lt;<span class="st"> </span>-<span class="dv">900</span>
}</code></pre></div>
</div>
<br> Use the <code>missing_conc()</code> function to search for observations with missing concentrations.
<div class="fold s o">
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create a new TRUE/FALSE column labeling each result as missing or not</span>
data &lt;-<span class="st"> </span>data %&gt;%<span class="st"> </span><span class="kw">rowwise</span>() %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">conc_missing =</span> <span class="kw">missing_conc</span>(conc))

<span class="co"># Select all missing observations</span>
missing_values &lt;-<span class="st"> </span><span class="kw">filter</span>(data, conc_missing ==<span class="st"> </span><span class="ot">TRUE</span>) </code></pre></div>
</div>
<p><br> <em>Table: Missing values</em> <div id="htmlwidget-ea1eab54d15aacf921ed" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ea1eab54d15aacf921ed">{"x":{"filter":"none","data":[["1","2","3","4"],[271231003,271231003,271231003,271377001],[1,1,1,1],[12101,12101,12101,12101],["2004-01-04","2004-01-28","2004-02-15","2007-09-21"],["-999.99",null," ","NULL"],[null,null,null,"a"],[0.06,0.08,0.06,0.04],["Aluminum","Aluminum","Aluminum","Aluminum"],["7429-90-5","7429-90-5","7429-90-5","7429-90-5"],[true,true,true,true]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>aqs_id<\/th>\n      <th>poc<\/th>\n      <th>param_code<\/th>\n      <th>date<\/th>\n      <th>conc<\/th>\n      <th>null_code<\/th>\n      <th>md_limit<\/th>\n      <th>pollutant<\/th>\n      <th>cas<\/th>\n      <th>conc_missing<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"autoWidth":true,"searching":false,"ordering":false,"lengthChange":false,"paginate":false,"info":false,"columnDefs":[{"className":"dt-right","targets":[1,2,3,7]},{"orderable":false,"targets":0}],"order":[],"orderClasses":false}},"evals":[],"jsHooks":[]}</script></p>
<br> Remove the blank, NULL, <code>-999</code>, and missing values from the data set.
<div class="fold s o">
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span><span class="kw">filter</span>(data, conc_missing ==<span class="st"> </span><span class="ot">FALSE</span>)</code></pre></div>
</div>
<p><br> <em>Table: The new and improved cleaner data</em><br />
<div id="htmlwidget-ca449170e6369c82ac48" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ca449170e6369c82ac48">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8"],[271231003,271231003,271231003,271231003,271231003,271231003,271231003,271377001],[1,1,1,1,1,1,1,1],[12101,12101,12101,12101,12101,12101,12101,12101],["2004-01-10","2004-01-16","2004-01-22","2004-02-03","2004-02-09","2004-02-21","2004-02-27","2007-09-21"],["0.23","0.35","0.22","0.07","0.02","0.03","0.21","0.14"],[null,null,null,null,null,null,null,null],[0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.04],["Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum"],["7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5"],[false,false,false,false,false,false,false,false]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>aqs_id<\/th>\n      <th>poc<\/th>\n      <th>param_code<\/th>\n      <th>date<\/th>\n      <th>conc<\/th>\n      <th>null_code<\/th>\n      <th>md_limit<\/th>\n      <th>pollutant<\/th>\n      <th>cas<\/th>\n      <th>conc_missing<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"autoWidth":true,"searching":false,"ordering":false,"lengthChange":false,"paginate":false,"info":false,"columnDefs":[{"className":"dt-right","targets":[1,2,3,7]},{"orderable":false,"targets":0}],"order":[],"orderClasses":false}},"evals":[],"jsHooks":[]}</script></p>
<p><br> Create similar functions to test for missing dates, site IDs, detection limits, and parameter codes.</p>
<div class="fold s o">
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Test for missing dates</span>
missing_dates &lt;-<span class="st"> </span>function(x) {
    <span class="kw">is.na</span>(<span class="kw">as.character</span>(x)) ||<span class="st"> </span>
<span class="st">    </span><span class="kw">nchar</span>(<span class="kw">as.character</span>(x)) &gt;<span class="st"> </span><span class="dv">11</span> ||<span class="st"> </span><span class="kw">nchar</span>(<span class="kw">as.character</span>(x)) &lt;<span class="st"> </span><span class="dv">6</span>
}

<span class="co"># Test for missing site IDs</span>
missing_sites &lt;-<span class="st"> </span>function(x) {
    <span class="kw">is.na</span>(<span class="kw">as.character</span>(x)) ||<span class="st"> </span><span class="kw">nchar</span>(<span class="kw">as.character</span>(x)) &lt;<span class="st"> </span><span class="dv">5</span> 
}

<span class="co"># Test for missing detection limits</span>
missing_dls &lt;-<span class="st"> </span>function(x) {
    <span class="kw">is.na</span>(<span class="kw">as.numeric</span>(x)) ||<span class="st"> </span><span class="kw">as.numeric</span>(x) &lt;<span class="st"> </span>-<span class="dv">900</span>
}

<span class="co"># Test for missing parameter code</span>
missing_param &lt;-<span class="st"> </span>function(x) {
    <span class="kw">is.na</span>(<span class="kw">as.numeric</span>(x)) ||<span class="st"> </span><span class="kw">as.numeric</span>(x) &lt;<span class="st"> </span>-<span class="dv">900</span> ||<span class="st"> </span>
<span class="st">    </span><span class="kw">nchar</span>(<span class="kw">as.character</span>(x)) &lt;<span class="st"> </span><span class="dv">5</span> ||<span class="st"> </span><span class="kw">nchar</span>(<span class="kw">as.character</span>(x)) &gt;<span class="st"> </span><span class="dv">9</span>
}</code></pre></div>
</div>
<p><br> To apply all these functions at once, use the following script.</p>
<div class="fold s o">
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create new TRUE/FALSE columns labeling each result as missing or not</span>
<span class="co"># Filter to remove any rows with a missing value</span>
data &lt;-<span class="st"> </span>data %&gt;%<span class="st"> </span>
<span class="st">        </span><span class="kw">rowwise</span>() %&gt;%<span class="st"> </span>
<span class="st">        </span><span class="kw">mutate</span>(<span class="dt">conc_missing   =</span> <span class="kw">missing_conc</span>(conc),
               <span class="dt">date_missing   =</span> <span class="kw">missing_dates</span>(date),
               <span class="dt">site_missing   =</span> <span class="kw">missing_sites</span>(aqs_id),
               <span class="dt">dl_missing     =</span> <span class="kw">missing_dls</span>(md_limit),
               <span class="dt">param_missing  =</span> <span class="kw">missing_param</span>(param_code)) %&gt;%
<span class="st">        </span><span class="kw">filter</span>(<span class="kw">sum</span>(<span class="kw">c</span>(conc_missing, 
                     date_missing, 
                     site_missing, 
                     dl_missing, 
                     param_missing), <span class="dt">na.rm =</span> T) &lt;<span class="st"> </span><span class="dv">1</span>)</code></pre></div>
</div>
<p><br> <em>Table: The super cleaner data</em><br />
<div id="htmlwidget-1a39db799d73ed45d7f2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1a39db799d73ed45d7f2">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8"],[271231003,271231003,271231003,271231003,271231003,271231003,271231003,271377001],[1,1,1,1,1,1,1,1],[12101,12101,12101,12101,12101,12101,12101,12101],["2004-01-10","2004-01-16","2004-01-22","2004-02-03","2004-02-09","2004-02-21","2004-02-27","2007-09-21"],["0.23","0.35","0.22","0.07","0.02","0.03","0.21","0.14"],[null,null,null,null,null,null,null,null],[0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.04],["Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum"],["7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5"],[false,false,false,false,false,false,false,false],[false,false,false,false,false,false,false,false],[false,false,false,false,false,false,false,false],[false,false,false,false,false,false,false,false],[false,false,false,false,false,false,false,false]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>aqs_id<\/th>\n      <th>poc<\/th>\n      <th>param_code<\/th>\n      <th>date<\/th>\n      <th>conc<\/th>\n      <th>null_code<\/th>\n      <th>md_limit<\/th>\n      <th>pollutant<\/th>\n      <th>cas<\/th>\n      <th>conc_missing<\/th>\n      <th>date_missing<\/th>\n      <th>site_missing<\/th>\n      <th>dl_missing<\/th>\n      <th>param_missing<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"autoWidth":true,"searching":false,"ordering":false,"lengthChange":false,"paginate":false,"info":false,"columnDefs":[{"className":"dt-right","targets":[1,2,3,7]},{"orderable":false,"targets":0}],"order":[],"orderClasses":false}},"evals":[],"jsHooks":[]}</script></p>
<p><br> <strong>Contributors</strong></p>
<blockquote>
<p>Dorian Kvale</p>
</blockquote>
</div>
<div id="quals" class="section level2">
<h2><span class="header-section-number">1.2</span> Remove <code>Qualified</code> data</h2>
<p><strong>Description</strong></p>
<p><br> <strong>Recommended steps</strong></p>
<p><br> <strong>Contributors</strong></p>
<blockquote>
<p>Not me</p>
</blockquote>
</div>
<div id="dups" class="section level2">
<h2><span class="header-section-number">1.3</span> Duplicate obersvations</h2>
<p><strong>Description</strong><br />
Large monitoring data sets often contain a few instances when multiple observations occur over the same time period at the same site. When multiples observations do occur they tend to be identified by a unique monitor POC (parameter occurrence code) or by a qualifier describing why the second observation was recorded (e.g. a duplicate for quality control).</p>
<p><br> <strong>Recommended steps</strong></p>
<ol style="list-style-type: decimal">
<li>Identify duplicate observations.</li>
<li>If both values are detected, calculate the mean of the duplicates.<br />
</li>
<li>If values are identical, use the observation with a lower detection limit.</li>
</ol>
<p><br> <strong>Why not keep them all?</strong> If more data is more better, why not keep both values?</p>
<p>Leaving both observations in the data set is likely to bias calculated summary statistics. For example, consider a scenario where two monitors were operating on a site during the winter months, but only one monitor was operating the rest of the year. If we were to calculate the annual average for this site using all the observations, the mean would be biased by having twice as many observations from the winter months. By limiting the number of observations to 1 per day, the weighting of the seasons will be balanced.</p>
<p><br> <strong>Sample <code>R</code> script</strong></p>
<p><br> Load the sample monitoring data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)

data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="dt">text =</span> <span class="st">&#39;</span>
<span class="st">aqs_id,poc,param_code,date,conc,null_code,md_limit,pollutant,cas</span>
<span class="st">271231003,1,12101,&quot;2004-01-04&quot;,0.05,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-01-10&quot;,0.23,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-01-16&quot;,0.35,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-01-22&quot;,0.22,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-01-28&quot;,0.01,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-02-03&quot;,0.07,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-02-09&quot;,0.02,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-02-15&quot;,0.07,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-02-21&quot;,0.03,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271231003,1,12101,&quot;2004-02-27&quot;,0.21,NA,0.06,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271377001,1,12101,&quot;2007-09-21&quot;,0.14,NA,0.04,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">271377001,1,12101,&quot;2007-09-21&quot;,0.14,NA,0.04,&quot;Aluminum&quot;,&quot;7429-90-5&quot;</span>
<span class="st">&#39;</span>, <span class="dt">stringsAsFactor =</span> F)</code></pre></div>
<p><br> <em>Table: Sample monitoring data</em> <div id="htmlwidget-39f02b56675e97bbdd6a" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-39f02b56675e97bbdd6a">{"x":{"filter":"none","data":[[271231003,271231003,271231003,271231003,271231003,271231003,271231003,271231003,271231003,271231003,271377001,271377001],[1,1,1,1,1,1,1,1,1,1,1,1],[12101,12101,12101,12101,12101,12101,12101,12101,12101,12101,12101,12101],["2004-01-04","2004-01-10","2004-01-16","2004-01-22","2004-01-28","2004-02-03","2004-02-09","2004-02-15","2004-02-21","2004-02-27","2007-09-21","2007-09-21"],[0.05,0.23,0.35,0.22,0.01,0.07,0.02,0.07,0.03,0.21,0.14,0.14],[null,null,null,null,null,null,null,null,null,null,null,null],[0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.04,0.04],["Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum"],["7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>aqs_id<\/th>\n      <th>poc<\/th>\n      <th>param_code<\/th>\n      <th>date<\/th>\n      <th>conc<\/th>\n      <th>null_code<\/th>\n      <th>md_limit<\/th>\n      <th>pollutant<\/th>\n      <th>cas<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"autoWidth":true,"searching":false,"ordering":false,"lengthChange":false,"paginate":false,"info":false,"columnDefs":[{"className":"dt-right","targets":[0,1,2,4,6]}],"order":[],"orderClasses":false}},"evals":[],"jsHooks":[]}</script></p>
<p><br> Add a unique column identifier to each observation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Add unique key to each row</span>
data$key &lt;-<span class="st"> </span><span class="dv">1</span>:<span class="kw">nrow</span>(data)

<span class="co"># Create s unique ID for each site/poc/param code/day combination</span>
data$unique_sample_id &lt;-<span class="st"> </span><span class="kw">paste</span>(data$aqs_id, data$poc, data$param_code, data$date, <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)</code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-18"></span>
<div id="htmlwidget-3d932c5d468ef9b25ac4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-3d932c5d468ef9b25ac4">{"x":{"filter":"none","data":[[1,2,3,4,5,6],["271231003_1_12101_2004-01-04","271231003_1_12101_2004-01-10","271231003_1_12101_2004-01-16","271231003_1_12101_2004-01-22","271231003_1_12101_2004-01-28","271231003_1_12101_2004-02-03"],[271231003,271231003,271231003,271231003,271231003,271231003],[1,1,1,1,1,1],[12101,12101,12101,12101,12101,12101],["2004-01-04","2004-01-10","2004-01-16","2004-01-22","2004-01-28","2004-02-03"],[0.05,0.23,0.35,0.22,0.01,0.07],[null,null,null,null,null,null],[0.06,0.06,0.06,0.06,0.06,0.06],["Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum"],["7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>key<\/th>\n      <th>unique_sample_id<\/th>\n      <th>aqs_id<\/th>\n      <th>poc<\/th>\n      <th>param_code<\/th>\n      <th>date<\/th>\n      <th>conc<\/th>\n      <th>null_code<\/th>\n      <th>md_limit<\/th>\n      <th>pollutant<\/th>\n      <th>cas<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"autoWidth":true,"searching":false,"ordering":false,"lengthChange":false,"paginate":false,"info":false,"columnDefs":[{"className":"dt-right","targets":[0,2,3,4,6,8]}],"order":[],"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p class="caption">
Figure 1.1: Unique ID column added.
</p>
</div>
<p><br> Test for duplicate observations.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Label duplicate samples</span>
data &lt;-<span class="st"> </span><span class="kw">group_by</span>(data, unique_sample_id) %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">duplicate =</span> <span class="kw">n</span>() &gt;<span class="st"> </span><span class="dv">1</span>)

<span class="co"># Create duplicate table</span>
dupes &lt;-<span class="st"> </span><span class="kw">filter</span>(data, duplicate ==<span class="st"> </span>T)</code></pre></div>
<p><br> <em>Table: Duplicate observations</em> <div id="htmlwidget-7ce40a6c4e83d2c313f8" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7ce40a6c4e83d2c313f8">{"x":{"filter":"none","data":[[271377001,271377001],[1,1],[12101,12101],["2007-09-21","2007-09-21"],[0.14,0.14],[null,null],[0.04,0.04],["Aluminum","Aluminum"],["7429-90-5","7429-90-5"],[11,12],["271377001_1_12101_2007-09-21","271377001_1_12101_2007-09-21"],[true,true]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>aqs_id<\/th>\n      <th>poc<\/th>\n      <th>param_code<\/th>\n      <th>date<\/th>\n      <th>conc<\/th>\n      <th>null_code<\/th>\n      <th>md_limit<\/th>\n      <th>pollutant<\/th>\n      <th>cas<\/th>\n      <th>key<\/th>\n      <th>unique_sample_id<\/th>\n      <th>duplicate<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"autoWidth":true,"searching":false,"ordering":false,"lengthChange":false,"paginate":false,"info":false,"columnDefs":[{"className":"dt-right","targets":[0,1,2,4,6,9]}],"order":[],"orderClasses":false}},"evals":[],"jsHooks":[]}</script></p>
<p><br> If duplicates are found, use the following hierarchy to remove duplicates:</p>
<ol style="list-style-type: decimal">
<li>Calculate the mean concentration of all detected observations.</li>
<li>If no observations are detected, select the observation with the lower detection limit.</li>
<li>If no obsercations are detected and the detection limits are all equal, select a single observation.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dupes &lt;-<span class="st"> </span><span class="kw">group_by</span>(dupes, unique_sample_id) %&gt;%<span class="st"> </span>
<span class="st">         </span><span class="kw">arrange</span>(<span class="kw">desc</span>(conc), md_limit) %&gt;%<span class="st"> </span>
<span class="st">         </span><span class="kw">filter</span>(key ==<span class="st"> </span>key[<span class="dv">1</span>])

<span class="co"># Remove Unique IDs with duplicates from data</span>
data &lt;-<span class="st"> </span><span class="kw">filter</span>(data, !duplicate)

<span class="co"># Attach the selected duplicates with highest result and lowest detection limit</span>
data &lt;-<span class="st"> </span><span class="kw">rbind</span>(data, dupes)</code></pre></div>
<br> <em>Table: The new cleaner data</em><br />

<div class="figure"><span id="fig:unnamed-chunk-22"></span>
<div id="htmlwidget-0d2a70e1b4dfc3cbf7e2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-0d2a70e1b4dfc3cbf7e2">{"x":{"filter":"none","data":[[271231003,271231003,271231003,271231003,271231003,271231003,271231003,271231003,271231003,271231003,271377001],[1,1,1,1,1,1,1,1,1,1,1],[12101,12101,12101,12101,12101,12101,12101,12101,12101,12101,12101],["2004-01-04","2004-01-10","2004-01-16","2004-01-22","2004-01-28","2004-02-03","2004-02-09","2004-02-15","2004-02-21","2004-02-27","2007-09-21"],[0.05,0.23,0.35,0.22,0.01,0.07,0.02,0.07,0.03,0.21,0.14],[null,null,null,null,null,null,null,null,null,null,null],[0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.06,0.04],["Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum","Aluminum"],["7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5","7429-90-5"],[1,2,3,4,5,6,7,8,9,10,11],["271231003_1_12101_2004-01-04","271231003_1_12101_2004-01-10","271231003_1_12101_2004-01-16","271231003_1_12101_2004-01-22","271231003_1_12101_2004-01-28","271231003_1_12101_2004-02-03","271231003_1_12101_2004-02-09","271231003_1_12101_2004-02-15","271231003_1_12101_2004-02-21","271231003_1_12101_2004-02-27","271377001_1_12101_2007-09-21"],[false,false,false,false,false,false,false,false,false,false,true]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>aqs_id<\/th>\n      <th>poc<\/th>\n      <th>param_code<\/th>\n      <th>date<\/th>\n      <th>conc<\/th>\n      <th>null_code<\/th>\n      <th>md_limit<\/th>\n      <th>pollutant<\/th>\n      <th>cas<\/th>\n      <th>key<\/th>\n      <th>unique_sample_id<\/th>\n      <th>duplicate<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"autoWidth":true,"searching":false,"ordering":false,"lengthChange":false,"paginate":false,"info":false,"columnDefs":[{"className":"dt-right","targets":[0,1,2,4,6,9]}],"order":[],"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p class="caption">
Figure 1.2: Final data set with 1 duplicate removed.
</p>
</div>
<p><br> <strong>Contributors</strong></p>
<blockquote>
<p>Dorian Kvale</p>
</blockquote>
</div>
<div id="pocs" class="section level2">
<h2><span class="header-section-number">1.4</span> Multiple air monitors (POCs)</h2>
<p><strong>Description</strong></p>
<p><br> <strong>Recommended steps</strong></p>
<p><br> <strong>Contributors</strong></p>
<blockquote>
<p>Not me</p>
</blockquote>
</div>
<div id="outs" class="section level2">
<h2><span class="header-section-number">1.5</span> Outliers</h2>
<p><strong>Description</strong></p>
<p><br> <strong>Recommended steps</strong></p>
<p><br> <strong>Contributors</strong></p>
<blockquote>
<p>Not me</p>
</blockquote>
<p><a href="#start">Jump to top</a></p>
<p>Reference: <a href="https://stackoverflow.com/questions/37755037/how-to-add-code-folding-to-output-chunks-in-rmarkdown-html-documents/37839683#37839683" class="uri">https://stackoverflow.com/questions/37755037/how-to-add-code-folding-to-output-chunks-in-rmarkdown-html-documents/37839683#37839683</a></p>
<script src="jquery-1.9.0.min.js"></script>
<script>
$(document).ready(function() {

  $chunks = $('.fold');

  $chunks.each(function () {

    // add button to source code chunks
    if ( $(this).hasClass('s') ) {
      $('pre.r', this).prepend("<div class=\"showopt\">Show code</div><br style=\"line-height:22px;\"/>");
      $('pre.r', this).children('code').attr('class', 'folded');
    }

    // add button to output chunks
    if ( $(this).hasClass('o') ) {
      $('pre:not(.r)', this).has('code').prepend("<div class=\"showopt\">Show output</div><br style=\"line-height:22px;\"/>");
      $('pre:not(.r)', this).children('code:not(r)').addClass('folded');

      // add button to plots
      $(this).find('img').wrap('<pre class=\"plot\"></pre>');
      $('pre.plot', this).prepend("<div class=\"showopt\">Show plot</div><br style=\"line-height:22px;\"/>");
      $('pre.plot', this).children('img').addClass('folded');

    }
  });

  // hide all chunks when document is loaded
  $('.folded').css('display', 'none')

  // function to toggle the visibility
  $('.showopt').click(function() {
    var label = $(this).html();
    if (label.indexOf("Show") >= 0) {
      $(this).html(label.replace("Show", "Hide"));
    } else {
      $(this).html(label.replace("Hide", "Show"));
    }
    $(this).siblings('code, img').slideToggle('fast', 'swing');
  });
});
</script>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="detection-limits.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/MPCA-air/air-methods/edit/master/01-data_cleaning.Rmd",
"text": "Edit"
},
"download": ["air-methods.pdf"],
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
