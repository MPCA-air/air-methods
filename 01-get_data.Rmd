# Getting data

```{r echo=F}
dt_options <- list(scrollX = T, autoWidth = T, searching = F, ordering = F, lengthChange = F, paginate = F, info = F)
```

This section describes how to access and request air monitoring data. These data include:  

__Air monitoring__

- EPA's AQS DataMart
    - \@ref(rqamd) RQAMD Package 

- EPA's AirNow
    - \@ref(aqi-now)  Current AQI observations  
    - \@ref(monitors) Active AQI monitors 
    
- MPCA sources
    - \@ref(wair) WAIR Database
    - \@ref(lims) LIMS data via Tableau
    - \@ref(AirVision) Airvision - Hourly data
    

__Health and standards__

-	Inhalation health benchmarks
-	NAAQs


__Air modeling__

- NATA
- Downscaler for Ozone and PM2.5
- MNRisks
- CMAQ 

__Air emissions__

- EPA's NEI
- Facility locations

__Meteorology and Climate__

- Observations
- HYSPLIT for wind trajectories
- Forecasts


__Geography and American Community Survey (ACS)__

- Census
- ACS
- Traffic
- Land use


## Retrieving data from AQS DataMart {#rqamd}

The AQS Data Mart provides a convenient API to access air quality data stored in the EPA's AQS database, [AQS Data Mart] (https://aqs.epa.gov/aqsweb/documents/data_mart_welcome.html)

Note: The AQS Data Mart requires a user name and password.The username and password is not the same as your AQS User Account.To request a Data Mart account, follow the instructions on the Data Mart page. 

The RQAMD package allows users to query the AQS Data Mart in R, [RQAMD] (https://github.com/ebailey78/raqdm)

<br> __Sample `R` script__ 

Click the button below to view a step by step example.

<div class="toggle">
<button class = "btn_code">Show __R__ code</button>

```{r, eval=FALSE }

##install raqdm package

library(devtools)
devtools::install_github("ebailey78/raqdm")

require(raqdm)

##set Data Mart username and password.

setAQDMuser("User Name","PW",save=TRUE) #Note save=TRUE creates a file that stores username and password locally, you will not need to run setuser info each time you load raqdm. 

setAQDMdefaults(pc="CRITERIA", state="27", save=TRUE) #Set defaults that are locally stored for queries. This eliminates need to define the data type and state code. 


##Single Paramteer Query

x <- getAQDMdata(state="27",pc="CRITERIA",param="42602",format="AQCSV",bdate="20140101",edate="20141231",synchronous = FALSE) # Queries Data Mart DataBase

aqcsv <- getAQDMrequest(x) # Wait for email confirming file is ready. 


##Multiple Parameter Loops


params <- c("45201", "42602", "44201") #Create a vector with the parameters you are interested in

# Use lapply to loop through the params vector, requesting each one from AQDM. A list of requests will be returned to the x variable
x <- lapply(params, function(p) {
  return(getAQDMdata(param=p))
})

# now loop through the requests to retrieve the data
y <- lapply(x, function(r) {
  return(getAQDMrequest(r))
})

# You could then use do.call and rbind to combine them into one data.frame
d <- do.call(rbind, y)

```
</div>

<br>


## Current AQI observations {#aqi-now}

Air data for the entire United States is at your finger tips. _EPA's AirNow_ maintains a publicly accessible folder of current air monitoring data at https://files.airnowtech.org/.

<br> __Sample `R` script__  
  
Use the following R code to grab the most recent AQI results for the entire country.e.



<div class="toggle">
<button class = "btn_code">Show __R__ code</button>

```{r }
library(dplyr)
library(readr)

# Connect to AirNow data site
#https://files.airnowtech.org/

airnow_link <- paste0("https://s3-us-west-1.amazonaws.com//files.airnowtech.org/airnow/today/",
                      "HourlyData_",
                      format(Sys.time() - 60*75, "%Y%m%d%H", tz = "GMT"),
                      ".dat")
  
aqi_now   <- read_delim(airnow_link, "|", 
                        col_names = F)
                        #col_types = c('cccciccdc'))
 
# Add column names
names(aqi_now) <- c("date", "time", "aqsid", "city", "local_time", "parameter", "units", "concentration", "agency")


# Filter to Ozone and PM2.5 results
aqi_now <- filter(aqi_now, parameter %in% c("OZONE", "PM2.5"))
 
```
</div>

<br> __Contributors__   

> Dorian Kvale


## Active AQI monitors {#monitors}

Current air monitoring locations are published on _AirNow_ to the `monitoring_site_locations.dat` file.

<br> __Sample `R` script__ 

Click the button below to view a step by step example.

<div class="toggle">
<button class = "btn_code">Show __R__ code</button>


```{r }
library(dplyr)
library(readr)

# Connect to AirNow data site
#https://files.airnowtech.org/

airnow_link <- paste0("https://s3-us-west-1.amazonaws.com//files.airnowtech.org/airnow/today/",
                      "monitoring_site_locations.dat")
  
aqi_sites   <- read_delim(airnow_link, "|", col_names = F)
 
# Drop empty columns
aqi_sites <- aqi_sites[ , -c(14:16,22:23)]

# Add column names
names(aqi_sites) <- c("aqsid", 
                      "parameter", 
                      "local_id", 
                      "name", 
                      "status", 
                      "state_region", 
                      "agency", 
                      "epa_region", 
                      "lat", 
                      "long", 
                      "elevation",
                      "local_time",
                      "country",
                      "city",
                      "state_fips",
                      "state",
                      "county_fips",
                      "county")
                    

# Filter to Minnesota sites
aqi_sites  <- filter(aqi_sites, state_fips %in% c(27))
 
```

</div>


<br> __Contributors__    

> Dorian Kvale

<br> __References__    

<br>



## Retrieving data from MPCA WAIR database {#wair}

The WAIR database provides a queryable local copy of select air quality data extracted multiple data sources. This database is managed by Margaret McCourtney. Contact Margaret to request login credentials. 
See [WAIR Data Dictionary] (http://rainier.pca.state.mn.us/documentation/DataDictionary/wair/index.html) for available data tables.

Use the following code to query WAIR using DPLYR

<div class="toggle">
<button class = "btn_code">Show __R__ code</button>

```{r, eval=FALSE }
################################################################################################
## This script loads the library and driver and connects to WAIR.  A dplyr query extracts 
## data from the database into a format specified by Cassie McMahon for calculating           
## OZONE DESIGN VALUES                                                                        
##                                                                                    
## Please disconnect from database before proceeding with analysis of the data in your 
## dataframe.
##
## Cassie's headings
## "State.Code", "County.Code", "Site.ID", "Parameter", "POC", "Sample.Duration", "Unit",
## "Method", "Date", "Start.Time", "Sample.Value", "NullDataCode", "SamplingFrequency",
## "MonitorProtocolID", "Qual1"  
##  Note: WAIR does not contain values for SamplingFrequency and MonitorProtocolID 
##
## Note:  dplyr does not have a command to disconnect to the database.  Connection will
## terminate upon quitting R.  So please do not keep (many) connections open for long periods of
## time
################################################################################################

## Load the library
library(dplyr)


## Open a connection to the database WAIR, schema AQS ##
my_wair <- src_postgres(dbname='wair',host="eiger",user="username",password="password",
options="-c search_path=aqs")


## Reference a table, or two if combining, in the database (e.g. aqs.monitor & aqs.obs_value) ##
## Select columns and filter by row ##

#aqs.monitor table in WAIR ##
my_monitor <- filter(select(tbl(my_wair, "monitor"), id_mon:poc_code), stateid==27 &&
parm_code==44201)

#aqs.obs_value table in WAIR ##
my_obs <- filter(select(tbl(my_wair, "obs_value"), id_mon, dur_code, unitid, method_code,
sampldate, startime, value, nulldata, qual_code), parm_code==44201 && between(sampldate,
"2014-06-01", "2014-06-07"))


## Combine monitor data with observations ##
my_mn_o3 <- inner_join(my_monitor, my_obs, type = "inner", by = c("id_mon")) 


## Arrange combined data in specified order
## Collect data into a dataframe or table ('collect' only works on dataframe, if don't 'collect'
## will only get first 100,000 rows with tbl_df or tbl_dt)

my_mn_o3_df <- collect(my_mn_o3, arrange(my_mn_o3, stateid, cntyid, siteid,
parm_code, poc_code, dur_code, unitid, method_code, sampldate, startime, value, nulldata,
qual_code))

## To store data in a data.table instead of data.frame
# my_mn_o3_dt <- tbl_dt(my_mn_o3_df)  


## To avoid "Variables not shown"
options(dplyr.width = Inf)


## 
head(my_mn_o3_df)


```
</div>

<br>


Use the following code to query WAIR using RPostgrSQL

<div class="toggle">
<button class = "btn_code">Show __R__ code</button>

```{r, eval = FALSE }
################################################################################################
## This script loads the library and driver and connects to WAIR.  A PostgrSQL query extracts 
## data from the database into a format specified by Cassie McMahon for calculating           
## OZONE DESIGN VALUES                                                                        
##                                                                                    
## Please disconnect from database and unload the driver before proceeding with analysis of the data in your dataframe.
##
## Cassie's headings
## "State.Code", "County.Code", "Site.ID", "Parameter", "POC", "Sample.Duration", "Unit",
## "Method", "Date", "Start.Time", "Sample.Value", "NullDataCode", "SamplingFrequency",
## "MonitorProtocolID", "Qual1"  
##  Note: WAIR does not contain values for SamplingFrequency and MonitorProtocolID 
##
################################################################################################

## call the library
library(RPostgreSQL)

## load the PostgreSQL driver
drv <- dbDriver("PostgreSQL")

## Open a connection 
con <- dbConnect(drv, dbname="wair",host='eiger',user='username',password='password')

#***************************** all in 1 step ***************************************************


dframe <- dbGetQuery(con, 
           statement = paste(
       ################ insert SQL here ######################
        "SELECT m.stateid AS state_code,\
        	m.cntyid AS county_code,\
        	m.siteid AS site_id,\
        	m.parm_code AS parameter,\
        	m.poc_code AS poc,\
        	o.dur_code AS sample_duration,\
		o.unitid AS unit,\
        	o.method_code AS method,\
        	o.sampldate AS date,\
        	o.startime AS start_time,\
        	o.value AS sample_value,\
        	o.nulldata AS nulldatacode,\
                NULL AS sampling_frequency,\
		NULL AS monitor_protocol_id,\
        	o.qual_code\
           FROM aqs.monitor m \
           JOIN aqs.obs_value o \
             ON m.id_mon = o.id_mon \ 
          WHERE m.stateid = '27' \
            AND m.parm_code = '44201' \
            AND o.sampldate BETWEEN '2014-06-01' AND '2014-06-07'\
	"
       ########################################################
        		     )); 


#***********************************************************************************************

## Closes the connection
dbDisconnect(con)

## Frees all the resources on the driver
dbUnloadDriver(drv)

```
</div>



<br> [Back to top](#rqamd)

