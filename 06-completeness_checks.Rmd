# Completeness checks (Dorian & Cassie)


Checking for data completeness before generating summaries ensures that results will be comparable from one year to the next. Without completeness checks, changes in the seasonal coverage from year to year may create the illusion of increasing or decreasing trends. 


Completeness checks inlcude tests for:  

`Calendar quarter completeness` Number of samples required for a season or quarter.  

`Annual completeness` Number of samples required for a year.  

`Unique values` Number of unique values required.


## Completeness checks  {#complete}


__Description__  

This section describes completeness guidelines and methods for performing completeness checks.


__<i>Air toxic</i> reporting guidelines based on MPCA and EPA guidelines__


Annual results are considered _incomplete_ if any of the following conditions are not met:

- `Annual completeness` 75% or more of expected samples collected (rounded up)
- `Calendar quarter completeness` 75% or more of expected samples collected (rounded up)
- `Unique values` 2 or more unique values

<br>

__<i>Criteria pollutant</i> reporting guidelines__

Completeness rules for criteria pollutant design values are defined in the [Appendices of 40 CFR 50](https://www.ecfr.gov/cgi-bin/text-idx?tpl=/ecfrbrowse/Title40/40cfr50_main_02.tpl).

In general, these rules apply:

- `Annual completeness` 75% or more of samples collected
- `Calendar quarter completeness` 75% or more of samples collected


<br> __Recommended steps__

1. Based on the monitoring schedule, record the total _expected samples_ for each year and quarter.
    - Air toxics monitors follow a national schedule provided by the EPA - (Air Toxics Monitoring Schedule)[google.com].
1. Count the number of _valid samples_ for each year and quarter.
1. Divide the number of _valid samples_ by the number of _expected samples_.
1. Count the number of unique values for each year.
1. Mark annual results as _incomplete_ if they do not fulfill one of the completeness checks.

<br> __Example `R` script__ 


Click the button below to view a step by step example of the methods above.

<div class="toggle"><button class = "btn_code">Show __R__ code</button>



```{r eval=T, message=F, warning=F, echo=F}
library(knitr)
library(DT)
library(readr)

data <- read_csv('https://raw.githubusercontent.com/MPCA-air/air-methods/master/airtoxics_data_2009_2013.csv')

#names(data) <- c("aqs_id", "poc", "param_code", "date", "conc", "null_code", "md_limit", "pollutant", "year", "cas")

dt_options <- list(scrollX = T, autoWidth = T, searching = F, ordering=F, lengthChange = F, paginate=F, info=F)

```

<br>
Packages
```{r message=F}
library(tidyverse)
```


Our example data is organized by monitoring site and date.
```{r message=F, echo=F, fig.cap = "Sample data table."}

datatable(head(data, 10), options = dt_options)
```

<br>

__Step 1:__ Find the expected number of samples.

The sampling schedule for air toxics is generally 1 sample per every 6 days. Depending on the sampling start date and whether it is a leap year or not, the expected number of samples for the year will range from 60 to 61. It is recommended to consult the lab for the exact number, however, if the monitor submits data to EPA's Sir Quality System, the monitor is required to follow the (Air Toxics Monitoring Schedule)[google.com].

```{r message=F, eval=F}

# Load the air toxics monitoring schedule
schedule <- read_csv()

schedule <- schedule %>% mutate(cal_quarter = quarter(Date))

# Count the number of sampling dates for each quarter and year.
schedule <- schedule %>% 
            group_by(Year, cal_quarter) %>%
            summarize(expected_quarter_samples = length(unique(Date))) %>%
            group_by(Year) %>%
            mutate(expected_annual_samples = sum(expected_quarter_samples))) 
        
```


<br>

__Step 2:__ Count number of valid samples.
```{r message=F}

library(lubridate)

# Assign each date to a calendar quarter
data <- data %>% mutate(cal_quarter = quarter(Date))

# Count the number of sampling dates for each quarter and year.
data <- data %>% 
        group_by(AQSID, POC, Pollutant, CAS, Year, cal_quarter) %>%
        mutate(valid_quarter_samples = length(unique(Date))) %>%
        group_by(AQSID, POC, Pollutant, CAS, Year) %>%
        mutate(valid_annual_samples = length(unique(Date))) 
        
```


<br>

__Step 3:__ Divide the number of valid samples by the number of expected samples.
```{r message=F}


# Join expected sample table to data
#data <- left_join(data, schedule)


# Divide valid samples by expected samples
data <- data %>% 
        group_by(AQSID, POC, Pollutant, CAS, Year, cal_quarter) %>%
        mutate(pct_quarter_samples = valid_quarter_samples / 15) %>%
        group_by(AQSID, POC, Pollutant, CAS, Year) %>%
        mutate(pct_annual_samples = valid_annual_samples / 60) 
        
```

<br>

__Step 4:__ Count the number of unique values for each year.
```{r message=F}

data <- data %>% 
        group_by(AQSID, POC, Pollutant, CAS, Year) %>%
        mutate(unique_values = length(unique(Concentration)))
        
```

<br>

__Step 5:__ Mark results as incomplete if they do not fulfill one of the completeness checks.
```{r message=F}

# Set incomplete to zero if any of completeness checks are not met
data <- data %>% 
        mutate(incomplete = sum(c(pct_quarter_samples < 0.75, 
                                  pct_annual_samples < 0.75,
                                  unique_values < 2)) > 0)
        
```

</div>


<br> __Contributors__  

> Dorian Kvale, Cassie McMahon


<br> __References__    

[Appendices of 40 CFR 50](https://www.ecfr.gov/cgi-bin/text-idx?tpl=/ecfrbrowse/Title40/40cfr50_main_02.tpl)  


